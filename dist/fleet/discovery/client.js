var DiscoveryClient, DiscoveryMethod, DiscoveryResource, Q, request;

Q = require("q");

request = require("request");

DiscoveryResource = require("./resource");

DiscoveryMethod = require("./method");

DiscoveryClient = (function() {
  DiscoveryClient.prototype.kind = "";

  DiscoveryClient.prototype.discoveryVersion = "";

  DiscoveryClient.prototype.id = "";

  DiscoveryClient.prototype.name = "";

  DiscoveryClient.prototype.version = "";

  DiscoveryClient.prototype.title = "";

  DiscoveryClient.prototype.description = "";

  DiscoveryClient.prototype.documentLink = "";

  DiscoveryClient.prototype.protocol = "";

  DiscoveryClient.prototype.baseUrl = "";

  DiscoveryClient.prototype.basePath = "";

  DiscoveryClient.prototype.rootUrl = "";

  DiscoveryClient.prototype.servicePath = "";

  DiscoveryClient.prototype.batchPath = "";

  DiscoveryClient.prototype.endpoint = "";

  DiscoveryClient.prototype.resources = [];

  DiscoveryClient.prototype.complete = false;

  DiscoveryClient.prototype.error = null;

  DiscoveryClient.prototype.discovering = false;

  DiscoveryClient.prototype.resolveOnDiscovery = [];


  /**
  @param {string} endpoint
   */

  function DiscoveryClient(endpoint, basePath) {
    this.endpoint = endpoint;
    if (!endpoint) {
      throw new Error("Endpoint is required");
    }
    this.basePath = basePath;
    if (this.basePath === null) {
      this.basePath = "/v1-alpha/";
    }
  }

  DiscoveryClient.prototype.doDiscovery = function() {
    var client, deferred;
    deferred = Q.defer();
    if (this.complete) {
      deferred.resolve(this);
      return deferred.promise;
    }
    this.resolveOnDiscovery.push(deferred);
    if (this.discovering) {
      return deferred.promise;
    }
    this.discovering = true;
    client = this;
    request.get("" + this.endpoint + this.basePath + "discovery.json", function(error, response, body) {
      var err, i, jsonBody, rejectWithError, _i, _len, _ref;
      rejectWithError = function(rejectError) {
        var i, _i, _len, _ref;
        client.error = rejectError;
        client.complete = true;
        client.discovering = false;
        _ref = client.resolveOnDiscovery;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          i = _ref[_i];
          i.reject(rejectError);
        }
        return client.resolveOnDiscovery = [];
      };
      if (response.statusCode !== 200) {
        error = new Error("Failed to get discovery.json");
      }
      if (error) {
        rejectWithError(error);
        return;
      }
      jsonBody = null;
      try {
        jsonBody = JSON.parse(body);
      } catch (_error) {
        rejectWithError(error);
        return;
      }
      if (!jsonBody) {
        rejectWithError(new Error("discovery.json body empty"));
        return;
      }
      try {
        client.resolveDiscovery(jsonBody);
      } catch (_error) {
        err = _error;
        rejectWithError(err);
        return;
      }
      client.error = null;
      client.complete = true;
      client.discovering = false;
      _ref = client.resolveOnDiscovery;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        i = _ref[_i];
        i.resolve(client);
      }
      return client.resolveOnDiscovery = [];
    });
    return deferred.promise;
  };

  DiscoveryClient.prototype.onDiscovery = function() {
    var deferred;
    deferred = Q.defer();
    if (this.complete) {
      if (this.error) {
        deferred.reject(this.error);
      } else {
        deferred.resolve(this);
      }
    } else if (this.discovering) {
      this.resolveOnDiscovery.push(deferred);
    }
    return deferred.promise;
  };

  DiscoveryClient.prototype.resolveDiscovery = function(discovery) {
    var method, methodName, methods, resource, resourceName, resources;
    if (!(discovery instanceof Object)) {
      throw new Error("Discovery not instanceof an object");
    }
    resources = {};
    if (discovery.resources instanceof Object) {
      for (resourceName in discovery.resources) {
        if (!discovery.resources.hasOwnProperty(resourceName)) {
          continue;
        }
        resource = discovery.resources[resourceName];
        if (!(resource.methods instanceof Object)) {
          continue;
        }
        methods = {};
        for (methodName in resource.methods) {
          if (!resource.methods.hasOwnProperty(methodName)) {
            continue;
          }
          method = resource.methods[methodName];
          if (!(method instanceof Object)) {
            continue;
          }
          methods[methodName] = new DiscoveryMethod(method.id, method.description, method.httpMethod, method.path, method.parameters, method.parameterOrder, method.request, method.response);
        }
        resources[resourceName] = new DiscoveryResource(resourceName, methods);
      }
    }
    this.resources = resources;
    return resources;
  };

  return DiscoveryClient;

})();

module.exports = {

  /**
  @param {string} endpoint
   */
  getClient: function(endpoint) {
    return new DiscoveryClient(endpoint);
  }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsZWV0L2Rpc2NvdmVyeS9jbGllbnQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsK0RBQUE7O0FBQUEsQ0FBQSxHQUFvQixPQUFBLENBQVEsR0FBUixDQUFwQixDQUFBOztBQUFBLE9BQ0EsR0FBb0IsT0FBQSxDQUFRLFNBQVIsQ0FEcEIsQ0FBQTs7QUFBQSxpQkFFQSxHQUFvQixPQUFBLENBQVEsWUFBUixDQUZwQixDQUFBOztBQUFBLGVBR0EsR0FBb0IsT0FBQSxDQUFRLFVBQVIsQ0FIcEIsQ0FBQTs7QUFBQTtBQU9FLDRCQUFBLElBQUEsR0FBTSxFQUFOLENBQUE7O0FBQUEsNEJBQ0EsZ0JBQUEsR0FBa0IsRUFEbEIsQ0FBQTs7QUFBQSw0QkFFQSxFQUFBLEdBQUksRUFGSixDQUFBOztBQUFBLDRCQUdBLElBQUEsR0FBTSxFQUhOLENBQUE7O0FBQUEsNEJBSUEsT0FBQSxHQUFTLEVBSlQsQ0FBQTs7QUFBQSw0QkFLQSxLQUFBLEdBQU8sRUFMUCxDQUFBOztBQUFBLDRCQU1BLFdBQUEsR0FBYSxFQU5iLENBQUE7O0FBQUEsNEJBT0EsWUFBQSxHQUFjLEVBUGQsQ0FBQTs7QUFBQSw0QkFRQSxRQUFBLEdBQVUsRUFSVixDQUFBOztBQUFBLDRCQVNBLE9BQUEsR0FBUyxFQVRULENBQUE7O0FBQUEsNEJBVUEsUUFBQSxHQUFVLEVBVlYsQ0FBQTs7QUFBQSw0QkFXQSxPQUFBLEdBQVMsRUFYVCxDQUFBOztBQUFBLDRCQVlBLFdBQUEsR0FBYSxFQVpiLENBQUE7O0FBQUEsNEJBYUEsU0FBQSxHQUFXLEVBYlgsQ0FBQTs7QUFBQSw0QkFjQSxRQUFBLEdBQVUsRUFkVixDQUFBOztBQUFBLDRCQWVBLFNBQUEsR0FBVyxFQWZYLENBQUE7O0FBQUEsNEJBaUJBLFFBQUEsR0FBVSxLQWpCVixDQUFBOztBQUFBLDRCQWtCQSxLQUFBLEdBQU8sSUFsQlAsQ0FBQTs7QUFBQSw0QkFtQkEsV0FBQSxHQUFhLEtBbkJiLENBQUE7O0FBQUEsNEJB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QUEsQ0F6RmxCLENBQUE7O3lCQUFBOztJQVBGLENBQUE7O0FBQUEsTUFpSU0sQ0FBQyxPQUFQLEdBQ0U7QUFBQTtBQUFBOztLQUFBO0FBQUEsRUFHQSxTQUFBLEVBQVcsU0FBQyxRQUFELEdBQUE7V0FDTCxJQUFBLGVBQUEsQ0FBZ0IsUUFBaEIsRUFESztFQUFBLENBSFg7Q0FsSUYsQ0FBQSIsImZpbGUiOiJmbGVldC9kaXNjb3ZlcnkvY2xpZW50LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiUSAgICAgICAgICAgICAgICAgPSByZXF1aXJlKFwicVwiKVxucmVxdWVzdCAgICAgICAgICAgPSByZXF1aXJlKFwicmVxdWVzdFwiKVxuRGlzY292ZXJ5UmVzb3VyY2UgPSByZXF1aXJlKFwiLi9yZXNvdXJjZVwiKVxuRGlzY292ZXJ5TWV0aG9kICAgPSByZXF1aXJlKFwiLi9tZXRob2RcIilcblxuY2xhc3MgRGlzY292ZXJ5Q2xpZW50XG4gICMgU1RBUlQgVmFsdWVzIGZyb20gZGlzY292ZXJ5Lmpzb25cbiAga2luZDogXCJcIlxuICBkaXNjb3ZlcnlWZXJzaW9uOiBcIlwiXG4gIGlkOiBcIlwiXG4gIG5hbWU6IFwiXCJcbiAgdmVyc2lvbjogXCJcIlxuICB0aXRsZTogXCJcIlxuICBkZXNjcmlwdGlvbjogXCJcIlxuICBkb2N1bWVudExpbms6IFwiXCJcbiAgcHJvdG9jb2w6IFwiXCJcbiAgYmFzZVVybDogXCJcIlxuICBiYXNlUGF0aDogXCJcIlxuICByb290VXJsOiBcIlwiXG4gIHNlcnZpY2VQYXRoOiBcIlwiXG4gIGJhdGNoUGF0aDogXCJcIlxuICBlbmRwb2ludDogXCJcIlxuICByZXNvdXJjZXM6IFtdXG4gICMgRU5EIFZhbHVlcyBmcm9tIGRpc2NvdmVyLmpzb25cbiAgY29tcGxldGU6IGZhbHNlXG4gIGVycm9yOiBudWxsXG4gIGRpc2NvdmVyaW5nOiBmYWxzZVxuICByZXNvbHZlT25EaXNjb3Zlcnk6IFtdXG4gICMjIypcbiAgQHBhcmFtIHtzdHJpbmd9IGVuZHBvaW50XG4gICMjI1xuICBjb25zdHJ1Y3RvcjogKGVuZHBvaW50LCBiYXNlUGF0aCkgLT5cbiAgICB0aGlzLmVuZHBvaW50ID0gZW5kcG9pbnRcbiAgICBpZiBub3QgZW5kcG9pbnRcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkVuZHBvaW50IGlzIHJlcXVpcmVkXCIpXG4gICAgdGhpcy5iYXNlUGF0aCA9IGJhc2VQYXRoXG4gICAgaWYgdGhpcy5iYXNlUGF0aCBpcyBudWxsXG4gICAgICB0aGlzLmJhc2VQYXRoID0gXCIvdjEtYWxwaGEvXCJcbiAgZG9EaXNjb3Zlcnk6IC0+XG4gICAgZGVmZXJyZWQgPSBRLmRlZmVyKClcbiAgICBpZiB0aGlzLmNvbXBsZXRlXG4gICAgICBkZWZlcnJlZC5yZXNvbHZlKHRoaXMpXG4gICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZVxuICAgIHRoaXMucmVzb2x2ZU9uRGlzY292ZXJ5LnB1c2goZGVmZXJyZWQpXG4gICAgaWYgdGhpcy5kaXNjb3ZlcmluZ1xuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2VcbiAgICB0aGlzLmRpc2NvdmVyaW5nID0gdHJ1ZVxuICAgIGNsaWVudCA9IHRoaXNcbiAgICByZXF1ZXN0LmdldChcbiAgICAgIFwiI3t0aGlzLmVuZHBvaW50fSN7dGhpcy5iYXNlUGF0aH1kaXNjb3ZlcnkuanNvblwiLFxuICAgICAgKGVycm9yLCByZXNwb25zZSwgYm9keSkgLT5cbiAgICAgICAgcmVqZWN0V2l0aEVycm9yID0gKHJlamVjdEVycm9yKSAtPlxuICAgICAgICAgIGNsaWVudC5lcnJvciA9IHJlamVjdEVycm9yXG4gICAgICAgICAgY2xpZW50LmNvbXBsZXRlID0gdHJ1ZVxuICAgICAgICAgIGNsaWVudC5kaXNjb3ZlcmluZyA9IGZhbHNlXG4gICAgICAgICAgZm9yIGkgaW4gY2xpZW50LnJlc29sdmVPbkRpc2NvdmVyeVxuICAgICAgICAgICAgaS5yZWplY3QocmVqZWN0RXJyb3IpXG4gICAgICAgICAgY2xpZW50LnJlc29sdmVPbkRpc2NvdmVyeSA9IFtdXG5cbiAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzQ29kZSBpc250IDIwMFxuICAgICAgICAgIGVycm9yID0gbmV3IEVycm9yKFwiRmFpbGVkIHRvIGdldCBkaXNjb3ZlcnkuanNvblwiKVxuICAgICAgICBpZiBlcnJvclxuICAgICAgICAgIHJlamVjdFdpdGhFcnJvcihlcnJvcilcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAganNvbkJvZHkgPSBudWxsXG4gICAgICAgIHRyeVxuICAgICAgICAgIGpzb25Cb2R5ID0gSlNPTi5wYXJzZShib2R5KVxuICAgICAgICBjYXRjaFxuICAgICAgICAgIHJlamVjdFdpdGhFcnJvcihlcnJvcilcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgaWYgbm90IGpzb25Cb2R5XG4gICAgICAgICAgcmVqZWN0V2l0aEVycm9yKG5ldyBFcnJvcihcImRpc2NvdmVyeS5qc29uIGJvZHkgZW1wdHlcIikpXG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIHRyeVxuICAgICAgICAgIGNsaWVudC5yZXNvbHZlRGlzY292ZXJ5KGpzb25Cb2R5KVxuICAgICAgICBjYXRjaCBlcnJcbiAgICAgICAgICByZWplY3RXaXRoRXJyb3IoZXJyKVxuICAgICAgICAgIHJldHVyblxuICAgICAgICBjbGllbnQuZXJyb3IgPSBudWxsXG4gICAgICAgIGNsaWVudC5jb21wbGV0ZSA9IHRydWVcbiAgICAgICAgY2xpZW50LmRpc2NvdmVyaW5nID0gZmFsc2VcbiAgICAgICAgZm9yIGkgaW4gY2xpZW50LnJlc29sdmVPbkRpc2NvdmVyeVxuICAgICAgICAgIGkucmVzb2x2ZShjbGllbnQpXG4gICAgICAgIGNsaWVudC5yZXNvbHZlT25EaXNjb3ZlcnkgPSBbXVxuICAgIClcbiAgICBkZWZlcnJlZC5wcm9taXNlO1xuICBvbkRpc2NvdmVyeTogLT5cbiAgICBkZWZlcnJlZCA9IFEuZGVmZXIoKVxuICAgIGlmIHRoaXMuY29tcGxldGVcbiAgICAgIGlmIHRoaXMuZXJyb3JcbiAgICAgICAgZGVmZXJyZWQucmVqZWN0KHRoaXMuZXJyb3IpXG4gICAgICBlbHNlXG4gICAgICAgIGRlZmVycmVkLnJlc29sdmUodGhpcylcbiAgICBlbHNlIGlmIHRoaXMuZGlzY292ZXJpbmdcbiAgICAgIHRoaXMucmVzb2x2ZU9uRGlzY292ZXJ5LnB1c2goZGVmZXJyZWQpXG4gICAgZGVmZXJyZWQucHJvbWlzZVxuICByZXNvbHZlRGlzY292ZXJ5OiAoZGlzY292ZXJ5KSAtPlxuICAgIGlmIGRpc2NvdmVyeSBub3QgaW5zdGFuY2VvZiBPYmplY3RcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkRpc2NvdmVyeSBub3QgaW5zdGFuY2VvZiBhbiBvYmplY3RcIilcbiAgICByZXNvdXJjZXMgPSB7fVxuICAgIGlmIGRpc2NvdmVyeS5yZXNvdXJjZXMgaW5zdGFuY2VvZiBPYmplY3RcbiAgICAgIGZvciByZXNvdXJjZU5hbWUgb2YgZGlzY292ZXJ5LnJlc291cmNlc1xuICAgICAgICBpZiBub3QgZGlzY292ZXJ5LnJlc291cmNlcy5oYXNPd25Qcm9wZXJ0eShyZXNvdXJjZU5hbWUpXG4gICAgICAgICAgY29udGludWVcbiAgICAgICAgcmVzb3VyY2UgPSBkaXNjb3ZlcnkucmVzb3VyY2VzW3Jlc291cmNlTmFtZV1cbiAgICAgICAgaWYgcmVzb3VyY2UubWV0aG9kcyBub3QgaW5zdGFuY2VvZiBPYmplY3RcbiAgICAgICAgICBjb250aW51ZVxuICAgICAgICBtZXRob2RzID0ge31cbiAgICAgICAgZm9yIG1ldGhvZE5hbWUgb2YgcmVzb3VyY2UubWV0aG9kc1xuICAgICAgICAgIGlmIG5vdCByZXNvdXJjZS5tZXRob2RzLmhhc093blByb3BlcnR5KG1ldGhvZE5hbWUpXG4gICAgICAgICAgICBjb250aW51ZVxuICAgICAgICAgIG1ldGhvZCA9IHJlc291cmNlLm1ldGhvZHNbbWV0aG9kTmFtZV1cbiAgICAgICAgICBpZiBtZXRob2Qgbm90IGluc3RhbmNlb2YgT2JqZWN0XG4gICAgICAgICAgICBjb250aW51ZVxuICAgICAgICAgIG1ldGhvZHNbbWV0aG9kTmFtZV0gPSBuZXcgRGlzY292ZXJ5TWV0aG9kKFxuICAgICAgICAgICAgbWV0aG9kLmlkLFxuICAgICAgICAgICAgbWV0aG9kLmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgbWV0aG9kLmh0dHBNZXRob2QsXG4gICAgICAgICAgICBtZXRob2QucGF0aCxcbiAgICAgICAgICAgIG1ldGhvZC5wYXJhbWV0ZXJzLFxuICAgICAgICAgICAgbWV0aG9kLnBhcmFtZXRlck9yZGVyLFxuICAgICAgICAgICAgbWV0aG9kLnJlcXVlc3QsXG4gICAgICAgICAgICBtZXRob2QucmVzcG9uc2VcbiAgICAgICAgICApXG4gICAgICAgIHJlc291cmNlc1tyZXNvdXJjZU5hbWVdID0gbmV3IERpc2NvdmVyeVJlc291cmNlKHJlc291cmNlTmFtZSwgbWV0aG9kcylcbiAgICB0aGlzLnJlc291cmNlcyA9IHJlc291cmNlc1xuICAgIHJlc291cmNlc1xuXG5cbm1vZHVsZS5leHBvcnRzID1cbiAgIyMjKlxuICBAcGFyYW0ge3N0cmluZ30gZW5kcG9pbnRcbiAgIyMjXG4gIGdldENsaWVudDogKGVuZHBvaW50KSAtPlxuICAgIG5ldyBEaXNjb3ZlcnlDbGllbnQoZW5kcG9pbnQpXG4iXX0=