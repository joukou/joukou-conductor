var DiscoveryClient, DiscoveryMethod, DiscoveryResource, Q, request, _;

Q = require("q");

request = require("request");

DiscoveryResource = require("./resource");

DiscoveryMethod = require("./method");

_ = require("lodash");

DiscoveryClient = (function() {
  DiscoveryClient.prototype.kind = "";

  DiscoveryClient.prototype.discoveryVersion = "";

  DiscoveryClient.prototype.id = "";

  DiscoveryClient.prototype.name = "";

  DiscoveryClient.prototype.version = "";

  DiscoveryClient.prototype.title = "";

  DiscoveryClient.prototype.description = "";

  DiscoveryClient.prototype.documentLink = "";

  DiscoveryClient.prototype.protocol = "";

  DiscoveryClient.prototype.baseUrl = "";

  DiscoveryClient.prototype.basePath = "";

  DiscoveryClient.prototype.rootUrl = "";

  DiscoveryClient.prototype.servicePath = "";

  DiscoveryClient.prototype.batchPath = "";

  DiscoveryClient.prototype.endpoint = "";

  DiscoveryClient.prototype.resources = {};

  DiscoveryClient.prototype._complete = false;

  DiscoveryClient.prototype._error = null;

  DiscoveryClient.prototype._discovering = false;

  DiscoveryClient.prototype._resolveOnDiscovery = [];

  DiscoveryClient.prototype._request = request;


  /**
  @param {string} endpoint
  @param {string} [basePath='/v1-alpha/']
  @param {boolean} [doDiscovery=false]
   */

  function DiscoveryClient(endpoint, basePath, doDiscovery) {
    this.endpoint = endpoint;
    if (!endpoint) {
      throw new Error("Endpoint is required");
    }
    this.basePath = basePath;
    if (this.basePath === null || this.basePath === void 0) {
      this.basePath = "/v1-alpha/";
    }
    if (doDiscovery) {
      this.doDiscovery();
    }
  }

  DiscoveryClient.prototype.doDiscovery = function() {
    var deferred;
    deferred = Q.defer();
    if (this._complete) {
      if (this._error) {
        deferred.reject(this._error);
      } else {
        deferred.resolve(this);
      }
      return deferred.promise;
    }
    this._resolveOnDiscovery.push(deferred);
    if (this._discovering) {
      return deferred.promise;
    }
    this._discovering = true;
    this._doDiscoveryRequest();
    return deferred.promise;
  };

  DiscoveryClient.prototype._doDiscoveryRequest = function() {
    var client;
    client = this;
    return this._request.get("" + this.endpoint + this.basePath + "discovery.json", function(error, response, body) {
      return client._onDiscoveryResult(error, response, body);
    });
  };

  DiscoveryClient.prototype._rejectWithError = function(error) {
    var i, _i, _len, _ref;
    this._error = error;
    this._complete = true;
    this._discovering = false;
    _ref = this._resolveOnDiscovery;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      i = _ref[_i];
      i.reject(error);
    }
    return this._resolveOnDiscovery = [];
  };

  DiscoveryClient.prototype._resolve = function() {
    var i, _i, _len, _ref;
    this._error = null;
    this._complete = true;
    this._discovering = false;
    _ref = this._resolveOnDiscovery;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      i = _ref[_i];
      i.resolve(this);
    }
    return this._resolveOnDiscovery = [];
  };

  DiscoveryClient.prototype._onDiscoveryResult = function(error, response, body) {
    var err, jsonBody;
    if (!error && response.statusCode !== 200) {
      error = new Error("Failed to get discovery.json");
    }
    if (!error && !body) {
      error = new Error("Discovery body is empty");
    }
    if (error) {
      this._rejectWithError(error);
      return;
    }
    jsonBody = null;
    try {
      jsonBody = JSON.parse(body);
    } catch (_error) {
      err = _error;
      this._rejectWithError(err);
      return;
    }
    if (!_.isPlainObject(jsonBody)) {
      this._rejectWithError(new Error("discovery.json body not an object"));
      return;
    }
    try {
      this.resources = this._resolveDiscovery(jsonBody);
    } catch (_error) {
      err = _error;
      this._rejectWithError(err);
      return;
    }
    return this._resolve();
  };

  DiscoveryClient.prototype.onDiscovery = function() {
    var deferred;
    deferred = Q.defer();
    if (this._complete) {
      if (this._error) {
        deferred.reject(this._error);
      } else {
        deferred.resolve(this);
      }
    } else if (this._discovering) {
      this._resolveOnDiscovery.push(deferred);
    }
    return deferred.promise;
  };

  DiscoveryClient.prototype._resolveDiscovery = function(discovery) {
    if (!discovery || !_.isPlainObject(discovery)) {
      throw new Error("Discovery not instanceof an object");
    }
    return this._resolveResources(discovery.resources);
  };

  DiscoveryClient.prototype._resolveResources = function(resources) {
    var resource, resourceName, resultResources;
    if (!_.isPlainObject(resources)) {
      throw new Error("Resources not an object");
    }
    resultResources = {};
    for (resourceName in resources) {
      if (!resources.hasOwnProperty(resourceName)) {
        continue;
      }
      resource = this._resolveResource(resourceName, resources[resourceName]);
      if (resource) {
        resultResources[resourceName] = resource;
      }
    }
    return resultResources;
  };

  DiscoveryClient.prototype._resolveResource = function(resourceName, resource) {
    var method, methodName, methods;
    if (!_.isPlainObject(resource) || !_.isPlainObject(resource.methods)) {
      return null;
    }
    methods = {};
    for (methodName in resource.methods) {
      if (!resource.methods.hasOwnProperty(methodName)) {
        continue;
      }
      method = this._resolveMethod(methodName, resource.methods[methodName]);
      if (method) {
        methods[methodName] = method;
      }
    }
    return new DiscoveryResource(resourceName, methods);
  };

  DiscoveryClient.prototype._resolveMethod = function(methodName, method) {
    if (!_.isPlainObject(method)) {
      return null;
    }
    return new DiscoveryMethod(method.id, method.description, method.httpMethod, method.path, method.parameters, method.parameterOrder, method.request, method.response);
  };

  return DiscoveryClient;

})();

module.exports = {

  /**
  @param {string} endpoint
  @param {string} [basePath='/v1-alpha/']
  @param {boolean} [doDiscovery=false]
   */
  getClient: function(endpoint, basePath, doDiscovery) {
    return new DiscoveryClient(endpoint, basePath, doDiscovery);
  }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsZWV0L2Rpc2NvdmVyeS9jbGllbnQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsa0VBQUE7O0FBQUEsQ0FBQSxHQUFvQixPQUFBLENBQVEsR0FBUixDQUFwQixDQUFBOztBQUFBLE9BQ0EsR0FBb0IsT0FBQSxDQUFRLFNBQVIsQ0FEcEIsQ0FBQTs7QUFBQSxpQkFFQSxHQUFvQixPQUFBLENBQVEsWUFBUixDQUZwQixDQUFBOztBQUFBLGVBR0EsR0FBb0IsT0FBQSxDQUFRLFVBQVIsQ0FIcEIsQ0FBQTs7QUFBQSxDQUlBLEdBQW9CLE9BQUEsQ0FBUSxRQUFSLENBSnBCLENBQUE7O0FBQUE7QUFRRSw0QkFBQSxJQUFBLEdBQU0sRUFBTixDQUFBOztBQUFBLDRCQUNBLGdCQUFBLEdBQWtCLEVBRGxCLENBQUE7O0FBQUEsNEJBRUEsRUFBQSxHQUFJLEVBRkosQ0FBQTs7QUFBQSw0QkFHQSxJQUFBLEdBQU0sRUFITixDQUFBOztBQUFBLDRCQUlBLE9BQUEsR0FBUyxFQUpULENBQUE7O0FBQUEsNEJBS0EsS0FBQSxHQUFPLEVBTFAsQ0FBQTs7QUFBQSw0QkFNQSxXQUFBLEdBQWEsRUFOYixDQUFBOztBQUFBLDRCQU9BLFlBQUEsR0FBYyxFQVBkLENBQUE7O0FBQUEsNEJBUUEsUUFBQSxHQUFVLEVBUlYsQ0FBQTs7QUFBQSw0QkFTQSxPQUFBLEdBQVMsRUFUVCxDQUFBOztBQUFBLDRCQVVBLFFBQUEsR0FBVSxFQVZWLENBQUE7O0FBQUEsNEJBV0EsT0FBQSxHQUFTLEVBWFQsQ0FBQTs7QUFBQSw0QkFZQSxXQUFBLEdBQWEsRUFaYixDQUFBOztBQUFBLDRCQWFBLFNBQUEsR0FBVyxFQWJYLENBQUE7O0FBQUEsNEJBY0EsUUFBQSxHQUFVLEVBZFYsQ0FBQTs7QUFBQSw0QkFlQSxTQUFBLEdBQVcsRUFmWCxDQUFBOztBQUFBLDRCQWtCQSxTQUFBLEdBQVcsS0FsQlgsQ0FBQTs7QUFBQSw0QkFtQkEsTUFBQSxHQUFRLElBbkJSLENBQUE7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QSxPQUFRLENBQUEsVUFBQSxDQUFSLEdBQXNCLE1BQXRCLENBREY7T0FKRjtBQUFBLEtBSEE7V0FTSSxJQUFBLGlCQUFBLENBQWtCLFlBQWxCLEVBQWdDLE9BQWhDLEVBVlk7RUFBQSxDQXpIbEIsQ0FBQTs7QUFBQSw0QkFvSUEsY0FBQSxHQUFnQixTQUFDLFVBQUQsRUFBYSxNQUFiLEdBQUE7QUFDZCxJQUFBLElBQUcsQ0FBQSxDQUFLLENBQUMsYUFBRixDQUFnQixNQUFoQixDQUFQO0FBQ0UsYUFBTyxJQUFQLENBREY7S0FBQTtXQUVJLElBQUEsZUFBQSxDQUNGLE1BQU0sQ0FBQyxFQURMLEVBRUYsTUFBTSxDQUFDLFdBRkwsRUFHRixNQUFNLENBQUMsVUFITCxFQUlGLE1BQU0sQ0FBQyxJQUpMLEVBS0YsTUFBTSxDQUFDLFVBTEwsRUFNRixNQUFNLENBQUMsY0FOTCxFQU9GLE1BQU0sQ0FBQyxPQVBMLEVBUUYsTUFBTSxDQUFDLFFBUkwsRUFIVTtFQUFBLENBcEloQixDQUFBOzt5QkFBQTs7SUFSRixDQUFBOztBQUFBLE1BMEpNLENBQUMsT0FBUCxHQUNFO0FBQUE7QUFBQTs7OztLQUFBO0FBQUEsRUFLQSxTQUFBLEVBQVcsU0FBQyxRQUFELEVBQVcsUUFBWCxFQUFxQixXQUFyQixHQUFBO1dBQ0wsSUFBQSxlQUFBLENBQWdCLFFBQWhCLEVBQTBCLFFBQTFCLEVBQW9DLFdBQXBDLEVBREs7RUFBQSxDQUxYO0NBM0pGLENBQUEiLCJmaWxlIjoiZmxlZXQvZGlzY292ZXJ5L2NsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbIlEgICAgICAgICAgICAgICAgID0gcmVxdWlyZShcInFcIilcbnJlcXVlc3QgICAgICAgICAgID0gcmVxdWlyZShcInJlcXVlc3RcIilcbkRpc2NvdmVyeVJlc291cmNlID0gcmVxdWlyZShcIi4vcmVzb3VyY2VcIilcbkRpc2NvdmVyeU1ldGhvZCAgID0gcmVxdWlyZShcIi4vbWV0aG9kXCIpXG5fICAgICAgICAgICAgICAgICA9IHJlcXVpcmUoXCJsb2Rhc2hcIilcblxuY2xhc3MgRGlzY292ZXJ5Q2xpZW50XG4gICMgU1RBUlQgVmFsdWVzIGZyb20gZGlzY292ZXJ5Lmpzb25cbiAga2luZDogXCJcIlxuICBkaXNjb3ZlcnlWZXJzaW9uOiBcIlwiXG4gIGlkOiBcIlwiXG4gIG5hbWU6IFwiXCJcbiAgdmVyc2lvbjogXCJcIlxuICB0aXRsZTogXCJcIlxuICBkZXNjcmlwdGlvbjogXCJcIlxuICBkb2N1bWVudExpbms6IFwiXCJcbiAgcHJvdG9jb2w6IFwiXCJcbiAgYmFzZVVybDogXCJcIlxuICBiYXNlUGF0aDogXCJcIlxuICByb290VXJsOiBcIlwiXG4gIHNlcnZpY2VQYXRoOiBcIlwiXG4gIGJhdGNoUGF0aDogXCJcIlxuICBlbmRwb2ludDogXCJcIlxuICByZXNvdXJjZXM6IHt9XG4gICMgRU5EIFZhbHVlcyBmcm9tIGRpc2NvdmVyLmpzb25cbiAgIyBTVEFSVCBcIlByaXZhdGVcIiB2YXJpYWJsZXNcbiAgX2NvbXBsZXRlOiBmYWxzZVxuICBfZXJyb3I6IG51bGxcbiAgX2Rpc2NvdmVyaW5nOiBmYWxzZVxuICBfcmVzb2x2ZU9uRGlzY292ZXJ5OiBbXVxuICBfcmVxdWVzdDogcmVxdWVzdFxuICAjIEVORCBcIlByaXZhdGVcIiB2YXJpYWJsZXNcbiAgIyMjKlxuICBAcGFyYW0ge3N0cmluZ30gZW5kcG9pbnRcbiAgQHBhcmFtIHtzdHJpbmd9IFtiYXNlUGF0aD0nL3YxLWFscGhhLyddXG4gIEBwYXJhbSB7Ym9vbGVhbn0gW2RvRGlzY292ZXJ5PWZhbHNlXVxuICAjIyNcbiAgY29uc3RydWN0b3I6IChlbmRwb2ludCwgYmFzZVBhdGgsIGRvRGlzY292ZXJ5KSAtPlxuICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludFxuICAgIGlmIG5vdCBlbmRwb2ludFxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRW5kcG9pbnQgaXMgcmVxdWlyZWRcIilcbiAgICB0aGlzLmJhc2VQYXRoID0gYmFzZVBhdGhcbiAgICBpZiB0aGlzLmJhc2VQYXRoIGlzIG51bGwgb3IgdGhpcy5iYXNlUGF0aCBpcyB1bmRlZmluZWRcbiAgICAgIHRoaXMuYmFzZVBhdGggPSBcIi92MS1hbHBoYS9cIlxuICAgIGlmIGRvRGlzY292ZXJ5XG4gICAgICB0aGlzLmRvRGlzY292ZXJ5KClcbiAgZG9EaXNjb3Zlcnk6IC0+XG4gICAgZGVmZXJyZWQgPSBRLmRlZmVyKClcbiAgICBpZiB0aGlzLl9jb21wbGV0ZVxuICAgICAgaWYgdGhpcy5fZXJyb3JcbiAgICAgICAgZGVmZXJyZWQucmVqZWN0KHRoaXMuX2Vycm9yKVxuICAgICAgZWxzZVxuICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHRoaXMpXG4gICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZVxuICAgIHRoaXMuX3Jlc29sdmVPbkRpc2NvdmVyeS5wdXNoKGRlZmVycmVkKVxuICAgIGlmIHRoaXMuX2Rpc2NvdmVyaW5nXG4gICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZVxuICAgIHRoaXMuX2Rpc2NvdmVyaW5nID0gdHJ1ZVxuICAgIHRoaXMuX2RvRGlzY292ZXJ5UmVxdWVzdCgpXG4gICAgZGVmZXJyZWQucHJvbWlzZVxuICBfZG9EaXNjb3ZlcnlSZXF1ZXN0OiAtPlxuICAgIGNsaWVudCA9IHRoaXNcbiAgICB0aGlzLl9yZXF1ZXN0LmdldChcbiAgICAgIFwiI3t0aGlzLmVuZHBvaW50fSN7dGhpcy5iYXNlUGF0aH1kaXNjb3ZlcnkuanNvblwiLFxuICAgIChlcnJvciwgcmVzcG9uc2UsIGJvZHkpIC0+XG4gICAgICBjbGllbnQuX29uRGlzY292ZXJ5UmVzdWx0KGVycm9yLCByZXNwb25zZSwgYm9keSlcbiAgICApXG4gIF9yZWplY3RXaXRoRXJyb3I6IChlcnJvcikgLT5cbiAgICB0aGlzLl9lcnJvciA9IGVycm9yXG4gICAgdGhpcy5fY29tcGxldGUgPSB0cnVlXG4gICAgdGhpcy5fZGlzY292ZXJpbmcgPSBmYWxzZVxuICAgIGZvciBpIGluIHRoaXMuX3Jlc29sdmVPbkRpc2NvdmVyeVxuICAgICAgaS5yZWplY3QoZXJyb3IpXG4gICAgdGhpcy5fcmVzb2x2ZU9uRGlzY292ZXJ5ID0gW11cbiAgX3Jlc29sdmU6IC0+XG4gICAgdGhpcy5fZXJyb3IgPSBudWxsXG4gICAgdGhpcy5fY29tcGxldGUgPSB0cnVlXG4gICAgdGhpcy5fZGlzY292ZXJpbmcgPSBmYWxzZVxuICAgIGZvciBpIGluIHRoaXMuX3Jlc29sdmVPbkRpc2NvdmVyeVxuICAgICAgaS5yZXNvbHZlKHRoaXMpXG4gICAgdGhpcy5fcmVzb2x2ZU9uRGlzY292ZXJ5ID0gW11cbiAgX29uRGlzY292ZXJ5UmVzdWx0OiAoZXJyb3IsIHJlc3BvbnNlLCBib2R5KSAtPlxuICAgIGlmIG5vdCBlcnJvciBhbmQgcmVzcG9uc2Uuc3RhdHVzQ29kZSBpc250IDIwMFxuICAgICAgZXJyb3IgPSBuZXcgRXJyb3IoXCJGYWlsZWQgdG8gZ2V0IGRpc2NvdmVyeS5qc29uXCIpXG4gICAgaWYgbm90IGVycm9yIGFuZCBub3QgYm9keVxuICAgICAgZXJyb3IgPSBuZXcgRXJyb3IoXCJEaXNjb3ZlcnkgYm9keSBpcyBlbXB0eVwiKVxuICAgIGlmIGVycm9yXG4gICAgICB0aGlzLl9yZWplY3RXaXRoRXJyb3IoZXJyb3IpXG4gICAgICByZXR1cm5cbiAgICBqc29uQm9keSA9IG51bGxcbiAgICB0cnlcbiAgICAgIGpzb25Cb2R5ID0gSlNPTi5wYXJzZShib2R5KVxuICAgIGNhdGNoIGVyclxuICAgICAgdGhpcy5fcmVqZWN0V2l0aEVycm9yKGVycilcbiAgICAgIHJldHVyblxuICAgIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QoanNvbkJvZHkpXG4gICAgICB0aGlzLl9yZWplY3RXaXRoRXJyb3IobmV3IEVycm9yKFwiZGlzY292ZXJ5Lmpzb24gYm9keSBub3QgYW4gb2JqZWN0XCIpKVxuICAgICAgcmV0dXJuXG4gICAgdHJ5XG4gICAgICB0aGlzLnJlc291cmNlcyA9IHRoaXMuX3Jlc29sdmVEaXNjb3ZlcnkoanNvbkJvZHkpXG4gICAgY2F0Y2ggZXJyXG4gICAgICB0aGlzLl9yZWplY3RXaXRoRXJyb3IoZXJyKVxuICAgICAgcmV0dXJuXG4gICAgdGhpcy5fcmVzb2x2ZSgpXG4gIG9uRGlzY292ZXJ5OiAtPlxuICAgIGRlZmVycmVkID0gUS5kZWZlcigpXG4gICAgaWYgdGhpcy5fY29tcGxldGVcbiAgICAgIGlmIHRoaXMuX2Vycm9yXG4gICAgICAgIGRlZmVycmVkLnJlamVjdCh0aGlzLl9lcnJvcilcbiAgICAgIGVsc2VcbiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh0aGlzKVxuICAgIGVsc2UgaWYgdGhpcy5fZGlzY292ZXJpbmdcbiAgICAgIHRoaXMuX3Jlc29sdmVPbkRpc2NvdmVyeS5wdXNoKGRlZmVycmVkKVxuICAgIGRlZmVycmVkLnByb21pc2VcbiAgX3Jlc29sdmVEaXNjb3Zlcnk6IChkaXNjb3ZlcnkpIC0+XG4gICAgaWYgbm90IGRpc2NvdmVyeSBvciBub3QgXy5pc1BsYWluT2JqZWN0KGRpc2NvdmVyeSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkRpc2NvdmVyeSBub3QgaW5zdGFuY2VvZiBhbiBvYmplY3RcIilcbiAgICB0aGlzLl9yZXNvbHZlUmVzb3VyY2VzKGRpc2NvdmVyeS5yZXNvdXJjZXMpXG4gIF9yZXNvbHZlUmVzb3VyY2VzOiAocmVzb3VyY2VzKSAtPlxuICAgIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QocmVzb3VyY2VzKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUmVzb3VyY2VzIG5vdCBhbiBvYmplY3RcIilcbiAgICByZXN1bHRSZXNvdXJjZXMgPSB7fVxuICAgIGZvciByZXNvdXJjZU5hbWUgb2YgcmVzb3VyY2VzXG4gICAgICBpZiBub3QgcmVzb3VyY2VzLmhhc093blByb3BlcnR5KHJlc291cmNlTmFtZSlcbiAgICAgICAgY29udGludWVcbiAgICAgIHJlc291cmNlID0gdGhpcy5fcmVzb2x2ZVJlc291cmNlKHJlc291cmNlTmFtZSwgcmVzb3VyY2VzW3Jlc291cmNlTmFtZV0pXG4gICAgICBpZiByZXNvdXJjZVxuICAgICAgICByZXN1bHRSZXNvdXJjZXNbcmVzb3VyY2VOYW1lXSA9IHJlc291cmNlXG4gICAgcmVzdWx0UmVzb3VyY2VzXG4gIF9yZXNvbHZlUmVzb3VyY2U6IChyZXNvdXJjZU5hbWUsIHJlc291cmNlKSAtPlxuICAgIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QocmVzb3VyY2UpIG9yIG5vdCBfLmlzUGxhaW5PYmplY3QocmVzb3VyY2UubWV0aG9kcylcbiAgICAgIHJldHVybiBudWxsXG4gICAgbWV0aG9kcyA9IHt9XG4gICAgZm9yIG1ldGhvZE5hbWUgb2YgcmVzb3VyY2UubWV0aG9kc1xuICAgICAgaWYgbm90IHJlc291cmNlLm1ldGhvZHMuaGFzT3duUHJvcGVydHkobWV0aG9kTmFtZSlcbiAgICAgICAgY29udGludWVcbiAgICAgIG1ldGhvZCA9IHRoaXMuX3Jlc29sdmVNZXRob2QobWV0aG9kTmFtZSwgcmVzb3VyY2UubWV0aG9kc1ttZXRob2ROYW1lXSlcbiAgICAgIGlmIG1ldGhvZFxuICAgICAgICBtZXRob2RzW21ldGhvZE5hbWVdID0gbWV0aG9kXG4gICAgbmV3IERpc2NvdmVyeVJlc291cmNlKHJlc291cmNlTmFtZSwgbWV0aG9kcylcbiAgX3Jlc29sdmVNZXRob2Q6IChtZXRob2ROYW1lLCBtZXRob2QpIC0+XG4gICAgaWYgbm90IF8uaXNQbGFpbk9iamVjdChtZXRob2QpXG4gICAgICByZXR1cm4gbnVsbFxuICAgIG5ldyBEaXNjb3ZlcnlNZXRob2QoXG4gICAgICBtZXRob2QuaWQsXG4gICAgICBtZXRob2QuZGVzY3JpcHRpb24sXG4gICAgICBtZXRob2QuaHR0cE1ldGhvZCxcbiAgICAgIG1ldGhvZC5wYXRoLFxuICAgICAgbWV0aG9kLnBhcmFtZXRlcnMsXG4gICAgICBtZXRob2QucGFyYW1ldGVyT3JkZXIsXG4gICAgICBtZXRob2QucmVxdWVzdCxcbiAgICAgIG1ldGhvZC5yZXNwb25zZVxuICAgIClcblxubW9kdWxlLmV4cG9ydHMgPVxuICAjIyMqXG4gIEBwYXJhbSB7c3RyaW5nfSBlbmRwb2ludFxuICBAcGFyYW0ge3N0cmluZ30gW2Jhc2VQYXRoPScvdjEtYWxwaGEvJ11cbiAgQHBhcmFtIHtib29sZWFufSBbZG9EaXNjb3Zlcnk9ZmFsc2VdXG4gICMjI1xuICBnZXRDbGllbnQ6IChlbmRwb2ludCwgYmFzZVBhdGgsIGRvRGlzY292ZXJ5KSAtPlxuICAgIG5ldyBEaXNjb3ZlcnlDbGllbnQoZW5kcG9pbnQsIGJhc2VQYXRoLCBkb0Rpc2NvdmVyeSlcbiJdfQ==