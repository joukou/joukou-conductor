var DiscoveryMethod, DiscoverySchema, Q, request, _;

_ = require("lodash");

Q = require("q");

request = require("request");

DiscoverySchema = require("./schema");

DiscoveryMethod = (function() {
  DiscoveryMethod.prototype.id = "";

  DiscoveryMethod.prototype.description = "";

  DiscoveryMethod.prototype.httpMethod = "";

  DiscoveryMethod.prototype.path = "";

  DiscoveryMethod.prototype.parameters = {};

  DiscoveryMethod.prototype.parameterOrder = [];

  DiscoveryMethod.prototype.request = {};

  DiscoveryMethod.prototype.response = {};

  DiscoveryMethod.prototype.client = null;

  function DiscoveryMethod(id, description, httpMethod, path, parameters, parameterOrder, req, response, client) {
    this.id = id;
    this.description = description;
    this.httpMethod = httpMethod;
    this.path = path;
    this.parameters = parameters;
    this.parameterOrder = parameterOrder;
    this.request = req;
    this.response = response;
    this.client = client;
    if (!httpMethod || typeof httpMethod !== "string") {
      throw new Error("Http method not provided for " + id);
    } else {
      this.httpMethod = httpMethod.toUpperCase();
    }
    if (!path || typeof path !== "string") {
      throw new Error("Path not provided for " + id);
    }
  }


  /**
  @param {Object} params
  @returns {Promise}
   */

  DiscoveryMethod.prototype.callMethod = function(params) {
    var deferred, err;
    deferred = Q.defer();
    try {
      this._callMethod(params, deferred);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
    }
    return deferred.promise;
  };

  DiscoveryMethod.prototype._callMethod = function(params, deferred) {
    params = params || {};
    if (!_.isPlainObject(params)) {
      throw new TypeError("Params is expected to be an Object");
    }
    params = this._groupValue(params);
    this._checkRequired(params);
    params = _.transform(params, function(result, value, key) {
      return result[key] = value.value;
    });
    return this._doRequest(params, null, deferred);
  };

  DiscoveryMethod.prototype._doRequest = function(params, body, deferred) {
    var method, req;
    req = {
      url: "" + this.client.endpoint + this.client.basePath + this.path,
      json: body,
      qs: params,
      method: this.httpMethod
    };
    method = this;
    return request(req, function(error, response, body) {
      return method._onResponse(error, response, body, deferred);
    });
  };

  DiscoveryMethod.prototype._onResponse = function(err, response, body, deferred) {
    var jsonBody;
    if (!err && (response.statusCode < 200 || response.statusCode >= 300)) {
      err = new Error("Status code returned " + response.statusCode);
    }
    if (err) {
      deferred.reject(err);
      return;
    }
    if (!body && this.httpMethod !== "GET") {
      deferred.resolve();
      return;
    } else if (!body) {
      deferred.reject(new Error("No body"));
      return;
    }
    jsonBody = null;
    try {
      jsonBody = JSON.parse(body);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
      return;
    }
    return deferred.resolve(jsonBody);
  };

  DiscoveryMethod.prototype._groupValue = function(params) {
    return params = _.merge(this.parameters, params, function(a, b) {
      a = _.clone(a);
      if (!b) {
        return a;
      }
      if (a.type === "string" && typeof b !== "string") {
        b = b.toString();
      }
      if (DiscoverySchema.checkType(b, a.type)) {
        a.value = b;
      } else {
        if (typeof b === "string") {
          b = "'" + b + "'";
        }
        throw new TypeError("" + b + " is not typeof " + a.type);
      }
      a.value = b;
      return a;
    });
  };

  DiscoveryMethod.prototype._checkRequired = function(params) {
    var key, val, _results;
    _results = [];
    for (key in params) {
      val = params[key];
      if (!val.required) {
        continue;
      }
      if (!val.value) {
        throw new Error("the parameter " + key + " is required");
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  return DiscoveryMethod;

})();

module.exports = DiscoveryMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsZWV0L2Rpc2NvdmVyeS9tZXRob2QuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsK0NBQUE7O0FBQUEsQ0FBQSxHQUFrQixPQUFBLENBQVEsUUFBUixDQUFsQixDQUFBOztBQUFBLENBQ0EsR0FBa0IsT0FBQSxDQUFRLEdBQVIsQ0FEbEIsQ0FBQTs7QUFBQSxPQUVBLEdBQWtCLE9BQUEsQ0FBUSxTQUFSLENBRmxCLENBQUE7O0FBQUEsZUFHQSxHQUFrQixPQUFBLENBQVEsVUFBUixDQUhsQixDQUFBOztBQUFBO0FBTUUsNEJBQUEsRUFBQSxHQUFJLEVBQUosQ0FBQTs7QUFBQSw0QkFDQSxXQUFBLEdBQWEsRUFEYixDQUFBOztBQUFBLDRCQUVBLFVBQUEsR0FBWSxFQUZaLENBQUE7O0FBQUEsNEJBR0EsSUFBQSxHQUFNLEVBSE4sQ0FBQTs7QUFBQSw0QkFJQSxVQUFBLEdBQVksRUFKWixDQUFBOztBQUFBLDRCQUtBLGNBQUEsR0FBZ0IsRUFMaEIsQ0FBQTs7QUFBQSw0QkFNQSxPQUFBLEdBQVMsRUFOVCxDQUFBOztBQUFBLDRCQU9BLFFBQUEsR0FBVSxFQVBWLENBQUE7O0FBQUEsNEJBUUEsTUFBQSxHQUFRLElBUlIsQ0FBQTs7QUFTYSxFQUFBLHlCQUFDLEVBQUQsRUFDQyxXQURELEVBRUMsVUFGRCxFQUdDLElBSEQsRUFJQyxVQUpELEVBS0MsY0FMRCxFQU1DLEdBTkQsRUFPQyxRQVBELEVBUUMsTUFSRCxHQUFBO0FBU1gsSUFBQSxJQUFJLENBQUMsRUFBTCxHQUFVLEVBQVYsQ0FBQTtBQUFBLElBQ0EsSUFBSSxDQUFDLFdBQUwsR0FBbUIsV0FEbkIsQ0FBQTtBQUFBLElBRUEsSUFBSSxDQUFDLFVBQUwsR0FBa0IsVUFGbEIsQ0FBQTtBQUFBLElBR0EsSUFBSSxDQUFDLElBQUwsR0FBWSxJQUhaLENBQUE7QUFBQSxJQUlBLElBQUksQ0FBQyxVQUFMLEdBQWtCLFVBSmxCLENBQUE7QUFBQSxJQUtBLElBQUksQ0FBQyxjQUFM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LEdBQWdCLEdBQWhCLEdBQW9CLGNBQTNCLENBQVYsQ0FERjtPQUFBLE1BQUE7OEJBQUE7T0FKRjtBQUFBO29CQURjO0VBQUEsQ0F4R2hCLENBQUE7O3lCQUFBOztJQU5GLENBQUE7O0FBQUEsTUF1SE0sQ0FBQyxPQUFQLEdBQWlCLGVBdkhqQixDQUFBIiwiZmlsZSI6ImZsZWV0L2Rpc2NvdmVyeS9tZXRob2QuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJfICAgICAgICAgICAgICAgPSByZXF1aXJlKFwibG9kYXNoXCIpXG5RICAgICAgICAgICAgICAgPSByZXF1aXJlKFwicVwiKVxucmVxdWVzdCAgICAgICAgID0gcmVxdWlyZShcInJlcXVlc3RcIilcbkRpc2NvdmVyeVNjaGVtYSA9IHJlcXVpcmUoXCIuL3NjaGVtYVwiKVxuXG5jbGFzcyBEaXNjb3ZlcnlNZXRob2RcbiAgaWQ6IFwiXCJcbiAgZGVzY3JpcHRpb246IFwiXCJcbiAgaHR0cE1ldGhvZDogXCJcIlxuICBwYXRoOiBcIlwiXG4gIHBhcmFtZXRlcnM6IHt9XG4gIHBhcmFtZXRlck9yZGVyOiBbXVxuICByZXF1ZXN0OiB7fVxuICByZXNwb25zZToge31cbiAgY2xpZW50OiBudWxsXG4gIGNvbnN0cnVjdG9yOiAoaWQsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgICAgICAgICAgaHR0cE1ldGhvZCxcbiAgICAgICAgICAgICAgICBwYXRoLFxuICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMsXG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyT3JkZXIsXG4gICAgICAgICAgICAgICAgcmVxLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlLFxuICAgICAgICAgICAgICAgIGNsaWVudCkgLT5cbiAgICB0aGlzLmlkID0gaWRcbiAgICB0aGlzLmRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb25cbiAgICB0aGlzLmh0dHBNZXRob2QgPSBodHRwTWV0aG9kXG4gICAgdGhpcy5wYXRoID0gcGF0aFxuICAgIHRoaXMucGFyYW1ldGVycyA9IHBhcmFtZXRlcnNcbiAgICB0aGlzLnBhcmFtZXRlck9yZGVyID0gcGFyYW1ldGVyT3JkZXJcbiAgICB0aGlzLnJlcXVlc3QgPSByZXFcbiAgICB0aGlzLnJlc3BvbnNlID0gcmVzcG9uc2VcbiAgICB0aGlzLmNsaWVudCA9IGNsaWVudFxuICAgIGlmIG5vdCBodHRwTWV0aG9kIG9yIHR5cGVvZiBodHRwTWV0aG9kIGlzbnQgXCJzdHJpbmdcIlxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSHR0cCBtZXRob2Qgbm90IHByb3ZpZGVkIGZvciAje2lkfVwiKVxuICAgIGVsc2VcbiAgICAgIHRoaXMuaHR0cE1ldGhvZCA9IGh0dHBNZXRob2QudG9VcHBlckNhc2UoKVxuICAgIGlmIG5vdCBwYXRoIG9yIHR5cGVvZiBwYXRoIGlzbnQgXCJzdHJpbmdcIlxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUGF0aCBub3QgcHJvdmlkZWQgZm9yICN7aWR9XCIpXG4gICMjIypcbiAgQHBhcmFtIHtPYmplY3R9IHBhcmFtc1xuICBAcmV0dXJucyB7UHJvbWlzZX1cbiAgIyMjXG4gIGNhbGxNZXRob2Q6IChwYXJhbXMpIC0+XG4gICAgZGVmZXJyZWQgPSBRLmRlZmVyKClcbiAgICB0cnlcbiAgICAgICMgV3JhcCB0aGUgd2hvbGUgZnVuY3Rpb24gb3IgaXQgaXMganVzdFxuICAgICAgIyBCbG9hdGVkIHdpdGggdHJ5IGNhdGNoZXNcbiAgICAgIHRoaXMuX2NhbGxNZXRob2QocGFyYW1zLCBkZWZlcnJlZClcbiAgICBjYXRjaCBlcnJcbiAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpXG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2VcbiAgX2NhbGxNZXRob2Q6IChwYXJhbXMsIGRlZmVycmVkKSAtPlxuICAgIHBhcmFtcyA9IHBhcmFtcyBvciB7fVxuICAgIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QocGFyYW1zKVxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlBhcmFtcyBpcyBleHBlY3RlZCB0byBiZSBhbiBPYmplY3RcIilcbiAgICBwYXJhbXMgPSB0aGlzLl9ncm91cFZhbHVlKHBhcmFtcylcbiAgICB0aGlzLl9jaGVja1JlcXVpcmVkKHBhcmFtcylcbiAgICAjIHR1cm4gdGhlIHF1ZXJ5IHN0cmluZyBpbnRvIGtleSB2YWx1ZSBwYWlyc1xuICAgIHBhcmFtcyA9IF8udHJhbnNmb3JtKHBhcmFtcywgKHJlc3VsdCwgdmFsdWUsIGtleSkgLT5cbiAgICAgIHJlc3VsdFtrZXldID0gdmFsdWUudmFsdWVcbiAgICApXG4gICAgdGhpcy5fZG9SZXF1ZXN0KHBhcmFtcywgbnVsbCwgZGVmZXJyZWQpXG4gIF9kb1JlcXVlc3Q6IChwYXJhbXMsIGJvZHksIGRlZmVycmVkKSAtPlxuICAgIHJlcSA9XG4gICAgICB1cmw6IFwiI3t0aGlzLmNsaWVudC5lbmRwb2ludH0je3RoaXMuY2xpZW50LmJhc2VQYXRofSN7dGhpcy5wYXRofVwiXG4gICAgICAjIFdpbGwgc2V0IGNvbnRlbnQvdHlwZSB0byBhcHBsaWNhdGlvbi9qc29uXG4gICAgICBqc29uOiBib2R5XG4gICAgICBxczogcGFyYW1zXG4gICAgICBtZXRob2Q6IHRoaXMuaHR0cE1ldGhvZFxuICAgIG1ldGhvZCA9IHRoaXNcbiAgICByZXF1ZXN0KHJlcSwgKGVycm9yLCByZXNwb25zZSwgYm9keSkgLT5cbiAgICAgIG1ldGhvZC5fb25SZXNwb25zZShlcnJvciwgcmVzcG9uc2UsIGJvZHksIGRlZmVycmVkKVxuICAgIClcbiAgX29uUmVzcG9uc2U6IChlcnIsIHJlc3BvbnNlLCBib2R5LCBkZWZlcnJlZCkgLT5cbiAgICBpZiBub3QgZXJyIGFuZCAocmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDIwMCBvciByZXNwb25zZS5zdGF0dXNDb2RlID49IDMwMClcbiAgICAgICMgVE9ETyBJbXBsZW1lbnQgcmVkaXJlY3Rpb24gMzAxLCAzMDJbLCAzMDNdLCAzMDRcbiAgICAgIGVyciA9IG5ldyBFcnJvcihcIlN0YXR1cyBjb2RlIHJldHVybmVkICN7cmVzcG9uc2Uuc3RhdHVzQ29kZX1cIilcbiAgICBpZiBlcnJcbiAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpXG4gICAgICByZXR1cm5cbiAgICBpZiBub3QgYm9keSBhbmQgdGhpcy5odHRwTWV0aG9kIGlzbnQgXCJHRVRcIlxuICAgICAgZGVmZXJyZWQucmVzb2x2ZSgpXG4gICAgICByZXR1cm5cbiAgICBlbHNlIGlmIG5vdCBib2R5XG4gICAgICBkZWZlcnJlZC5yZWplY3QobmV3IEVycm9yKFwiTm8gYm9keVwiKSlcbiAgICAgIHJldHVyblxuICAgIGpzb25Cb2R5ID0gbnVsbFxuICAgIHRyeVxuICAgICAganNvbkJvZHkgPSBKU09OLnBhcnNlKGJvZHkpXG4gICAgY2F0Y2ggZXJyXG4gICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKVxuICAgICAgcmV0dXJuXG4gICAgZGVmZXJyZWQucmVzb2x2ZShqc29uQm9keSlcbiAgX2dyb3VwVmFsdWU6IChwYXJhbXMpIC0+XG4gICAgcGFyYW1zID0gXy5tZXJnZSh0aGlzLnBhcmFtZXRlcnMsIHBhcmFtcywgKGEsIGIpIC0+XG4gICAgICBhID0gXy5jbG9uZShhKVxuICAgICAgaWYgbm90IGJcbiAgICAgICAgcmV0dXJuIGFcbiAgICAgIGlmIGEudHlwZSBpcyBcInN0cmluZ1wiIGFuZCB0eXBlb2YgYiBpc250IFwic3RyaW5nXCJcbiAgICAgICAgYiA9IGIudG9TdHJpbmcoKVxuICAgICAgaWYgRGlzY292ZXJ5U2NoZW1hLmNoZWNrVHlwZShiLCBhLnR5cGUpXG4gICAgICAgIGEudmFsdWUgPSBiXG4gICAgICBlbHNlXG4gICAgICAgIGlmIHR5cGVvZiBiIGlzIFwic3RyaW5nXCJcbiAgICAgICAgICBiID0gXCInI3tifSdcIlxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiI3tifSBpcyBub3QgdHlwZW9mICN7YS50eXBlfVwiKVxuICAgICAgYS52YWx1ZSA9IGJcbiAgICAgIHJldHVybiBhXG4gICAgKVxuICBfY2hlY2tSZXF1aXJlZDogKHBhcmFtcykgLT5cbiAgICBmb3Iga2V5IG9mIHBhcmFtc1xuICAgICAgdmFsID0gcGFyYW1zW2tleV1cbiAgICAgIGlmIG5vdCB2YWwucmVxdWlyZWRcbiAgICAgICAgY29udGludWVcbiAgICAgIGlmIG5vdCB2YWwudmFsdWVcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwidGhlIHBhcmFtZXRlciAje2tleX0gaXMgcmVxdWlyZWRcIilcblxuXG5tb2R1bGUuZXhwb3J0cyA9IERpc2NvdmVyeU1ldGhvZCJdfQ==