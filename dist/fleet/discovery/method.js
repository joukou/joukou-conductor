var DiscoveryMethod, DiscoverySchema, Q, request, _;

_ = require("lodash");

Q = require("q");

request = require("request");

DiscoverySchema = require("./schema");

DiscoveryMethod = (function() {
  DiscoveryMethod.prototype.id = "";

  DiscoveryMethod.prototype.description = "";

  DiscoveryMethod.prototype.httpMethod = "";

  DiscoveryMethod.prototype.path = "";

  DiscoveryMethod.prototype.parameters = {};

  DiscoveryMethod.prototype.parameterOrder = [];

  DiscoveryMethod.prototype.request = {};

  DiscoveryMethod.prototype.response = {};

  DiscoveryMethod.prototype.client = null;

  function DiscoveryMethod(id, description, httpMethod, path, parameters, parameterOrder, req, response, client) {
    this.id = id;
    this.description = description;
    this.httpMethod = httpMethod;
    this.path = path;
    this.parameters = parameters;
    this.parameterOrder = parameterOrder;
    this.request = req;
    this.response = response;
    this.client = client;
    if (!httpMethod || typeof httpMethod !== "string") {
      throw new Error("Http method not provided for " + id);
    } else {
      this.httpMethod = httpMethod.toUpperCase();
    }
    if (!path || typeof path !== "string") {
      throw new Error("Path not provided for " + id);
    }
  }


  /**
  @param {Object} params
  @returns {Promise}
   */

  DiscoveryMethod.prototype.callMethod = function(params) {
    var deferred, err;
    deferred = Q.defer();
    try {
      this._callMethod(params, deferred);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
    }
    return deferred.promise;
  };

  DiscoveryMethod.prototype._callMethod = function(params, deferred) {
    params = params || {};
    if (!_.isPlainObject(params)) {
      throw new TypeError("Params is expected to be an Object");
    }
    params = this._groupValue(params);
    this._checkRequired(params);
    params = _.transform(params, function(result, value, key) {
      return result[key] = value.value;
    });
    return this._doRequest(params, null, deferred);
  };

  DiscoveryMethod.prototype._doRequest = function(params, body, deferred) {
    var method, req;
    req = {
      url: "" + this.client.endpoint + this.client.basePath,
      json: body,
      qs: params,
      method: this.httpMethod
    };
    method = this;
    return request(req, function(err, response, body) {
      return method._onResponse(err, response, body);
    });
  };

  DiscoveryMethod.prototype._onResponse = function(err, response, body, deferred) {
    var jsonBody;
    if (!err && response.statusCode === 200) {
      err = new Error("Status code returned " + response.statusCode);
    }
    if (err) {
      deferred.reject(err);
      return;
    }
    if (!this.response) {
      deferred.resolve(true);
      return;
    }
    if (!body) {
      deferred.resolve();
    }
    jsonBody = null;
    try {
      jsonBody = JSON.parse(body);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
      return;
    }
    return deferred.resolve(jsonBody);
  };

  DiscoveryMethod.prototype._groupValue = function(params) {
    return params = _.merge(this.parameters, params, function(a, b) {
      a = _.clone(a);
      if (!b) {
        return a;
      }
      if (a.type === "string" && typeof b !== "string") {
        b = b.toString();
      }
      if (DiscoverySchema.checkType(b, a.type)) {
        a.value = b;
      } else {
        if (typeof b === "string") {
          b = "'" + b + "'";
        }
        throw new TypeError("" + b + " is not typeof " + a.type);
      }
      a.value = b;
      return a;
    });
  };

  DiscoveryMethod.prototype._checkRequired = function(params) {
    var key, val, _results;
    _results = [];
    for (key in params) {
      val = params[key];
      if (!val.required) {
        continue;
      }
      if (!val.value) {
        throw new Error("the parameter " + key + " is required");
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  return DiscoveryMethod;

})();

module.exports = DiscoveryMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsZWV0L2Rpc2NvdmVyeS9tZXRob2QuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsK0NBQUE7O0FBQUEsQ0FBQSxHQUFrQixPQUFBLENBQVEsUUFBUixDQUFsQixDQUFBOztBQUFBLENBQ0EsR0FBa0IsT0FBQSxDQUFRLEdBQVIsQ0FEbEIsQ0FBQTs7QUFBQSxPQUVBLEdBQWtCLE9BQUEsQ0FBUSxTQUFSLENBRmxCLENBQUE7O0FBQUEsZUFHQSxHQUFrQixPQUFBLENBQVEsVUFBUixDQUhsQixDQUFBOztBQUFBO0FBTUUsNEJBQUEsRUFBQSxHQUFJLEVBQUosQ0FBQTs7QUFBQSw0QkFDQSxXQUFBLEdBQWEsRUFEYixDQUFBOztBQUFBLDRCQUVBLFVBQUEsR0FBWSxFQUZaLENBQUE7O0FBQUEsNEJBR0EsSUFBQSxHQUFNLEVBSE4sQ0FBQTs7QUFBQSw0QkFJQSxVQUFBLEdBQVksRUFKWixDQUFBOztBQUFBLDRCQUtBLGNBQUEsR0FBZ0IsRUFMaEIsQ0FBQTs7QUFBQSw0QkFNQSxPQUFBLEdBQVMsRUFOVCxDQUFBOztBQUFBLDRCQU9BLFFBQUEsR0FBVSxFQVBWLENBQUE7O0FBQUEsNEJBUUEsTUFBQSxHQUFRLElBUlIsQ0FBQTs7QUFTYSxFQUFBLHlCQUFDLEVBQUQsRUFDQyxXQURELEVBRUMsVUFGRCxFQUdDLElBSEQsRUFJQyxVQUpELEVBS0MsY0FMRCxFQU1DLEdBTkQsRUFPQyxRQVBELEVBUUMsTUFSRCxHQUFBO0FBU1gsSUFBQSxJQUFJLENBQUMsRUFBTCxHQUFVLEVBQVYsQ0FBQTtBQUFBLElBQ0EsSUFBSSxDQUFDLFdBQUwsR0FBbUIsV0FEbkIsQ0FBQTtBQUFBLElBRUEsSUFBSSxDQUFDLFVBQUwsR0FBa0IsVUFGbEIsQ0FBQTtBQUFBLElBR0EsSUFBSSxDQUFDLElBQUwsR0FBWSxJQUhaLENBQUE7QUFBQSxJQUlBLElBQUksQ0FBQyxVQUFMLEdBQWtCLFVBSmxCLENBQUE7QUFBQSxJQUtBLElBQUksQ0FBQyxjQUFM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QSIsImZpbGUiOiJmbGVldC9kaXNjb3ZlcnkvbWV0aG9kLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiXyAgICAgICAgICAgICAgID0gcmVxdWlyZShcImxvZGFzaFwiKVxuUSAgICAgICAgICAgICAgID0gcmVxdWlyZShcInFcIilcbnJlcXVlc3QgICAgICAgICA9IHJlcXVpcmUoXCJyZXF1ZXN0XCIpXG5EaXNjb3ZlcnlTY2hlbWEgPSByZXF1aXJlKFwiLi9zY2hlbWFcIilcblxuY2xhc3MgRGlzY292ZXJ5TWV0aG9kXG4gIGlkOiBcIlwiXG4gIGRlc2NyaXB0aW9uOiBcIlwiXG4gIGh0dHBNZXRob2Q6IFwiXCJcbiAgcGF0aDogXCJcIlxuICBwYXJhbWV0ZXJzOiB7fVxuICBwYXJhbWV0ZXJPcmRlcjogW11cbiAgcmVxdWVzdDoge31cbiAgcmVzcG9uc2U6IHt9XG4gIGNsaWVudDogbnVsbFxuICBjb25zdHJ1Y3RvcjogKGlkLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgIGh0dHBNZXRob2QsXG4gICAgICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzLFxuICAgICAgICAgICAgICAgIHBhcmFtZXRlck9yZGVyLFxuICAgICAgICAgICAgICAgIHJlcSxcbiAgICAgICAgICAgICAgICByZXNwb25zZSxcbiAgICAgICAgICAgICAgICBjbGllbnQpIC0+XG4gICAgdGhpcy5pZCA9IGlkXG4gICAgdGhpcy5kZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uXG4gICAgdGhpcy5odHRwTWV0aG9kID0gaHR0cE1ldGhvZFxuICAgIHRoaXMucGF0aCA9IHBhdGhcbiAgICB0aGlzLnBhcmFtZXRlcnMgPSBwYXJhbWV0ZXJzXG4gICAgdGhpcy5wYXJhbWV0ZXJPcmRlciA9IHBhcmFtZXRlck9yZGVyXG4gICAgdGhpcy5yZXF1ZXN0ID0gcmVxXG4gICAgdGhpcy5yZXNwb25zZSA9IHJlc3BvbnNlXG4gICAgdGhpcy5jbGllbnQgPSBjbGllbnRcbiAgICBpZiBub3QgaHR0cE1ldGhvZCBvciB0eXBlb2YgaHR0cE1ldGhvZCBpc250IFwic3RyaW5nXCJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkh0dHAgbWV0aG9kIG5vdCBwcm92aWRlZCBmb3IgI3tpZH1cIilcbiAgICBlbHNlXG4gICAgICB0aGlzLmh0dHBNZXRob2QgPSBodHRwTWV0aG9kLnRvVXBwZXJDYXNlKClcbiAgICBpZiBub3QgcGF0aCBvciB0eXBlb2YgcGF0aCBpc250IFwic3RyaW5nXCJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhdGggbm90IHByb3ZpZGVkIGZvciAje2lkfVwiKVxuICAjIyMqXG4gIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXNcbiAgQHJldHVybnMge1Byb21pc2V9XG4gICMjI1xuICBjYWxsTWV0aG9kOiAocGFyYW1zKSAtPlxuICAgIGRlZmVycmVkID0gUS5kZWZlcigpXG4gICAgdHJ5XG4gICAgICAjIFdyYXAgdGhlIHdob2xlIGZ1bmN0aW9uIG9yIGl0IGlzIGp1c3RcbiAgICAgICMgQmxvYXRlZCB3aXRoIHRyeSBjYXRjaGVzXG4gICAgICB0aGlzLl9jYWxsTWV0aG9kKHBhcmFtcywgZGVmZXJyZWQpXG4gICAgY2F0Y2ggZXJyXG4gICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKVxuICAgIGRlZmVycmVkLnByb21pc2VcbiAgX2NhbGxNZXRob2Q6IChwYXJhbXMsIGRlZmVycmVkKSAtPlxuICAgIHBhcmFtcyA9IHBhcmFtcyBvciB7fVxuICAgIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QocGFyYW1zKVxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlBhcmFtcyBpcyBleHBlY3RlZCB0byBiZSBhbiBPYmplY3RcIilcbiAgICBwYXJhbXMgPSB0aGlzLl9ncm91cFZhbHVlKHBhcmFtcylcbiAgICB0aGlzLl9jaGVja1JlcXVpcmVkKHBhcmFtcylcbiAgICAjIHR1cm4gdGhlIHF1ZXJ5IHN0cmluZyBpbnRvIGtleSB2YWx1ZSBwYWlyc1xuICAgIHBhcmFtcyA9IF8udHJhbnNmb3JtKHBhcmFtcywgKHJlc3VsdCwgdmFsdWUsIGtleSkgLT5cbiAgICAgIHJlc3VsdFtrZXldID0gdmFsdWUudmFsdWVcbiAgICApXG4gICAgdGhpcy5fZG9SZXF1ZXN0KHBhcmFtcywgbnVsbCwgZGVmZXJyZWQpXG4gIF9kb1JlcXVlc3Q6IChwYXJhbXMsIGJvZHksIGRlZmVycmVkKSAtPlxuICAgIHJlcSA9XG4gICAgICB1cmw6IFwiI3t0aGlzLmNsaWVudC5lbmRwb2ludH0je3RoaXMuY2xpZW50LmJhc2VQYXRofVwiXG4gICAgICAjIFdpbGwgc2V0IGNvbnRlbnQvdHlwZSB0byBhcHBsaWNhdGlvbi9qc29uXG4gICAgICBqc29uOiBib2R5XG4gICAgICBxczogcGFyYW1zXG4gICAgICBtZXRob2Q6IHRoaXMuaHR0cE1ldGhvZFxuICAgIG1ldGhvZCA9IHRoaXNcbiAgICByZXF1ZXN0KHJlcSwgKGVyciwgcmVzcG9uc2UsIGJvZHkpIC0+XG4gICAgICBtZXRob2QuX29uUmVzcG9uc2UoZXJyLCByZXNwb25zZSwgYm9keSlcbiAgICApXG4gIF9vblJlc3BvbnNlOiAoZXJyLCByZXNwb25zZSwgYm9keSwgZGVmZXJyZWQpIC0+XG4gICAgaWYgbm90IGVyciBhbmQgcmVzcG9uc2Uuc3RhdHVzQ29kZSBpcyAyMDBcbiAgICAgIGVyciA9IG5ldyBFcnJvcihcIlN0YXR1cyBjb2RlIHJldHVybmVkICN7cmVzcG9uc2Uuc3RhdHVzQ29kZX1cIilcbiAgICBpZiBlcnJcbiAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpXG4gICAgICByZXR1cm5cbiAgICBpZiBub3QgdGhpcy5yZXNwb25zZVxuICAgICAgZGVmZXJyZWQucmVzb2x2ZSh0cnVlKVxuICAgICAgcmV0dXJuXG4gICAgaWYgbm90IGJvZHlcbiAgICAgIGRlZmVycmVkLnJlc29sdmUoKVxuICAgIGpzb25Cb2R5ID0gbnVsbFxuICAgIHRyeVxuICAgICAganNvbkJvZHkgPSBKU09OLnBhcnNlKGJvZHkpXG4gICAgY2F0Y2ggZXJyXG4gICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKVxuICAgICAgcmV0dXJuXG4gICAgZGVmZXJyZWQucmVzb2x2ZShqc29uQm9keSlcbiAgX2dyb3VwVmFsdWU6IChwYXJhbXMpIC0+XG4gICAgcGFyYW1zID0gXy5tZXJnZSh0aGlzLnBhcmFtZXRlcnMsIHBhcmFtcywgKGEsIGIpIC0+XG4gICAgICBhID0gXy5jbG9uZShhKVxuICAgICAgaWYgbm90IGJcbiAgICAgICAgcmV0dXJuIGFcbiAgICAgIGlmIGEudHlwZSBpcyBcInN0cmluZ1wiIGFuZCB0eXBlb2YgYiBpc250IFwic3RyaW5nXCJcbiAgICAgICAgYiA9IGIudG9TdHJpbmcoKVxuICAgICAgaWYgRGlzY292ZXJ5U2NoZW1hLmNoZWNrVHlwZShiLCBhLnR5cGUpXG4gICAgICAgIGEudmFsdWUgPSBiXG4gICAgICBlbHNlXG4gICAgICAgIGlmIHR5cGVvZiBiIGlzIFwic3RyaW5nXCJcbiAgICAgICAgICBiID0gXCInI3tifSdcIlxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiI3tifSBpcyBub3QgdHlwZW9mICN7YS50eXBlfVwiKVxuICAgICAgYS52YWx1ZSA9IGJcbiAgICAgIHJldHVybiBhXG4gICAgKVxuICBfY2hlY2tSZXF1aXJlZDogKHBhcmFtcykgLT5cbiAgICBmb3Iga2V5IG9mIHBhcmFtc1xuICAgICAgdmFsID0gcGFyYW1zW2tleV1cbiAgICAgIGlmIG5vdCB2YWwucmVxdWlyZWRcbiAgICAgICAgY29udGludWVcbiAgICAgIGlmIG5vdCB2YWwudmFsdWVcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwidGhlIHBhcmFtZXRlciAje2tleX0gaXMgcmVxdWlyZWRcIilcblxuXG5tb2R1bGUuZXhwb3J0cyA9IERpc2NvdmVyeU1ldGhvZCJdfQ==