var DiscoveryMethod, DiscoverySchema, Q, request, _;

_ = require("lodash");

Q = require("q");

request = require("request");

DiscoverySchema = require("./schema");

DiscoveryMethod = (function() {
  DiscoveryMethod.prototype.id = "";

  DiscoveryMethod.prototype.description = "";

  DiscoveryMethod.prototype.httpMethod = "";

  DiscoveryMethod.prototype.path = "";

  DiscoveryMethod.prototype.parameters = {};

  DiscoveryMethod.prototype.parameterOrder = [];

  DiscoveryMethod.prototype.request = {};

  DiscoveryMethod.prototype.response = {};

  DiscoveryMethod.prototype.client = null;

  function DiscoveryMethod(id, description, httpMethod, path, parameters, parameterOrder, req, response, client) {
    this.id = id;
    this.description = description;
    this.httpMethod = httpMethod;
    this.path = path;
    this.parameters = parameters;
    this.parameterOrder = parameterOrder;
    this.request = req;
    this.response = response;
    this.client = client;
    if (!httpMethod || typeof httpMethod !== "string") {
      throw new Error("Http method not provided for " + id);
    } else {
      this.httpMethod = httpMethod.toUpperCase();
    }
    if (!path || typeof path !== "string") {
      throw new Error("Path not provided for " + id);
    }
  }


  /**
  @param {Object} params
  @returns {Promise}
   */

  DiscoveryMethod.prototype.callMethod = function(params) {
    var deferred, err;
    deferred = Q.defer();
    try {
      this._callMethod(params, deferred);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
    }
    return deferred.promise;
  };

  DiscoveryMethod.prototype._callMethod = function(params, deferred) {
    params = params || {};
    if (!_.isPlainObject(params)) {
      throw new TypeError("Params is expected to be an Object");
    }
    params = this._groupValue(params);
    this._checkRequired(params);
    params = _.transform(params, function(result, value, key) {
      return result[key] = value.value;
    });
    return this._doRequest(params, null, deferred);
  };

  DiscoveryMethod.prototype._doRequest = function(params, requestBody, deferred, previousRequest) {
    var currentRequest, method;
    currentRequest = null;
    if (!previousRequest) {
      currentRequest = {
        url: "" + this.client.endpoint + this.client.basePath + this.path,
        json: requestBody,
        qs: params,
        method: this.httpMethod
      };
    } else {
      currentRequest = previousRequest;
    }
    method = this;
    return request(currentRequest, function(error, response, body) {
      return method._onResponse(error, response, body, deferred, currentRequest);
    });
  };

  DiscoveryMethod.prototype._onResponse = function(err, response, body, deferred, currentRequest) {
    var jsonBody;
    if (!err && (response.statusCode < 200 || response.statusCode >= 300)) {
      err = new Error("Status code returned " + response.statusCode);
    }
    if (err) {
      deferred.reject(err);
      return;
    }
    if (!body && this.httpMethod !== "GET") {
      deferred.resolve();
      return;
    } else if (!body) {
      deferred.reject(new Error("No body"));
      return;
    }
    jsonBody = null;
    try {
      jsonBody = JSON.parse(body);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
      return;
    }
    if (this.response instanceof Object && this.response.$ref) {
      this._resolveWithSchemaResponse(jsonBody, deferred, currentRequest);
    } else {

    }
    return deferred.resolve(jsonBody);
  };

  DiscoveryMethod.prototype._resolveWithSchemaResponse = function(jsonBody, deferred, currentRequest) {
    var childDeferred, key, schema, testKey, values;
    schema = this.client.getSchema(this.response.$ref);
    if (!schema) {
      return deferred.resolve(jsonBody);
    }
    if (!schema.properties["nextPageToken"]) {
      return deferred.resolve(jsonBody);
    }
    key = null;
    for (testKey in schema.properties) {
      if (!schema.properties.hasOwnProperty(testKey)) {
        continue;
      }
      if (testKey !== "nextPageToken") {
        key = testKey;
      }
    }
    if (!key) {
      return deferred.resolve(jsonBody);
    }
    if (schema.properties[key].type !== "array") {
      return deferred.resolve(jsonBody);
    }
    values = jsonBody[key];
    if (!_.isArray(values)) {
      return deferred.resolve(jsonBody);
    }
    if (!jsonBody["nextPageToken"]) {
      return deferred.resolve(values);
    }
    currentRequest.qs = currentRequest.qs || {};
    currentRequest.qs["nextPageToken"] = jsonBody["nextPageToken"];
    childDeferred = Q.defer();
    this._doRequest(null, null, childDeferred, currentRequest);
    return childDeferred.then(function(childValues) {
      return deferred.resolve(values.concat(childValues));
    }).fail(function() {
      return deferred.resolve(values);
    });
  };

  DiscoveryMethod.prototype._groupValue = function(params) {
    return params = _.merge(this.parameters, params, function(a, b) {
      a = _.clone(a);
      if (!b) {
        return a;
      }
      if (a.type === "string" && typeof b !== "string") {
        b = b.toString();
      }
      if (DiscoverySchema.checkType(b, a.type)) {
        a.value = b;
      } else {
        if (typeof b === "string") {
          b = "'" + b + "'";
        }
        throw new TypeError("" + b + " is not typeof " + a.type);
      }
      a.value = b;
      return a;
    });
  };

  DiscoveryMethod.prototype._checkRequired = function(params) {
    var key, val, _results;
    _results = [];
    for (key in params) {
      val = params[key];
      if (!val.required) {
        continue;
      }
      if (!val.value) {
        throw new Error("the parameter " + key + " is required");
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  return DiscoveryMethod;

})();

module.exports = DiscoveryMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsZWV0L2Rpc2NvdmVyeS9tZXRob2QuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsK0NBQUE7O0FBQUEsQ0FBQSxHQUFrQixPQUFBLENBQVEsUUFBUixDQUFsQixDQUFBOztBQUFBLENBQ0EsR0FBa0IsT0FBQSxDQUFRLEdBQVIsQ0FEbEIsQ0FBQTs7QUFBQSxPQUVBLEdBQWtCLE9BQUEsQ0FBUSxTQUFSLENBRmxCLENBQUE7O0FBQUEsZUFHQSxHQUFrQixPQUFBLENBQVEsVUFBUixDQUhsQixDQUFBOztBQUFBO0FBTUUsNEJBQUEsRUFBQSxHQUFJLEVBQUosQ0FBQTs7QUFBQSw0QkFDQSxXQUFBLEdBQWEsRUFEYixDQUFBOztBQUFBLDRCQUVBLFVBQUEsR0FBWSxFQUZaLENBQUE7O0FBQUEsNEJBR0EsSUFBQSxHQUFNLEVBSE4sQ0FBQTs7QUFBQSw0QkFJQSxVQUFBLEdBQVksRUFKWixDQUFBOztBQUFBLDRCQUtBLGNBQUEsR0FBZ0IsRUFMaEIsQ0FBQTs7QUFBQSw0QkFNQSxPQUFBLEdBQVMsRUFOVCxDQUFBOztBQUFBLDRCQU9BLFFBQUEsR0FBVSxFQVBWLENBQUE7O0FBQUEsNEJBUUEsTUFBQSxHQUFRLElBUlIsQ0FBQTs7QUFTYSxFQUFBLHlCQUFDLEVBQUQsRUFDQyxXQURELEVBRUMsVUFGRCxFQUdDLElBSEQsRUFJQyxVQUpELEVBS0MsY0FMRCxFQU1DLEdBTkQsRUFPQyxRQVBELEVBUUMsTUFSRCxHQUFBO0FBU1gsSUFBQSxJQUFJLENBQUMsRUFBTCxHQUFVLEVBQVYsQ0FBQTtBQUFBLElBQ0EsSUFBSSxDQUFDLFdBQUwsR0FBbUIsV0FEbkIsQ0FBQTtBQUFBLElBRUEsSUFBSSxDQUFDLFVBQUwsR0FBa0IsVUFGbEIsQ0FBQTtBQUFBLElBR0EsSUFBSSxDQUFDLElBQUwsR0FBWSxJQUhaLENBQUE7QUFBQSxJQUlBLElBQUksQ0FBQyxVQUFMLEdBQWtCLFVBSmxCLENBQUE7QUFBQSxJQUtBLElBQUksQ0FBQyxjQUFM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Q0FBTyxnQkFBQSxHQUFnQixHQUFoQixHQUFvQixjQUEzQixDQUFWLENBREY7T0FBQSxNQUFBOzhCQUFBO09BSkY7QUFBQTtvQkFEYztFQUFBLENBeEpoQixDQUFBOzt5QkFBQTs7SUFORixDQUFBOztBQUFBLE1BdUtNLENBQUMsT0FBUCxHQUFpQixlQXZLakIsQ0FBQSIsImZpbGUiOiJmbGVldC9kaXNjb3ZlcnkvbWV0aG9kLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiXyAgICAgICAgICAgICAgID0gcmVxdWlyZShcImxvZGFzaFwiKVxuUSAgICAgICAgICAgICAgID0gcmVxdWlyZShcInFcIilcbnJlcXVlc3QgICAgICAgICA9IHJlcXVpcmUoXCJyZXF1ZXN0XCIpXG5EaXNjb3ZlcnlTY2hlbWEgPSByZXF1aXJlKFwiLi9zY2hlbWFcIilcblxuY2xhc3MgRGlzY292ZXJ5TWV0aG9kXG4gIGlkOiBcIlwiXG4gIGRlc2NyaXB0aW9uOiBcIlwiXG4gIGh0dHBNZXRob2Q6IFwiXCJcbiAgcGF0aDogXCJcIlxuICBwYXJhbWV0ZXJzOiB7fVxuICBwYXJhbWV0ZXJPcmRlcjogW11cbiAgcmVxdWVzdDoge31cbiAgcmVzcG9uc2U6IHt9XG4gIGNsaWVudDogbnVsbFxuICBjb25zdHJ1Y3RvcjogKGlkLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgIGh0dHBNZXRob2QsXG4gICAgICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzLFxuICAgICAgICAgICAgICAgIHBhcmFtZXRlck9yZGVyLFxuICAgICAgICAgICAgICAgIHJlcSxcbiAgICAgICAgICAgICAgICByZXNwb25zZSxcbiAgICAgICAgICAgICAgICBjbGllbnQpIC0+XG4gICAgdGhpcy5pZCA9IGlkXG4gICAgdGhpcy5kZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uXG4gICAgdGhpcy5odHRwTWV0aG9kID0gaHR0cE1ldGhvZFxuICAgIHRoaXMucGF0aCA9IHBhdGhcbiAgICB0aGlzLnBhcmFtZXRlcnMgPSBwYXJhbWV0ZXJzXG4gICAgdGhpcy5wYXJhbWV0ZXJPcmRlciA9IHBhcmFtZXRlck9yZGVyXG4gICAgdGhpcy5yZXF1ZXN0ID0gcmVxXG4gICAgdGhpcy5yZXNwb25zZSA9IHJlc3BvbnNlXG4gICAgdGhpcy5jbGllbnQgPSBjbGllbnRcbiAgICBpZiBub3QgaHR0cE1ldGhvZCBvciB0eXBlb2YgaHR0cE1ldGhvZCBpc250IFwic3RyaW5nXCJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkh0dHAgbWV0aG9kIG5vdCBwcm92aWRlZCBmb3IgI3tpZH1cIilcbiAgICBlbHNlXG4gICAgICB0aGlzLmh0dHBNZXRob2QgPSBodHRwTWV0aG9kLnRvVXBwZXJDYXNlKClcbiAgICBpZiBub3QgcGF0aCBvciB0eXBlb2YgcGF0aCBpc250IFwic3RyaW5nXCJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhdGggbm90IHByb3ZpZGVkIGZvciAje2lkfVwiKVxuICAjIyMqXG4gIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXNcbiAgQHJldHVybnMge1Byb21pc2V9XG4gICMjI1xuICBjYWxsTWV0aG9kOiAocGFyYW1zKSAtPlxuICAgIGRlZmVycmVkID0gUS5kZWZlcigpXG4gICAgdHJ5XG4gICAgICAjIFdyYXAgdGhlIHdob2xlIGZ1bmN0aW9uIG9yIGl0IGlzIGp1c3RcbiAgICAgICMgQmxvYXRlZCB3aXRoIHRyeSBjYXRjaGVzXG4gICAgICB0aGlzLl9jYWxsTWV0aG9kKHBhcmFtcywgZGVmZXJyZWQpXG4gICAgY2F0Y2ggZXJyXG4gICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKVxuICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlXG4gIF9jYWxsTWV0aG9kOiAocGFyYW1zLCBkZWZlcnJlZCkgLT5cbiAgICBwYXJhbXMgPSBwYXJhbXMgb3Ige31cbiAgICBpZiBub3QgXy5pc1BsYWluT2JqZWN0KHBhcmFtcylcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJQYXJhbXMgaXMgZXhwZWN0ZWQgdG8gYmUgYW4gT2JqZWN0XCIpXG4gICAgcGFyYW1zID0gdGhpcy5fZ3JvdXBWYWx1ZShwYXJhbXMpXG4gICAgdGhpcy5fY2hlY2tSZXF1aXJlZChwYXJhbXMpXG4gICAgIyB0dXJuIHRoZSBxdWVyeSBzdHJpbmcgaW50byBrZXkgdmFsdWUgcGFpcnNcbiAgICBwYXJhbXMgPSBfLnRyYW5zZm9ybShwYXJhbXMsIChyZXN1bHQsIHZhbHVlLCBrZXkpIC0+XG4gICAgICByZXN1bHRba2V5XSA9IHZhbHVlLnZhbHVlXG4gICAgKVxuICAgIHRoaXMuX2RvUmVxdWVzdChwYXJhbXMsIG51bGwsIGRlZmVycmVkKVxuICBfZG9SZXF1ZXN0OiAocGFyYW1zLCByZXF1ZXN0Qm9keSwgZGVmZXJyZWQsIHByZXZpb3VzUmVxdWVzdCkgLT5cbiAgICBjdXJyZW50UmVxdWVzdCA9IG51bGxcbiAgICBpZiBub3QgcHJldmlvdXNSZXF1ZXN0XG4gICAgICBjdXJyZW50UmVxdWVzdCA9XG4gICAgICAgIHVybDogXCIje3RoaXMuY2xpZW50LmVuZHBvaW50fSN7dGhpcy5jbGllbnQuYmFzZVBhdGh9I3t0aGlzLnBhdGh9XCJcbiAgICAgICAgIyBXaWxsIHNldCBjb250ZW50L3R5cGUgdG8gYXBwbGljYXRpb24vanNvblxuICAgICAgICBqc29uOiByZXF1ZXN0Qm9keVxuICAgICAgICBxczogcGFyYW1zXG4gICAgICAgIG1ldGhvZDogdGhpcy5odHRwTWV0aG9kXG4gICAgZWxzZVxuICAgICAgY3VycmVudFJlcXVlc3QgPSBwcmV2aW91c1JlcXVlc3RcbiAgICBtZXRob2QgPSB0aGlzXG4gICAgcmVxdWVzdChjdXJyZW50UmVxdWVzdCwgKGVycm9yLCByZXNwb25zZSwgYm9keSkgLT5cbiAgICAgIG1ldGhvZC5fb25SZXNwb25zZShlcnJvciwgcmVzcG9uc2UsIGJvZHksIGRlZmVycmVkLCBjdXJyZW50UmVxdWVzdClcbiAgICApXG4gIF9vblJlc3BvbnNlOiAoZXJyLCByZXNwb25zZSwgYm9keSwgZGVmZXJyZWQsIGN1cnJlbnRSZXF1ZXN0KSAtPlxuICAgIGlmIG5vdCBlcnIgYW5kIChyZXNwb25zZS5zdGF0dXNDb2RlIDwgMjAwIG9yIHJlc3BvbnNlLnN0YXR1c0NvZGUgPj0gMzAwKVxuICAgICAgIyBUT0RPIEltcGxlbWVudCByZWRpcmVjdGlvbiAzMDEsIDMwMlssIDMwM10sIDMwNFxuICAgICAgZXJyID0gbmV3IEVycm9yKFwiU3RhdHVzIGNvZGUgcmV0dXJuZWQgI3tyZXNwb25zZS5zdGF0dXNDb2RlfVwiKVxuICAgIGlmIGVyclxuICAgICAgZGVmZXJyZWQucmVqZWN0KGVycilcbiAgICAgIHJldHVyblxuICAgIGlmIG5vdCBib2R5IGFuZCB0aGlzLmh0dHBNZXRob2QgaXNudCBcIkdFVFwiXG4gICAgICBkZWZlcnJlZC5yZXNvbHZlKClcbiAgICAgIHJldHVyblxuICAgIGVsc2UgaWYgbm90IGJvZHlcbiAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoXCJObyBib2R5XCIpKVxuICAgICAgcmV0dXJuXG4gICAganNvbkJvZHkgPSBudWxsXG4gICAgdHJ5XG4gICAgICBqc29uQm9keSA9IEpTT04ucGFyc2UoYm9keSlcbiAgICBjYXRjaCBlcnJcbiAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpXG4gICAgICByZXR1cm5cbiAgICBpZiB0aGlzLnJlc3BvbnNlIGluc3RhbmNlb2YgT2JqZWN0IGFuZCB0aGlzLnJlc3BvbnNlLiRyZWZcbiAgICAgIHRoaXMuX3Jlc29sdmVXaXRoU2NoZW1hUmVzcG9uc2UoanNvbkJvZHksIGRlZmVycmVkLCBjdXJyZW50UmVxdWVzdClcbiAgICBlbHNlXG4gICAgZGVmZXJyZWQucmVzb2x2ZShqc29uQm9keSlcbiAgX3Jlc29sdmVXaXRoU2NoZW1hUmVzcG9uc2U6IChqc29uQm9keSwgZGVmZXJyZWQsIGN1cnJlbnRSZXF1ZXN0KSAtPlxuICAgIHNjaGVtYSA9IHRoaXMuY2xpZW50LmdldFNjaGVtYSh0aGlzLnJlc3BvbnNlLiRyZWYpXG4gICAgIyBObyBzY2hlbWEsIG5vIGNoZWNrXG4gICAgaWYgbm90IHNjaGVtYVxuICAgICAgcmV0dXJuIGRlZmVycmVkLnJlc29sdmUoanNvbkJvZHkpXG4gICAgIyBJZiByZXNwb25zZSBzaG91bGQgbmV2ZXIgY29udGFpbiBuZXh0UGFnZVRva2VuXG4gICAgaWYgbm90IHNjaGVtYS5wcm9wZXJ0aWVzW1wibmV4dFBhZ2VUb2tlblwiXVxuICAgICAgcmV0dXJuIGRlZmVycmVkLnJlc29sdmUoanNvbkJvZHkpXG4gICAgIyBUaGVyZSBzaG91bGQgYmUgb25lIG90aGVyIHByb3BlcnR5IG9mIHR5cGUgYXJyYXlcbiAgICBrZXkgPSBudWxsXG4gICAgZm9yIHRlc3RLZXkgb2Ygc2NoZW1hLnByb3BlcnRpZXNcbiAgICAgIGlmIG5vdCBzY2hlbWEucHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eSh0ZXN0S2V5KVxuICAgICAgICBjb250aW51ZVxuICAgICAgaWYgdGVzdEtleSBpc250IFwibmV4dFBhZ2VUb2tlblwiXG4gICAgICAgIGtleSA9IHRlc3RLZXlcbiAgICBpZiBub3Qga2V5XG4gICAgICByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZShqc29uQm9keSlcbiAgICBpZiBzY2hlbWEucHJvcGVydGllc1trZXldLnR5cGUgaXNudCBcImFycmF5XCJcbiAgICAgICMgVE9ETyBpbXBsZW1lbnQgZm9yIG9iamVjdHNcbiAgICAgIHJldHVybiBkZWZlcnJlZC5yZXNvbHZlKGpzb25Cb2R5KVxuICAgICMgVGhpcyBzaG91bGQgYmUgYW4gYXJyYXlcbiAgICB2YWx1ZXMgPSBqc29uQm9keVtrZXldXG4gICAgIyBJZiBub3QgdGhyb3cgaXQgYXdheVxuICAgIGlmIG5vdCBfLmlzQXJyYXkodmFsdWVzKVxuICAgICAgcmV0dXJuIGRlZmVycmVkLnJlc29sdmUoanNvbkJvZHkpXG4gICAgaWYgbm90IGpzb25Cb2R5W1wibmV4dFBhZ2VUb2tlblwiXVxuICAgICAgIyBPbmx5IHJldHVybiB0byB0aGUgdXNlciB0aGUgdmFsdWVzXG4gICAgICByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZSh2YWx1ZXMpXG4gICAgIyBNb2RpZnkgdGhlIGV4aXN0aW5nIHF1ZXJ5IHN0cmluZyBvciBjcmVhdGUgaXRcbiAgICBjdXJyZW50UmVxdWVzdC5xcyA9IGN1cnJlbnRSZXF1ZXN0LnFzIG9yIHt9XG4gICAgY3VycmVudFJlcXVlc3QucXNbXCJuZXh0UGFnZVRva2VuXCJdID0ganNvbkJvZHlbXCJuZXh0UGFnZVRva2VuXCJdXG4gICAgY2hpbGREZWZlcnJlZCA9IFEuZGVmZXIoKVxuICAgIHRoaXMuX2RvUmVxdWVzdChudWxsLCBudWxsLCBjaGlsZERlZmVycmVkLCBjdXJyZW50UmVxdWVzdClcbiAgICBjaGlsZERlZmVycmVkLnRoZW4oKGNoaWxkVmFsdWVzKSAtPlxuICAgICAgZGVmZXJyZWQucmVzb2x2ZSh2YWx1ZXMuY29uY2F0KGNoaWxkVmFsdWVzKSlcbiAgICApLmZhaWwoIC0+XG4gICAgICAjIFRPRE8gZG8gc29tZXRoaW5nIGluIHRoaXMgY2FzZSB3aGVyZSB0aGUgbmV4dCBwYWdlXG4gICAgICAjIGZhaWxzLCBmb3Igbm93IHJldHVyblxuICAgICAgZGVmZXJyZWQucmVzb2x2ZSh2YWx1ZXMpXG4gICAgKVxuXG4gIF9ncm91cFZhbHVlOiAocGFyYW1zKSAtPlxuICAgIHBhcmFtcyA9IF8ubWVyZ2UodGhpcy5wYXJhbWV0ZXJzLCBwYXJhbXMsIChhLCBiKSAtPlxuICAgICAgYSA9IF8uY2xvbmUoYSlcbiAgICAgIGlmIG5vdCBiXG4gICAgICAgIHJldHVybiBhXG4gICAgICBpZiBhLnR5cGUgaXMgXCJzdHJpbmdcIiBhbmQgdHlwZW9mIGIgaXNudCBcInN0cmluZ1wiXG4gICAgICAgIGIgPSBiLnRvU3RyaW5nKClcbiAgICAgIGlmIERpc2NvdmVyeVNjaGVtYS5jaGVja1R5cGUoYiwgYS50eXBlKVxuICAgICAgICBhLnZhbHVlID0gYlxuICAgICAgZWxzZVxuICAgICAgICBpZiB0eXBlb2YgYiBpcyBcInN0cmluZ1wiXG4gICAgICAgICAgYiA9IFwiJyN7Yn0nXCJcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIiN7Yn0gaXMgbm90IHR5cGVvZiAje2EudHlwZX1cIilcbiAgICAgIGEudmFsdWUgPSBiXG4gICAgICByZXR1cm4gYVxuICAgIClcbiAgX2NoZWNrUmVxdWlyZWQ6IChwYXJhbXMpIC0+XG4gICAgZm9yIGtleSBvZiBwYXJhbXNcbiAgICAgIHZhbCA9IHBhcmFtc1trZXldXG4gICAgICBpZiBub3QgdmFsLnJlcXVpcmVkXG4gICAgICAgIGNvbnRpbnVlXG4gICAgICBpZiBub3QgdmFsLnZhbHVlXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInRoZSBwYXJhbWV0ZXIgI3trZXl9IGlzIHJlcXVpcmVkXCIpXG5cblxubW9kdWxlLmV4cG9ydHMgPSBEaXNjb3ZlcnlNZXRob2QiXX0=