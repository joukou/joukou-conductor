var DiscoveryMethod, Q, request, _;

_ = require("lodash");

Q = require("q");

request = require("request");

DiscoveryMethod = (function() {
  DiscoveryMethod.prototype.id = "";

  DiscoveryMethod.prototype.description = "";

  DiscoveryMethod.prototype.httpMethod = "";

  DiscoveryMethod.prototype.path = "";

  DiscoveryMethod.prototype.parameters = {};

  DiscoveryMethod.prototype.parameterOrder = [];

  DiscoveryMethod.prototype.request = {};

  DiscoveryMethod.prototype.response = {};

  DiscoveryMethod.prototype.client = null;

  function DiscoveryMethod(id, description, httpMethod, path, parameters, parameterOrder, req, response, client) {
    this.id = id;
    this.description = description;
    this.httpMethod = httpMethod;
    this.path = path;
    this.parameters = parameters;
    this.parameterOrder = parameterOrder;
    this.request = req;
    this.response = response;
    this.client = client;
    if (!httpMethod || typeof httpMethod !== "string") {
      throw new Error("Http method not provided for " + id);
    } else {
      this.httpMethod = httpMethod.toUpperCase();
    }
    if (!path || typeof path !== "string") {
      throw new Error("Path not provided for " + id);
    }
  }


  /**
  @param {Object} params
  @returns {Promise}
   */

  DiscoveryMethod.prototype.callMethod = function(params) {
    var deferred, err;
    deferred = Q.defer();
    try {
      this._callMethod(params, deferred);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
    }
    return deferred.promise;
  };

  DiscoveryMethod.prototype._callMethod = function(params, deferred) {
    params = params || {};
    if (!_.isPlainObject(params)) {
      throw new TypeError("Params is expected to be an Object");
    }
    params = this._groupValue(params);
    this._checkRequired(params);
    params = _.transform(params, function(result, value, key) {
      return result[key] = value.value;
    });
    return this._doRequest(params, null, deferred);
  };

  DiscoveryMethod.prototype._doRequest = function(params, body, deferred) {
    var method, req;
    req = {
      url: "" + this.client.endpoint + this.client.basePath,
      json: body,
      qs: params,
      method: this.httpMethod
    };
    method = this;
    return request(req, function(err, response, body) {
      return method._onResponse(err, response, body);
    });
  };

  DiscoveryMethod.prototype._onResponse = function(err, response, body) {};

  DiscoveryMethod.prototype._groupValue = function(params) {
    return params = _.merge(this.parameters, params, function(a, b) {
      a = _.clone(a);
      if (!b) {
        return a;
      }
      if (a.type === "string" && typeof b !== "string") {
        b = b.toString();
      }
      if (a.type === typeof b) {
        a.value = b;
      } else {
        throw new TypeError("" + b + " is not typeof " + a.type);
      }
      a.value = b;
      return a;
    });
  };

  DiscoveryMethod.prototype._checkRequired = function(params) {
    var key, required, _i, _len, _results;
    required = _.where(params, {
      required: true
    });
    _results = [];
    for (_i = 0, _len = required.length; _i < _len; _i++) {
      key = required[_i];
      if (!required[key].value) {
        throw new Error("the parameter " + key + " is required");
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  return DiscoveryMethod;

})();

module.exports = DiscoveryMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsZWV0L2Rpc2NvdmVyeS9tZXRob2QuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsOEJBQUE7O0FBQUEsQ0FBQSxHQUFVLE9BQUEsQ0FBUSxRQUFSLENBQVYsQ0FBQTs7QUFBQSxDQUNBLEdBQVUsT0FBQSxDQUFRLEdBQVIsQ0FEVixDQUFBOztBQUFBLE9BRUEsR0FBVSxPQUFBLENBQVEsU0FBUixDQUZWLENBQUE7O0FBQUE7QUFLRSw0QkFBQSxFQUFBLEdBQUksRUFBSixDQUFBOztBQUFBLDRCQUNBLFdBQUEsR0FBYSxFQURiLENBQUE7O0FBQUEsNEJBRUEsVUFBQSxHQUFZLEVBRlosQ0FBQTs7QUFBQSw0QkFHQSxJQUFBLEdBQU0sRUFITixDQUFBOztBQUFBLDRCQUlBLFVBQUEsR0FBWSxFQUpaLENBQUE7O0FBQUEsNEJBS0EsY0FBQSxHQUFnQixFQUxoQixDQUFBOztBQUFBLDRCQU1BLE9BQUEsR0FBUyxFQU5ULENBQUE7O0FBQUEsNEJBT0EsUUFBQSxHQUFVLEVBUFYsQ0FBQTs7QUFBQSw0QkFRQSxNQUFBLEdBQVEsSUFSUixDQUFBOztBQVNhLEVBQUEseUJBQUMsRUFBRCxFQUNDLFdBREQsRUFFQyxVQUZELEVBR0MsSUFIRCxFQUlDLFVBSkQsRUFLQyxjQUxELEVBTUMsR0FORCxFQU9DLFFBUEQsRUFRQyxNQVJELEdBQUE7QUFTWCxJQUFBLElBQUksQ0FBQyxFQUFMLEdBQVUsRUFBVixDQUFBO0FBQUEsSUFDQSxJQUFJLENBQUMsV0FBTCxHQUFtQixXQURuQixDQUFBO0FBQUEsSUFFQSxJQUFJLENBQUMsVUFBTCxHQUFrQixVQUZsQixDQUFBO0FBQUEsSUFHQSxJQUFJLENBQUMsSUFBTCxHQUFZLElBSFosQ0FBQTtBQUFBLElBSUEsSUFBSSxDQUFDLFVBQUwsR0FBa0IsVUFKbEIsQ0FBQTtBQUFBLElBS0EsSUFBSSxDQUFDLGNBQUwsR0FBc0IsY0FMdEIsQ0FBQTtBQUFBLElBTUEsSUFBSSxDQUFDLE9BQUwsR0FBZSxH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QUE7OEJBQUE7T0FERjtBQUFBO29CQUZjO0VBQUEsQ0FwRmhCLENBQUE7O3lCQUFBOztJQUxGLENBQUE7O0FBQUEsTUFnR00sQ0FBQyxPQUFQLEdBQWlCLGVBaEdqQixDQUFBIiwiZmlsZSI6ImZsZWV0L2Rpc2NvdmVyeS9tZXRob2QuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJfICAgICAgID0gcmVxdWlyZShcImxvZGFzaFwiKVxuUSAgICAgICA9IHJlcXVpcmUoXCJxXCIpXG5yZXF1ZXN0ID0gcmVxdWlyZShcInJlcXVlc3RcIilcblxuY2xhc3MgRGlzY292ZXJ5TWV0aG9kXG4gIGlkOiBcIlwiXG4gIGRlc2NyaXB0aW9uOiBcIlwiXG4gIGh0dHBNZXRob2Q6IFwiXCJcbiAgcGF0aDogXCJcIlxuICBwYXJhbWV0ZXJzOiB7fVxuICBwYXJhbWV0ZXJPcmRlcjogW11cbiAgcmVxdWVzdDoge31cbiAgcmVzcG9uc2U6IHt9XG4gIGNsaWVudDogbnVsbFxuICBjb25zdHJ1Y3RvcjogKGlkLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgIGh0dHBNZXRob2QsXG4gICAgICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzLFxuICAgICAgICAgICAgICAgIHBhcmFtZXRlck9yZGVyLFxuICAgICAgICAgICAgICAgIHJlcSxcbiAgICAgICAgICAgICAgICByZXNwb25zZSxcbiAgICAgICAgICAgICAgICBjbGllbnQpIC0+XG4gICAgdGhpcy5pZCA9IGlkXG4gICAgdGhpcy5kZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uXG4gICAgdGhpcy5odHRwTWV0aG9kID0gaHR0cE1ldGhvZFxuICAgIHRoaXMucGF0aCA9IHBhdGhcbiAgICB0aGlzLnBhcmFtZXRlcnMgPSBwYXJhbWV0ZXJzXG4gICAgdGhpcy5wYXJhbWV0ZXJPcmRlciA9IHBhcmFtZXRlck9yZGVyXG4gICAgdGhpcy5yZXF1ZXN0ID0gcmVxXG4gICAgdGhpcy5yZXNwb25zZSA9IHJlc3BvbnNlXG4gICAgdGhpcy5jbGllbnQgPSBjbGllbnRcbiAgICBpZiBub3QgaHR0cE1ldGhvZCBvciB0eXBlb2YgaHR0cE1ldGhvZCBpc250IFwic3RyaW5nXCJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkh0dHAgbWV0aG9kIG5vdCBwcm92aWRlZCBmb3IgI3tpZH1cIilcbiAgICBlbHNlXG4gICAgICB0aGlzLmh0dHBNZXRob2QgPSBodHRwTWV0aG9kLnRvVXBwZXJDYXNlKClcbiAgICBpZiBub3QgcGF0aCBvciB0eXBlb2YgcGF0aCBpc250IFwic3RyaW5nXCJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhdGggbm90IHByb3ZpZGVkIGZvciAje2lkfVwiKVxuICAjIyMqXG4gIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXNcbiAgQHJldHVybnMge1Byb21pc2V9XG4gICMjI1xuICBjYWxsTWV0aG9kOiAocGFyYW1zKSAtPlxuICAgIGRlZmVycmVkID0gUS5kZWZlcigpXG4gICAgdHJ5XG4gICAgICAjIFdyYXAgdGhlIHdob2xlIGZ1bmN0aW9uIG9yIGl0IGlzIGp1c3RcbiAgICAgICMgQmxvYXRlZCB3aXRoIHRyeSBjYXRjaGVzXG4gICAgICB0aGlzLl9jYWxsTWV0aG9kKHBhcmFtcywgZGVmZXJyZWQpXG4gICAgY2F0Y2ggZXJyXG4gICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKVxuICAgIGRlZmVycmVkLnByb21pc2VcbiAgX2NhbGxNZXRob2Q6IChwYXJhbXMsIGRlZmVycmVkKSAtPlxuICAgIHBhcmFtcyA9IHBhcmFtcyBvciB7fVxuICAgIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QocGFyYW1zKVxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlBhcmFtcyBpcyBleHBlY3RlZCB0byBiZSBhbiBPYmplY3RcIilcbiAgICBwYXJhbXMgPSB0aGlzLl9ncm91cFZhbHVlKHBhcmFtcylcbiAgICB0aGlzLl9jaGVja1JlcXVpcmVkKHBhcmFtcylcbiAgICAjIHR1cm4gdGhlIHF1ZXJ5IHN0cmluZyBpbnRvIGtleSB2YWx1ZSBwYWlyc1xuICAgIHBhcmFtcyA9IF8udHJhbnNmb3JtKHBhcmFtcywgKHJlc3VsdCwgdmFsdWUsIGtleSkgLT5cbiAgICAgIHJlc3VsdFtrZXldID0gdmFsdWUudmFsdWVcbiAgICApXG4gICAgdGhpcy5fZG9SZXF1ZXN0KHBhcmFtcywgbnVsbCwgZGVmZXJyZWQpXG4gIF9kb1JlcXVlc3Q6IChwYXJhbXMsIGJvZHksIGRlZmVycmVkKSAtPlxuICAgIHJlcSA9XG4gICAgICB1cmw6IFwiI3t0aGlzLmNsaWVudC5lbmRwb2ludH0je3RoaXMuY2xpZW50LmJhc2VQYXRofVwiXG4gICAgICAjIFdpbGwgc2V0IGNvbnRlbnQvdHlwZSB0byBhcHBsaWNhdGlvbi9qc29uXG4gICAgICBqc29uOiBib2R5XG4gICAgICBxczogcGFyYW1zXG4gICAgICBtZXRob2Q6IHRoaXMuaHR0cE1ldGhvZFxuICAgIG1ldGhvZCA9IHRoaXNcbiAgICByZXF1ZXN0KHJlcSwgKGVyciwgcmVzcG9uc2UsIGJvZHkpIC0+XG4gICAgICBtZXRob2QuX29uUmVzcG9uc2UoZXJyLCByZXNwb25zZSwgYm9keSlcbiAgICApXG4gIF9vblJlc3BvbnNlOiAoZXJyLCByZXNwb25zZSwgYm9keSkgLT5cblxuICBfZ3JvdXBWYWx1ZTogKHBhcmFtcykgLT5cbiAgICBwYXJhbXMgPSBfLm1lcmdlKHRoaXMucGFyYW1ldGVycywgcGFyYW1zLCAoYSwgYikgLT5cbiAgICAgIGEgPSBfLmNsb25lKGEpXG4gICAgICBpZiBub3QgYlxuICAgICAgICByZXR1cm4gYVxuICAgICAgaWYgYS50eXBlIGlzIFwic3RyaW5nXCIgYW5kIHR5cGVvZiBiIGlzbnQgXCJzdHJpbmdcIlxuICAgICAgICBiID0gYi50b1N0cmluZygpXG4gICAgICBpZiBhLnR5cGUgaXMgdHlwZW9mIGJcbiAgICAgICAgYS52YWx1ZSA9IGJcbiAgICAgIGVsc2VcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIiN7Yn0gaXMgbm90IHR5cGVvZiAje2EudHlwZX1cIilcbiAgICAgIGEudmFsdWUgPSBiXG4gICAgICByZXR1cm4gYVxuICAgIClcbiAgX2NoZWNrUmVxdWlyZWQ6IChwYXJhbXMpIC0+XG4gICAgcmVxdWlyZWQgPSBfLndoZXJlKHBhcmFtcywge3JlcXVpcmVkOnRydWV9KVxuICAgIGZvciBrZXkgaW4gcmVxdWlyZWRcbiAgICAgIGlmIG5vdCByZXF1aXJlZFtrZXldLnZhbHVlXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcInRoZSBwYXJhbWV0ZXIgI3trZXl9IGlzIHJlcXVpcmVkXCIpXG5cblxubW9kdWxlLmV4cG9ydHMgPSBEaXNjb3ZlcnlNZXRob2QiXX0=