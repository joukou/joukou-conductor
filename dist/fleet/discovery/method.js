var DiscoveryMethod, DiscoverySchema, Q, request, _;

_ = require("lodash");

Q = require("q");

request = require("request");

DiscoverySchema = require("./schema");

DiscoveryMethod = (function() {
  DiscoveryMethod.prototype.id = "";

  DiscoveryMethod.prototype.description = "";

  DiscoveryMethod.prototype.httpMethod = "";

  DiscoveryMethod.prototype.path = "";

  DiscoveryMethod.prototype.parameters = {};

  DiscoveryMethod.prototype.parameterOrder = [];

  DiscoveryMethod.prototype.request = {};

  DiscoveryMethod.prototype.response = {};

  DiscoveryMethod.prototype.client = null;

  function DiscoveryMethod(id, description, httpMethod, path, parameters, parameterOrder, req, response, client) {
    this.id = id;
    this.description = description;
    this.httpMethod = httpMethod;
    this.path = path;
    this.parameters = parameters;
    this.parameterOrder = parameterOrder;
    this.request = req;
    this.response = response;
    this.client = client;
    if (!httpMethod || typeof httpMethod !== "string") {
      throw new Error("Http method not provided for " + id);
    } else {
      this.httpMethod = httpMethod.toUpperCase();
    }
    if (!path || typeof path !== "string") {
      throw new Error("Path not provided for " + id);
    }
  }


  /**
  @param {Object} params
  @returns {Promise}
   */

  DiscoveryMethod.prototype.callMethod = function(params) {
    var deferred, err;
    deferred = Q.defer();
    try {
      this._callMethod(params, deferred);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
    }
    return deferred.promise;
  };

  DiscoveryMethod.prototype._callMethod = function(params, deferred) {
    params = params || {};
    if (!_.isPlainObject(params)) {
      throw new TypeError("Params is expected to be an Object");
    }
    params = this._groupValue(params);
    this._checkRequired(params);
    params = _.transform(params, function(result, value, key) {
      return result[key] = value.value;
    });
    return this._doRequest(params, null, deferred);
  };

  DiscoveryMethod.prototype._doRequest = function(params, requestBody, deferred, previousRequest) {
    var currentRequest, method;
    currentRequest = null;
    if (!previousRequest) {
      currentRequest = {
        url: "" + this.client.endpoint + this.client.basePath + this.path,
        json: requestBody,
        qs: params,
        method: this.httpMethod
      };
    } else {
      currentRequest = previousRequest;
    }
    method = this;
    return request(currentRequest, function(error, response, body) {
      return method._onResponse(error, response, body, deferred, currentRequest);
    });
  };

  DiscoveryMethod.prototype._onResponse = function(err, response, body, deferred, currentRequest) {
    var jsonBody;
    if (!err && (response.statusCode < 200 || response.statusCode >= 300)) {
      err = new Error("Status code returned " + response.statusCode);
    }
    if (err) {
      deferred.reject(err);
      return;
    }
    if (!body && this.httpMethod !== "GET") {
      deferred.resolve();
      return;
    } else if (!body) {
      deferred.reject(new Error("No body"));
      return;
    }
    jsonBody = null;
    try {
      jsonBody = JSON.parse(body);
    } catch (_error) {
      err = _error;
      deferred.reject(err);
      return;
    }
    if (this.response instanceof Object && this.response.$ref) {
      return this._resolveWithSchemaResponse(jsonBody, deferred, currentRequest);
    } else {
      return deferred.resolve(jsonBody);
    }
  };

  DiscoveryMethod.prototype._resolveWithSchemaResponse = function(jsonBody, deferred, currentRequest) {
    var childDeferred, key, schema, testKey, values;
    schema = this.client.getSchema(this.response.$ref);
    if (!schema) {
      return deferred.resolve(jsonBody);
    }
    if (!schema.properties["nextPageToken"]) {
      return deferred.resolve(jsonBody);
    }
    key = null;
    for (testKey in schema.properties) {
      if (!schema.properties.hasOwnProperty(testKey)) {
        continue;
      }
      if (testKey !== "nextPageToken") {
        key = testKey;
      }
    }
    if (!key) {
      return deferred.resolve(jsonBody);
    }
    if (schema.properties[key].type !== "array") {
      return deferred.resolve(jsonBody);
    }
    values = jsonBody[key];
    if (!_.isArray(values)) {
      return deferred.resolve(jsonBody);
    }
    if (!jsonBody["nextPageToken"]) {
      return deferred.resolve(values);
    }
    currentRequest.qs = currentRequest.qs || {};
    currentRequest.qs["nextPageToken"] = jsonBody["nextPageToken"];
    childDeferred = Q.defer();
    this._doRequest(null, null, childDeferred, currentRequest);
    return childDeferred.promise.then(function(childValues) {
      return deferred.resolve(values.concat(childValues));
    }).fail(function() {
      return deferred.resolve(values);
    });
  };

  DiscoveryMethod.prototype._groupValue = function(params) {
    return params = _.merge(this.parameters, params, function(a, b) {
      a = _.clone(a);
      if (!b) {
        return a;
      }
      if (a.type === "string" && typeof b !== "string") {
        b = b.toString();
      }
      if (DiscoverySchema.checkType(b, a.type)) {
        a.value = b;
      } else {
        if (typeof b === "string") {
          b = "'" + b + "'";
        }
        throw new TypeError("" + b + " is not typeof " + a.type);
      }
      a.value = b;
      return a;
    });
  };

  DiscoveryMethod.prototype._checkRequired = function(params) {
    var key, val, _results;
    _results = [];
    for (key in params) {
      val = params[key];
      if (!val.required) {
        continue;
      }
      if (!val.value) {
        throw new Error("the parameter " + key + " is required");
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  return DiscoveryMethod;

})();

module.exports = DiscoveryMethod;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsZWV0L2Rpc2NvdmVyeS9tZXRob2QuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsK0NBQUE7O0FBQUEsQ0FBQSxHQUFrQixPQUFBLENBQVEsUUFBUixDQUFsQixDQUFBOztBQUFBLENBQ0EsR0FBa0IsT0FBQSxDQUFRLEdBQVIsQ0FEbEIsQ0FBQTs7QUFBQSxPQUVBLEdBQWtCLE9BQUEsQ0FBUSxTQUFSLENBRmxCLENBQUE7O0FBQUEsZUFHQSxHQUFrQixPQUFBLENBQVEsVUFBUixDQUhsQixDQUFBOztBQUFBO0FBTUUsNEJBQUEsRUFBQSxHQUFJLEVBQUosQ0FBQTs7QUFBQSw0QkFDQSxXQUFBLEdBQWEsRUFEYixDQUFBOztBQUFBLDRCQUVBLFVBQUEsR0FBWSxFQUZaLENBQUE7O0FBQUEsNEJBR0EsSUFBQSxHQUFNLEVBSE4sQ0FBQTs7QUFBQSw0QkFJQSxVQUFBLEdBQVksRUFKWixDQUFBOztBQUFBLDRCQUtBLGNBQUEsR0FBZ0IsRUFMaEIsQ0FBQTs7QUFBQSw0QkFNQSxPQUFBLEdBQVMsRUFOVCxDQUFBOztBQUFBLDRCQU9BLFFBQUEsR0FBVSxFQVBWLENBQUE7O0FBQUEsNEJBUUEsTUFBQSxHQUFRLElBUlIsQ0FBQTs7QUFTYSxFQUFBLHlCQUFDLEVBQUQsRUFDQyxXQURELEVBRUMsVUFGRCxFQUdDLElBSEQsRUFJQyxVQUpELEVBS0MsY0FMRCxFQU1DLEdBTkQsRUFPQyxRQVBELEVBUUMsTUFSRCxHQUFBO0FBU1gsSUFBQSxJQUFJLENBQUMsRUFBTCxHQUFVLEVBQVYsQ0FBQTtBQUFBLElBQ0EsSUFBSSxDQUFDLFdBQUwsR0FBbUIsV0FEbkIsQ0FBQTtBQUFBLElBRUEsSUFBSSxDQUFDLFVBQUwsR0FBa0IsVUFGbEIsQ0FBQTtBQUFBLElBR0EsSUFBSSxDQUFDLElBQUwsR0FBWSxJQUhaLENBQUE7QUFBQSxJQUlBLElBQUksQ0FBQyxVQUFMLEdBQWtCLFVBSmxCLENBQUE7QUFBQSxJQUtBLElBQUksQ0FBQyxjQUFM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QkFBQSxHQUFnQixHQUFoQixHQUFvQixjQUEzQixDQUFWLENBREY7T0FBQSxNQUFBOzhCQUFBO09BSkY7QUFBQTtvQkFEYztFQUFBLENBeEpoQixDQUFBOzt5QkFBQTs7SUFORixDQUFBOztBQUFBLE1BdUtNLENBQUMsT0FBUCxHQUFpQixlQXZLakIsQ0FBQSIsImZpbGUiOiJmbGVldC9kaXNjb3ZlcnkvbWV0aG9kLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiXyAgICAgICAgICAgICAgID0gcmVxdWlyZShcImxvZGFzaFwiKVxuUSAgICAgICAgICAgICAgID0gcmVxdWlyZShcInFcIilcbnJlcXVlc3QgICAgICAgICA9IHJlcXVpcmUoXCJyZXF1ZXN0XCIpXG5EaXNjb3ZlcnlTY2hlbWEgPSByZXF1aXJlKFwiLi9zY2hlbWFcIilcblxuY2xhc3MgRGlzY292ZXJ5TWV0aG9kXG4gIGlkOiBcIlwiXG4gIGRlc2NyaXB0aW9uOiBcIlwiXG4gIGh0dHBNZXRob2Q6IFwiXCJcbiAgcGF0aDogXCJcIlxuICBwYXJhbWV0ZXJzOiB7fVxuICBwYXJhbWV0ZXJPcmRlcjogW11cbiAgcmVxdWVzdDoge31cbiAgcmVzcG9uc2U6IHt9XG4gIGNsaWVudDogbnVsbFxuICBjb25zdHJ1Y3RvcjogKGlkLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgIGh0dHBNZXRob2QsXG4gICAgICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzLFxuICAgICAgICAgICAgICAgIHBhcmFtZXRlck9yZGVyLFxuICAgICAgICAgICAgICAgIHJlcSxcbiAgICAgICAgICAgICAgICByZXNwb25zZSxcbiAgICAgICAgICAgICAgICBjbGllbnQpIC0+XG4gICAgdGhpcy5pZCA9IGlkXG4gICAgdGhpcy5kZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uXG4gICAgdGhpcy5odHRwTWV0aG9kID0gaHR0cE1ldGhvZFxuICAgIHRoaXMucGF0aCA9IHBhdGhcbiAgICB0aGlzLnBhcmFtZXRlcnMgPSBwYXJhbWV0ZXJzXG4gICAgdGhpcy5wYXJhbWV0ZXJPcmRlciA9IHBhcmFtZXRlck9yZGVyXG4gICAgdGhpcy5yZXF1ZXN0ID0gcmVxXG4gICAgdGhpcy5yZXNwb25zZSA9IHJlc3BvbnNlXG4gICAgdGhpcy5jbGllbnQgPSBjbGllbnRcbiAgICBpZiBub3QgaHR0cE1ldGhvZCBvciB0eXBlb2YgaHR0cE1ldGhvZCBpc250IFwic3RyaW5nXCJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkh0dHAgbWV0aG9kIG5vdCBwcm92aWRlZCBmb3IgI3tpZH1cIilcbiAgICBlbHNlXG4gICAgICB0aGlzLmh0dHBNZXRob2QgPSBodHRwTWV0aG9kLnRvVXBwZXJDYXNlKClcbiAgICBpZiBub3QgcGF0aCBvciB0eXBlb2YgcGF0aCBpc250IFwic3RyaW5nXCJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhdGggbm90IHByb3ZpZGVkIGZvciAje2lkfVwiKVxuICAjIyMqXG4gIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXNcbiAgQHJldHVybnMge1Byb21pc2V9XG4gICMjI1xuICBjYWxsTWV0aG9kOiAocGFyYW1zKSAtPlxuICAgIGRlZmVycmVkID0gUS5kZWZlcigpXG4gICAgdHJ5XG4gICAgICAjIFdyYXAgdGhlIHdob2xlIGZ1bmN0aW9uIG9yIGl0IGlzIGp1c3RcbiAgICAgICMgQmxvYXRlZCB3aXRoIHRyeSBjYXRjaGVzXG4gICAgICB0aGlzLl9jYWxsTWV0aG9kKHBhcmFtcywgZGVmZXJyZWQpXG4gICAgY2F0Y2ggZXJyXG4gICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKVxuICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlXG4gIF9jYWxsTWV0aG9kOiAocGFyYW1zLCBkZWZlcnJlZCkgLT5cbiAgICBwYXJhbXMgPSBwYXJhbXMgb3Ige31cbiAgICBpZiBub3QgXy5pc1BsYWluT2JqZWN0KHBhcmFtcylcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJQYXJhbXMgaXMgZXhwZWN0ZWQgdG8gYmUgYW4gT2JqZWN0XCIpXG4gICAgcGFyYW1zID0gdGhpcy5fZ3JvdXBWYWx1ZShwYXJhbXMpXG4gICAgdGhpcy5fY2hlY2tSZXF1aXJlZChwYXJhbXMpXG4gICAgIyB0dXJuIHRoZSBxdWVyeSBzdHJpbmcgaW50byBrZXkgdmFsdWUgcGFpcnNcbiAgICBwYXJhbXMgPSBfLnRyYW5zZm9ybShwYXJhbXMsIChyZXN1bHQsIHZhbHVlLCBrZXkpIC0+XG4gICAgICByZXN1bHRba2V5XSA9IHZhbHVlLnZhbHVlXG4gICAgKVxuICAgIHRoaXMuX2RvUmVxdWVzdChwYXJhbXMsIG51bGwsIGRlZmVycmVkKVxuICBfZG9SZXF1ZXN0OiAocGFyYW1zLCByZXF1ZXN0Qm9keSwgZGVmZXJyZWQsIHByZXZpb3VzUmVxdWVzdCkgLT5cbiAgICBjdXJyZW50UmVxdWVzdCA9IG51bGxcbiAgICBpZiBub3QgcHJldmlvdXNSZXF1ZXN0XG4gICAgICBjdXJyZW50UmVxdWVzdCA9XG4gICAgICAgIHVybDogXCIje3RoaXMuY2xpZW50LmVuZHBvaW50fSN7dGhpcy5jbGllbnQuYmFzZVBhdGh9I3t0aGlzLnBhdGh9XCJcbiAgICAgICAgIyBXaWxsIHNldCBjb250ZW50L3R5cGUgdG8gYXBwbGljYXRpb24vanNvblxuICAgICAgICBqc29uOiByZXF1ZXN0Qm9keVxuICAgICAgICBxczogcGFyYW1zXG4gICAgICAgIG1ldGhvZDogdGhpcy5odHRwTWV0aG9kXG4gICAgZWxzZVxuICAgICAgY3VycmVudFJlcXVlc3QgPSBwcmV2aW91c1JlcXVlc3RcbiAgICBtZXRob2QgPSB0aGlzXG4gICAgcmVxdWVzdChjdXJyZW50UmVxdWVzdCwgKGVycm9yLCByZXNwb25zZSwgYm9keSkgLT5cbiAgICAgIG1ldGhvZC5fb25SZXNwb25zZShlcnJvciwgcmVzcG9uc2UsIGJvZHksIGRlZmVycmVkLCBjdXJyZW50UmVxdWVzdClcbiAgICApXG4gIF9vblJlc3BvbnNlOiAoZXJyLCByZXNwb25zZSwgYm9keSwgZGVmZXJyZWQsIGN1cnJlbnRSZXF1ZXN0KSAtPlxuICAgIGlmIG5vdCBlcnIgYW5kIChyZXNwb25zZS5zdGF0dXNDb2RlIDwgMjAwIG9yIHJlc3BvbnNlLnN0YXR1c0NvZGUgPj0gMzAwKVxuICAgICAgIyBUT0RPIEltcGxlbWVudCByZWRpcmVjdGlvbiAzMDEsIDMwMlssIDMwM10sIDMwNFxuICAgICAgZXJyID0gbmV3IEVycm9yKFwiU3RhdHVzIGNvZGUgcmV0dXJuZWQgI3tyZXNwb25zZS5zdGF0dXNDb2RlfVwiKVxuICAgIGlmIGVyclxuICAgICAgZGVmZXJyZWQucmVqZWN0KGVycilcbiAgICAgIHJldHVyblxuICAgIGlmIG5vdCBib2R5IGFuZCB0aGlzLmh0dHBNZXRob2QgaXNudCBcIkdFVFwiXG4gICAgICBkZWZlcnJlZC5yZXNvbHZlKClcbiAgICAgIHJldHVyblxuICAgIGVsc2UgaWYgbm90IGJvZHlcbiAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoXCJObyBib2R5XCIpKVxuICAgICAgcmV0dXJuXG4gICAganNvbkJvZHkgPSBudWxsXG4gICAgdHJ5XG4gICAgICBqc29uQm9keSA9IEpTT04ucGFyc2UoYm9keSlcbiAgICBjYXRjaCBlcnJcbiAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpXG4gICAgICByZXR1cm5cbiAgICBpZiB0aGlzLnJlc3BvbnNlIGluc3RhbmNlb2YgT2JqZWN0IGFuZCB0aGlzLnJlc3BvbnNlLiRyZWZcbiAgICAgIHRoaXMuX3Jlc29sdmVXaXRoU2NoZW1hUmVzcG9uc2UoanNvbkJvZHksIGRlZmVycmVkLCBjdXJyZW50UmVxdWVzdClcbiAgICBlbHNlXG4gICAgICBkZWZlcnJlZC5yZXNvbHZlKGpzb25Cb2R5KVxuICBfcmVzb2x2ZVdpdGhTY2hlbWFSZXNwb25zZTogKGpzb25Cb2R5LCBkZWZlcnJlZCwgY3VycmVudFJlcXVlc3QpIC0+XG4gICAgc2NoZW1hID0gdGhpcy5jbGllbnQuZ2V0U2NoZW1hKHRoaXMucmVzcG9uc2UuJHJlZilcbiAgICAjIE5vIHNjaGVtYSwgbm8gY2hlY2tcbiAgICBpZiBub3Qgc2NoZW1hXG4gICAgICByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZShqc29uQm9keSlcbiAgICAjIElmIHJlc3BvbnNlIHNob3VsZCBuZXZlciBjb250YWluIG5leHRQYWdlVG9rZW5cbiAgICBpZiBub3Qgc2NoZW1hLnByb3BlcnRpZXNbXCJuZXh0UGFnZVRva2VuXCJdXG4gICAgICByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZShqc29uQm9keSlcbiAgICAjIFRoZXJlIHNob3VsZCBiZSBvbmUgb3RoZXIgcHJvcGVydHkgb2YgdHlwZSBhcnJheVxuICAgIGtleSA9IG51bGxcbiAgICBmb3IgdGVzdEtleSBvZiBzY2hlbWEucHJvcGVydGllc1xuICAgICAgaWYgbm90IHNjaGVtYS5wcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KHRlc3RLZXkpXG4gICAgICAgIGNvbnRpbnVlXG4gICAgICBpZiB0ZXN0S2V5IGlzbnQgXCJuZXh0UGFnZVRva2VuXCJcbiAgICAgICAga2V5ID0gdGVzdEtleVxuICAgIGlmIG5vdCBrZXlcbiAgICAgIHJldHVybiBkZWZlcnJlZC5yZXNvbHZlKGpzb25Cb2R5KVxuICAgIGlmIHNjaGVtYS5wcm9wZXJ0aWVzW2tleV0udHlwZSBpc250IFwiYXJyYXlcIlxuICAgICAgIyBUT0RPIGltcGxlbWVudCBmb3Igb2JqZWN0c1xuICAgICAgcmV0dXJuIGRlZmVycmVkLnJlc29sdmUoanNvbkJvZHkpXG4gICAgIyBUaGlzIHNob3VsZCBiZSBhbiBhcnJheVxuICAgIHZhbHVlcyA9IGpzb25Cb2R5W2tleV1cbiAgICAjIElmIG5vdCB0aHJvdyBpdCBhd2F5XG4gICAgaWYgbm90IF8uaXNBcnJheSh2YWx1ZXMpXG4gICAgICByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZShqc29uQm9keSlcbiAgICBpZiBub3QganNvbkJvZHlbXCJuZXh0UGFnZVRva2VuXCJdXG4gICAgICAjIE9ubHkgcmV0dXJuIHRvIHRoZSB1c2VyIHRoZSB2YWx1ZXNcbiAgICAgIHJldHVybiBkZWZlcnJlZC5yZXNvbHZlKHZhbHVlcylcbiAgICAjIE1vZGlmeSB0aGUgZXhpc3RpbmcgcXVlcnkgc3RyaW5nIG9yIGNyZWF0ZSBpdFxuICAgIGN1cnJlbnRSZXF1ZXN0LnFzID0gY3VycmVudFJlcXVlc3QucXMgb3Ige31cbiAgICBjdXJyZW50UmVxdWVzdC5xc1tcIm5leHRQYWdlVG9rZW5cIl0gPSBqc29uQm9keVtcIm5leHRQYWdlVG9rZW5cIl1cbiAgICBjaGlsZERlZmVycmVkID0gUS5kZWZlcigpXG4gICAgdGhpcy5fZG9SZXF1ZXN0KG51bGwsIG51bGwsIGNoaWxkRGVmZXJyZWQsIGN1cnJlbnRSZXF1ZXN0KVxuICAgIGNoaWxkRGVmZXJyZWQucHJvbWlzZS50aGVuKChjaGlsZFZhbHVlcykgLT5cbiAgICAgIGRlZmVycmVkLnJlc29sdmUodmFsdWVzLmNvbmNhdChjaGlsZFZhbHVlcykpXG4gICAgKS5mYWlsKCAtPlxuICAgICAgIyBUT0RPIGRvIHNvbWV0aGluZyBpbiB0aGlzIGNhc2Ugd2hlcmUgdGhlIG5leHQgcGFnZVxuICAgICAgIyBmYWlscywgZm9yIG5vdyByZXR1cm5cbiAgICAgIGRlZmVycmVkLnJlc29sdmUodmFsdWVzKVxuICAgIClcblxuICBfZ3JvdXBWYWx1ZTogKHBhcmFtcykgLT5cbiAgICBwYXJhbXMgPSBfLm1lcmdlKHRoaXMucGFyYW1ldGVycywgcGFyYW1zLCAoYSwgYikgLT5cbiAgICAgIGEgPSBfLmNsb25lKGEpXG4gICAgICBpZiBub3QgYlxuICAgICAgICByZXR1cm4gYVxuICAgICAgaWYgYS50eXBlIGlzIFwic3RyaW5nXCIgYW5kIHR5cGVvZiBiIGlzbnQgXCJzdHJpbmdcIlxuICAgICAgICBiID0gYi50b1N0cmluZygpXG4gICAgICBpZiBEaXNjb3ZlcnlTY2hlbWEuY2hlY2tUeXBlKGIsIGEudHlwZSlcbiAgICAgICAgYS52YWx1ZSA9IGJcbiAgICAgIGVsc2VcbiAgICAgICAgaWYgdHlwZW9mIGIgaXMgXCJzdHJpbmdcIlxuICAgICAgICAgIGIgPSBcIicje2J9J1wiXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCIje2J9IGlzIG5vdCB0eXBlb2YgI3thLnR5cGV9XCIpXG4gICAgICBhLnZhbHVlID0gYlxuICAgICAgcmV0dXJuIGFcbiAgICApXG4gIF9jaGVja1JlcXVpcmVkOiAocGFyYW1zKSAtPlxuICAgIGZvciBrZXkgb2YgcGFyYW1zXG4gICAgICB2YWwgPSBwYXJhbXNba2V5XVxuICAgICAgaWYgbm90IHZhbC5yZXF1aXJlZFxuICAgICAgICBjb250aW51ZVxuICAgICAgaWYgbm90IHZhbC52YWx1ZVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJ0aGUgcGFyYW1ldGVyICN7a2V5fSBpcyByZXF1aXJlZFwiKVxuXG5cbm1vZHVsZS5leHBvcnRzID0gRGlzY292ZXJ5TWV0aG9kIl19