var DiscoverySchema, schema, _;

schema = require("schemajs");

_ = require("lodash");

DiscoverySchema = (function() {
  DiscoverySchema.prototype.id = "";

  DiscoverySchema.prototype.type = "";

  DiscoverySchema.prototype.properties = {};

  DiscoverySchema.prototype.schema = null;

  DiscoverySchema.prototype.schemaOptions = null;

  DiscoverySchema.prototype.client = null;


  /**
  * @param {string} id
  * @param {string} type
  * @param {Object} properties
   */

  function DiscoverySchema(id, type, properties, client) {
    this.id = id;
    this.type = type;
    this.properties = properties;
    this.client = client;
    if (!type) {
      throw new Error("Type is required");
    }
  }

  DiscoverySchema.prototype.validate = function(value) {
    var reason, validation, values;
    if (value === null || value === void 0) {
      return {
        valid: false,
        value: value,
        reason: "Value is null or undefined"
      };
    }
    if (this.type === "string" && typeof value !== string) {
      value = JSON.parse(value);
    }
    if (DiscoverySchema.checkType(value, this.type)) {
      return {
        valid: false,
        value: value,
        reason: "Type of value isn't " + this.type
      };
    }
    if (this.type === "object") {
      validation = this._validateSchema(value);
      if (validation.valid) {
        return {
          valid: true,
          value: validation.data
        };
      } else {
        values = _.values(validation.errors);
        reason = "request is not valid";
        if (values.length) {
          reason = values[0];
        }
        return {
          valid: false,
          value: value,
          reason: reason
        };
      }
    } else {
      return {
        valid: true,
        value: value
      };
    }
  };

  DiscoverySchema.checkType = function(value, type) {
    switch (type) {
      case "array":
        return _.isArray(value);
      case "object":
        return _.isPlainObject(value);
      case "string":
        return _.isString(value);
      case "integer":
        if (!_.isNumber(value)) {
          return false;
        }
        return value === parseInt(value);
      case "number":
        return _.isNumber(value);
      case "boolean":
        return _.isBoolean(value);
      case "any":
        return true;
      default:
        return false;
    }
  };

  DiscoverySchema.prototype._validateSchema = function(value) {
    this._generateSchema();
    return this.schema.validate(value);
  };

  DiscoverySchema.prototype._generateSchema = function() {
    if (!schema.types.any) {
      schema.types.any = function() {
        return true;
      };
    }
    return this.schema = this.schema || schema.create(this._generateSchemaOptions());
  };

  DiscoverySchema.prototype._generateSchemaOptions = function() {
    var key, options, property, ref, type, _i, _len, _ref;
    if (this.schemaOptions) {
      return this.schemaOptions;
    }
    options = {};
    _ref = this.properties;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      key = _ref[_i];
      if (!this.properties.hasOwnProperty(key)) {
        continue;
      }
      property = this.properties[key];
      if (property.type === "array") {
        options[key] = {
          type: "array",
          required: !!property.required
        };
        if (!(property.items instanceof Object)) {
          continue;
        }
        if (!property.items.$ref) {
          continue;
        }
        ref = property.items.$ref;
        schema = this.client.getSchema(ref);
        if (!schema || schema === this) {
          continue;
        }
        options[key].schema = this.client.getSchema(ref)._generateSchemaOptions();
      } else if (property.type === "object") {
        options[key] = {
          type: "object",
          required: !!property.required
        };
        if (!property.$ref) {
          continue;
        }
        ref = property.$ref;
        schema = this.client.getSchema(ref);
        if (!schema || schema === this) {
          continue;
        }
        options[key].schema = this.client.getSchema(ref)._generateSchemaOptions();
      } else {
        type = null;
        if (property.type === "integer") {
          type = "int";
        } else {
          type = property.type;
        }
        options[key] = {
          type: type,
          required: !!property.required
        };
      }
    }
    return this.schemaOptions = options;
  };

  return DiscoverySchema;

})();

module.exports = DiscoverySchema;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsZWV0L2Rpc2NvdmVyeS9zY2hlbWEuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsMEJBQUE7O0FBQUEsTUFBQSxHQUFVLE9BQUEsQ0FBUSxVQUFSLENBQVYsQ0FBQTs7QUFBQSxDQUNBLEdBQVUsT0FBQSxDQUFRLFFBQVIsQ0FEVixDQUFBOztBQUFBO0FBR0UsNEJBQUEsRUFBQSxHQUFJLEVBQUosQ0FBQTs7QUFBQSw0QkFDQSxJQUFBLEdBQU0sRUFETixDQUFBOztBQUFBLDRCQUVBLFVBQUEsR0FBWSxFQUZaLENBQUE7O0FBQUEsNEJBR0EsTUFBQSxHQUFRLElBSFIsQ0FBQTs7QUFBQSw0QkFJQSxhQUFBLEdBQWUsSUFKZixDQUFBOztBQUFBLDRCQUtBLE1BQUEsR0FBUSxJQUxSLENBQUE7O0FBTUE7QUFBQTs7OztLQU5BOztBQVdhLEVBQUEseUJBQUMsRUFBRCxFQUFLLElBQUwsRUFBVyxVQUFYLEVBQXVCLE1BQXZCLEdBQUE7QUFDWCxJQUFBLElBQUksQ0FBQyxFQUFMLEdBQVUsRUFBVixDQUFBO0FBQUEsSUFDQSxJQUFJLENBQUMsSUFBTCxHQUFZLElBRFosQ0FBQTtBQUFBLElBRUEsSUFBSSxDQUFDLFVBQUwsR0FBa0IsVUFGbEIsQ0FBQTtBQUFBLElBR0EsSUFBSSxDQUFDLE1BQUwsR0FBYyxNQUhkLENBQUE7QUFJQSxJQUFBLElBQUcsQ0FBQSxJQUFIO0FBRUUsWUFBVSxJQUFBLEtBQUEsQ0FBTSxrQkFBTixDQUFWLENBRkY7S0FMVztFQUFBLENBWGI7O0FBQUEsNEJBbUJBLFFBQUEsR0FBVSxTQUFDLEtBQUQsR0FBQTtBQUNSLFFBQUEsMEJBQUE7QUFBQSxJQUFBLElBQUcsS0FBQSxLQUFTLElBQVQsSUFBaUIsS0FBQSxLQUFTLE1BQTdCO0FBQ0UsYUFBTztBQUFBLFFBQ0wsS0FBQSxFQUFPLEtBREY7QUFBQSxRQUVMLEtBQUEsRUFBTyxLQUZGO0FBQUEsUUFHTCxNQUFBLEVBQVEsNEJBSEg7T0FBUCxDQURGO0tB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UUExREM7RUFBQSxDQXJGeEIsQ0FBQTs7eUJBQUE7O0lBSEYsQ0FBQTs7QUFBQSxNQW9KTSxDQUFDLE9BQVAsR0FBaUIsZUFwSmpCLENBQUEiLCJmaWxlIjoiZmxlZXQvZGlzY292ZXJ5L3NjaGVtYS5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbInNjaGVtYSAgPSByZXF1aXJlKFwic2NoZW1hanNcIilcbl8gICAgICAgPSByZXF1aXJlKFwibG9kYXNoXCIpXG5jbGFzcyBEaXNjb3ZlcnlTY2hlbWFcbiAgaWQ6IFwiXCJcbiAgdHlwZTogXCJcIlxuICBwcm9wZXJ0aWVzOiB7fVxuICBzY2hlbWE6IG51bGxcbiAgc2NoZW1hT3B0aW9uczogbnVsbFxuICBjbGllbnQ6IG51bGxcbiAgIyMjKlxuICAqIEBwYXJhbSB7c3RyaW5nfSBpZFxuICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlXG4gICogQHBhcmFtIHtPYmplY3R9IHByb3BlcnRpZXNcbiAgIyMjXG4gIGNvbnN0cnVjdG9yOiAoaWQsIHR5cGUsIHByb3BlcnRpZXMsIGNsaWVudCkgLT5cbiAgICB0aGlzLmlkID0gaWRcbiAgICB0aGlzLnR5cGUgPSB0eXBlXG4gICAgdGhpcy5wcm9wZXJ0aWVzID0gcHJvcGVydGllc1xuICAgIHRoaXMuY2xpZW50ID0gY2xpZW50XG4gICAgaWYgbm90IHR5cGVcbiAgICAgICMgV2UgdXNlIHR5cGUgZm9yIHZhbGlkYXRpb25cbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlR5cGUgaXMgcmVxdWlyZWRcIilcbiAgdmFsaWRhdGU6ICh2YWx1ZSkgLT5cbiAgICBpZiB2YWx1ZSBpcyBudWxsIG9yIHZhbHVlIGlzIHVuZGVmaW5lZFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlXG4gICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICByZWFzb246IFwiVmFsdWUgaXMgbnVsbCBvciB1bmRlZmluZWRcIlxuICAgICAgfVxuICAgIGlmIHRoaXMudHlwZSBpcyBcInN0cmluZ1wiIGFuZCB0eXBlb2YgdmFsdWUgaXNudCBzdHJpbmdcbiAgICAgIHZhbHVlID0gSlNPTi5wYXJzZSh2YWx1ZSlcbiAgICBpZiBEaXNjb3ZlcnlTY2hlbWEuY2hlY2tUeXBlKHZhbHVlLCB0aGlzLnR5cGUpXG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZDogZmFsc2VcbiAgICAgICAgdmFsdWU6IHZhbHVlXG4gICAgICAgIHJlYXNvbjogXCJUeXBlIG9mIHZhbHVlIGlzbid0ICN7dGhpcy50eXBlfVwiXG4gICAgICB9XG4gICAgaWYgdGhpcy50eXBlIGlzIFwib2JqZWN0XCJcbiAgICAgIHZhbGlkYXRpb24gPSB0aGlzLl92YWxpZGF0ZVNjaGVtYSh2YWx1ZSlcbiAgICAgIGlmIHZhbGlkYXRpb24udmFsaWRcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB2YWxpZDogdHJ1ZVxuICAgICAgICAgIHZhbHVlOiB2YWxpZGF0aW9uLmRhdGFcbiAgICAgICAgfVxuICAgICAgZWxzZVxuICAgICAgICB2YWx1ZXMgPSBfLnZhbHVlcyh2YWxpZGF0aW9uLmVycm9ycylcbiAgICAgICAgcmVhc29uID0gXCJyZXF1ZXN0IGlzIG5vdCB2YWxpZFwiXG4gICAgICAgIGlmIHZhbHVlcy5sZW5ndGhcbiAgICAgICAgICByZWFzb24gPSB2YWx1ZXNbMF1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB2YWxpZDogZmFsc2VcbiAgICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgICByZWFzb246IHJlYXNvblxuICAgICAgICB9XG4gICAgZWxzZVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IHRydWVcbiAgICAgICAgdmFsdWU6IHZhbHVlXG4gICAgICB9XG4gIEBjaGVja1R5cGU6ICh2YWx1ZSwgdHlwZSkgLT5cbiAgICAjIFZhbGlkIHR5cGVzXG4gICAgIyBodHRwOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9kcmFmdC16eXAtanNvbi1zY2hlbWEtMDMjc2VjdGlvbi01LjFcbiAgICBzd2l0Y2ggdHlwZVxuICAgICAgd2hlbiBcImFycmF5XCJcbiAgICAgICAgXy5pc0FycmF5KCB2YWx1ZSApXG4gICAgICB3aGVuIFwib2JqZWN0XCJcbiAgICAgICAgXy5pc1BsYWluT2JqZWN0KCB2YWx1ZSApXG4gICAgICB3aGVuIFwic3RyaW5nXCJcbiAgICAgICAgXy5pc1N0cmluZyggdmFsdWUgKVxuICAgICAgd2hlbiBcImludGVnZXJcIlxuICAgICAgICByZXR1cm4gZmFsc2UgaWYgbm90IF8uaXNOdW1iZXIoIHZhbHVlIClcbiAgICAgICAgdmFsdWUgaXMgcGFyc2VJbnQoIHZhbHVlIClcbiAgICAgIHdoZW4gXCJudW1iZXJcIlxuICAgICAgICBfLmlzTnVtYmVyKHZhbHVlKVxuICAgICAgd2hlbiBcImJvb2xlYW5cIlxuICAgICAgICBfLmlzQm9vbGVhbih2YWx1ZSlcbiAgICAgIHdoZW4gXCJhbnlcIlxuICAgICAgICB0cnVlXG4gICAgICBlbHNlXG4gICAgICAgIGZhbHNlXG4gIF92YWxpZGF0ZVNjaGVtYTogKHZhbHVlKSAtPlxuICAgIHRoaXMuX2dlbmVyYXRlU2NoZW1hKClcbiAgICByZXR1cm4gdGhpcy5zY2hlbWEudmFsaWRhdGUodmFsdWUpXG4gIF9nZW5lcmF0ZVNjaGVtYTogLT5cbiAgICBpZiBub3Qgc2NoZW1hLnR5cGVzLmFueVxuICAgICAgc2NoZW1hLnR5cGVzLmFueSA9IC0+XG4gICAgICAgIHRydWVcbiAgICB0aGlzLnNjaGVtYSA9IHRoaXMuc2NoZW1hIG9yIHNjaGVtYS5jcmVhdGUodGhpcy5fZ2VuZXJhdGVTY2hlbWFPcHRpb25zKCkpXG4gIF9nZW5lcmF0ZVNjaGVtYU9wdGlvbnM6IC0+XG4gICAgaWYgdGhpcy5zY2hlbWFPcHRpb25zXG4gICAgICByZXR1cm4gdGhpcy5zY2hlbWFPcHRpb25zXG4gICAgb3B0aW9ucyA9IHt9XG4gICAgZm9yIGtleSBpbiB0aGlzLnByb3BlcnRpZXNcbiAgICAgIGlmIG5vdCB0aGlzLnByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoa2V5KVxuICAgICAgICBjb250aW51ZVxuICAgICAgcHJvcGVydHkgPSB0aGlzLnByb3BlcnRpZXNba2V5XVxuICAgICAgaWYgcHJvcGVydHkudHlwZSBpcyBcImFycmF5XCJcbiAgICAgICAgb3B0aW9uc1trZXldID0ge1xuICAgICAgICAgIHR5cGU6IFwiYXJyYXlcIixcbiAgICAgICAgICByZXF1aXJlZDogISFwcm9wZXJ0eS5yZXF1aXJlZFxuICAgICAgICB9XG4gICAgICAgIGlmIHByb3BlcnR5Lml0ZW1zIG5vdCBpbnN0YW5jZW9mIE9iamVjdFxuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIGlmIG5vdCBwcm9wZXJ0eS5pdGVtcy4kcmVmXG4gICAgICAgICAgIyBUT0RPIGltcGxlbWVudCBvdGhlciB0aGFuICRyZWZcbiAgICAgICAgICAjIEZsZWV0IEFQSSBvbmx5IHVzZXMgJHJlZiBjdXJyZW50bHlcbiAgICAgICAgICBjb250aW51ZVxuICAgICAgICByZWYgPSBwcm9wZXJ0eS5pdGVtcy4kcmVmXG4gICAgICAgIHNjaGVtYSA9IHRoaXMuY2xpZW50LmdldFNjaGVtYShyZWYpXG4gICAgICAgICMgV2UgZG9uJ3Qgd2FudCBjaXJjdWxhciByZWZlcmVuY2VzXG4gICAgICAgIGlmIG5vdCBzY2hlbWEgb3Igc2NoZW1hIGlzIHRoaXNcbiAgICAgICAgICBjb250aW51ZVxuICAgICAgICBvcHRpb25zW2tleV0uc2NoZW1hID0gdGhpc1xuICAgICAgICAgIC5jbGllbnRcbiAgICAgICAgICAuZ2V0U2NoZW1hKHJlZilcbiAgICAgICAgICAuX2dlbmVyYXRlU2NoZW1hT3B0aW9ucygpXG4gICAgICBlbHNlIGlmIHByb3BlcnR5LnR5cGUgaXMgXCJvYmplY3RcIlxuICAgICAgICBvcHRpb25zW2tleV0gPSB7XG4gICAgICAgICAgdHlwZTogXCJvYmplY3RcIixcbiAgICAgICAgICByZXF1aXJlZDogISFwcm9wZXJ0eS5yZXF1aXJlZFxuICAgICAgICB9XG4gICAgICAgIGlmIG5vdCBwcm9wZXJ0eS4kcmVmXG4gICAgICAgICAgIyBUT0RPIGltcGxlbWVudCBvdGhlciB0aGFuICRyZWZcbiAgICAgICAgICBjb250aW51ZVxuICAgICAgICByZWYgPSBwcm9wZXJ0eS4kcmVmXG4gICAgICAgIHNjaGVtYSA9IHRoaXMuY2xpZW50LmdldFNjaGVtYShyZWYpXG4gICAgICAgICMgV2UgZG9uJ3Qgd2FudCBjaXJjdWxhciByZWZlcmVuY2VzXG4gICAgICAgIGlmIG5vdCBzY2hlbWEgb3Igc2NoZW1hIGlzIHRoaXNcbiAgICAgICAgICBjb250aW51ZVxuICAgICAgICBvcHRpb25zW2tleV0uc2NoZW1hID0gdGhpc1xuICAgICAgICAgIC5jbGllbnRcbiAgICAgICAgICAuZ2V0U2NoZW1hKHJlZilcbiAgICAgICAgICAuX2dlbmVyYXRlU2NoZW1hT3B0aW9ucygpXG4gICAgICBlbHNlXG4gICAgICAgIHR5cGUgPSBudWxsXG4gICAgICAgICMgXCJpbnRlZ2VyXCIgaXMgdGhlIG9ubHkgdHlwZSB0aGF0IGlzIGRpZmZlcmVudFxuICAgICAgICAjIGh0dHBzOi8vZ2l0aHViLmNvbS9lbGVpdGgvc2NoZW1hanMjc2NoZW1hdHlwZXNcbiAgICAgICAgIyBJIGhhdmUgZXh0ZW5kZWQgc2NoZW1hIHRvIGFjY2VwdCB0eXBlIFwiYW55XCJcbiAgICAgICAgaWYgcHJvcGVydHkudHlwZSBpcyBcImludGVnZXJcIlxuICAgICAgICAgIHR5cGUgPSBcImludFwiXG4gICAgICAgIGVsc2VcbiAgICAgICAgICB0eXBlID0gcHJvcGVydHkudHlwZVxuICAgICAgICBvcHRpb25zW2tleV0gPSB7XG4gICAgICAgICAgdHlwZTogdHlwZSxcbiAgICAgICAgICByZXF1aXJlZDogISFwcm9wZXJ0eS5yZXF1aXJlZFxuICAgICAgICB9XG4gICAgdGhpcy5zY2hlbWFPcHRpb25zID0gb3B0aW9uc1xuXG5tb2R1bGUuZXhwb3J0cyA9IERpc2NvdmVyeVNjaGVtYSJdfQ==