var DiscoverySchema, schema;

schema = require("schemajs");

DiscoverySchema = (function() {
  DiscoverySchema.prototype.id = "";

  DiscoverySchema.prototype.type = "";

  DiscoverySchema.prototype.properties = {};

  DiscoverySchema.prototype.schema = null;

  DiscoverySchema.prototype.schemaOptions = null;

  DiscoverySchema.prototype.client = null;


  /**
  * @param {string} id
  * @param {string} type
  * @param {Object} properties
   */

  function DiscoverySchema(id, type, properties, client) {
    this.id = id;
    this.type = type;
    this.properties = properties;
    this.client = client;
  }

  DiscoverySchema.prototype.validate = function(value) {
    var reason, validation, values;
    if (value === null || value === void 0) {
      return {
        valid: false,
        value: value,
        reason: "Value is null or undefined"
      };
    }
    if (this.type === "string" && typeof value !== string) {
      value = JSON.parse(value);
    }
    if (this._checkType(value, this.type)) {
      return {
        valid: false,
        value: value,
        reason: "Type of value isn't " + this.type
      };
    }
    if (this.type === "object") {
      validation = this._validateSchema(value);
      if (validation.valid) {
        return {
          valid: true,
          value: validation.data
        };
      } else {
        values = _.values(validation.errors);
        reason = "request is not valid";
        if (values.length) {
          reason = values[0];
        }
        return {
          valid: false,
          value: value,
          reason: reason
        };
      }
    } else {
      return {
        valid: true,
        value: value
      };
    }
  };

  DiscoverySchema.prototype._checkType = function(value, type) {
    switch (type) {
      case "array":
        return _.isArray(value);
      case "object":
        return _.isPlainObject(value);
      case "string":
        return _.isString(value);
      case "integer":
        if (!_.isNumber(value)) {
          return false;
        }
        return value === parseInt(value);
      case "number":
        return _.isNumber(value);
      case "boolean":
        return _.isBoolean(value);
      case "any":
        return true;
      default:
        return false;
    }
  };

  DiscoverySchema.prototype._validateSchema = function(value) {
    this._generateSchema();
    return this.schema.validate(value);
  };

  DiscoverySchema.prototype._generateSchema = function() {
    if (!schema.types.any) {
      schema.types.any = function() {
        return true;
      };
    }
    return this.schema = this.schema || schema.create(this._generateSchemaOptions());
  };

  DiscoverySchema.prototype._generateSchemaOptions = function() {
    var key, options, property, ref, type, _i, _len, _ref;
    if (this.schemaOptions) {
      return this.schemaOptions;
    }
    options = {};
    _ref = this.properties;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      key = _ref[_i];
      if (!this.properties.hasOwnProperty(key)) {
        continue;
      }
      property = this.properties[key];
      if (property.type === "array") {
        options[key] = {
          type: "array",
          required: !!property.required
        };
        if (!(property.items instanceof Object)) {
          continue;
        }
        if (!property.items.$ref) {
          continue;
        }
        ref = property.items.$ref;
        schema = this.client.getSchema(ref);
        if (!schema || schema === this) {
          continue;
        }
        options[key].schema = this.client.getSchema(ref)._generateSchemaOptions();
      } else if (property.type === "object") {
        options[key] = {
          type: "object",
          required: !!property.required
        };
        if (!property.$ref) {
          continue;
        }
        ref = property.$ref;
        schema = this.client.getSchema(ref);
        if (!schema || schema === this) {
          continue;
        }
        options[key].schema = this.client.getSchema(ref)._generateSchemaOptions();
      } else {
        type = null;
        if (property.type === "integer") {
          type = "int";
        } else {
          type = property.type;
        }
        options[key] = {
          type: type,
          required: !!property.required
        };
      }
    }
    return this.schemaOptions = options;
  };

  return DiscoverySchema;

})();

module.exports = DiscoverySchema;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsZWV0L2Rpc2NvdmVyeS9zY2hlbWEuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsdUJBQUE7O0FBQUEsTUFBQSxHQUFTLE9BQUEsQ0FBUSxVQUFSLENBQVQsQ0FBQTs7QUFBQTtBQUdFLDRCQUFBLEVBQUEsR0FBSSxFQUFKLENBQUE7O0FBQUEsNEJBQ0EsSUFBQSxHQUFNLEVBRE4sQ0FBQTs7QUFBQSw0QkFFQSxVQUFBLEdBQVksRUFGWixDQUFBOztBQUFBLDRCQUdBLE1BQUEsR0FBUSxJQUhSLENBQUE7O0FBQUEsNEJBSUEsYUFBQSxHQUFlLElBSmYsQ0FBQTs7QUFBQSw0QkFLQSxNQUFBLEdBQVEsSUFMUixDQUFBOztBQU1BO0FBQUE7Ozs7S0FOQTs7QUFXYSxFQUFBLHlCQUFDLEVBQUQsRUFBSyxJQUFMLEVBQVcsVUFBWCxFQUF1QixNQUF2QixHQUFBO0FBQ1gsSUFBQSxJQUFJLENBQUMsRUFBTCxHQUFVLEVBQVYsQ0FBQTtBQUFBLElBQ0EsSUFBSSxDQUFDLElBQUwsR0FBWSxJQURaLENBQUE7QUFBQSxJQUVBLElBQUksQ0FBQyxVQUFMLEdBQWtCLFVBRmxCLENBQUE7QUFBQSxJQUdBLElBQUksQ0FBQyxNQUFMLEdBQWMsTUFIZCxDQURXO0VBQUEsQ0FYYjs7QUFBQSw0QkFnQkEsUUFBQSxHQUFVLFNBQUMsS0FBRCxHQUFBO0FBQ1IsUUFBQSwwQkFBQTtBQUFBLElBQUEsSUFBRyxLQUFBLEtBQVMsSUFBVCxJQUFpQixLQUFBLEtBQVMsTUFBN0I7QUFDRSxhQUFPO0FBQUEsUUFDTCxLQUFBLEVBQU8sS0FERjtBQUFBLFFBRUwsS0FBQSxFQUFPLEtBRkY7QUFBQSxRQUdMLE1BQUEsRUFBUSw0QkFISDtPQUFQLENBREY7S0FBQTtBQU1BLElBQUEsSUFBRyxJQUFJLENBQUMsSUFBTCxLQUFhLFFBQWIsSUFBMEIsTUFBQSxDQUFBLEtBQUEsS0FBa0IsTUFBL0M7QUFDRSxNQUFBLEtBQUEsR0FBUSxJQUFJLENBQUMsS0FBTCxD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Um9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsic2NoZW1hID0gcmVxdWlyZShcInNjaGVtYWpzXCIpXG5cbmNsYXNzIERpc2NvdmVyeVNjaGVtYVxuICBpZDogXCJcIlxuICB0eXBlOiBcIlwiXG4gIHByb3BlcnRpZXM6IHt9XG4gIHNjaGVtYTogbnVsbFxuICBzY2hlbWFPcHRpb25zOiBudWxsXG4gIGNsaWVudDogbnVsbFxuICAjIyMqXG4gICogQHBhcmFtIHtzdHJpbmd9IGlkXG4gICogQHBhcmFtIHtzdHJpbmd9IHR5cGVcbiAgKiBAcGFyYW0ge09iamVjdH0gcHJvcGVydGllc1xuICAjIyNcbiAgY29uc3RydWN0b3I6IChpZCwgdHlwZSwgcHJvcGVydGllcywgY2xpZW50KSAtPlxuICAgIHRoaXMuaWQgPSBpZFxuICAgIHRoaXMudHlwZSA9IHR5cGVcbiAgICB0aGlzLnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzXG4gICAgdGhpcy5jbGllbnQgPSBjbGllbnRcbiAgdmFsaWRhdGU6ICh2YWx1ZSkgLT5cbiAgICBpZiB2YWx1ZSBpcyBudWxsIG9yIHZhbHVlIGlzIHVuZGVmaW5lZFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlXG4gICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICByZWFzb246IFwiVmFsdWUgaXMgbnVsbCBvciB1bmRlZmluZWRcIlxuICAgICAgfVxuICAgIGlmIHRoaXMudHlwZSBpcyBcInN0cmluZ1wiIGFuZCB0eXBlb2YgdmFsdWUgaXNudCBzdHJpbmdcbiAgICAgIHZhbHVlID0gSlNPTi5wYXJzZSh2YWx1ZSlcbiAgICBpZiB0aGlzLl9jaGVja1R5cGUodmFsdWUsIHRoaXMudHlwZSlcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbGlkOiBmYWxzZVxuICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgcmVhc29uOiBcIlR5cGUgb2YgdmFsdWUgaXNuJ3QgI3t0aGlzLnR5cGV9XCJcbiAgICAgIH1cbiAgICBpZiB0aGlzLnR5cGUgaXMgXCJvYmplY3RcIlxuICAgICAgdmFsaWRhdGlvbiA9IHRoaXMuX3ZhbGlkYXRlU2NoZW1hKHZhbHVlKVxuICAgICAgaWYgdmFsaWRhdGlvbi52YWxpZFxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHZhbGlkOiB0cnVlXG4gICAgICAgICAgdmFsdWU6IHZhbGlkYXRpb24uZGF0YVxuICAgICAgICB9XG4gICAgICBlbHNlXG4gICAgICAgIHZhbHVlcyA9IF8udmFsdWVzKHZhbGlkYXRpb24uZXJyb3JzKVxuICAgICAgICByZWFzb24gPSBcInJlcXVlc3QgaXMgbm90IHZhbGlkXCJcbiAgICAgICAgaWYgdmFsdWVzLmxlbmd0aFxuICAgICAgICAgIHJlYXNvbiA9IHZhbHVlc1swXVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHZhbGlkOiBmYWxzZVxuICAgICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICAgIHJlYXNvbjogcmVhc29uXG4gICAgICAgIH1cbiAgICBlbHNlXG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZDogdHJ1ZVxuICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgIH1cbiAgX2NoZWNrVHlwZTogKHZhbHVlLCB0eXBlKSAtPlxuICAgICMgVmFsaWQgdHlwZXNcbiAgICAjIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL2RyYWZ0LXp5cC1qc29uLXNjaGVtYS0wMyNzZWN0aW9uLTUuMVxuICAgIHN3aXRjaCB0eXBlXG4gICAgICB3aGVuIFwiYXJyYXlcIlxuICAgICAgICBfLmlzQXJyYXkoIHZhbHVlIClcbiAgICAgIHdoZW4gXCJvYmplY3RcIlxuICAgICAgICBfLmlzUGxhaW5PYmplY3QoIHZhbHVlIClcbiAgICAgIHdoZW4gXCJzdHJpbmdcIlxuICAgICAgICBfLmlzU3RyaW5nKCB2YWx1ZSApXG4gICAgICB3aGVuIFwiaW50ZWdlclwiXG4gICAgICAgIHJldHVybiBmYWxzZSBpZiBub3QgXy5pc051bWJlciggdmFsdWUgKVxuICAgICAgICB2YWx1ZSBpcyBwYXJzZUludCggdmFsdWUgKVxuICAgICAgd2hlbiBcIm51bWJlclwiXG4gICAgICAgIF8uaXNOdW1iZXIodmFsdWUpXG4gICAgICB3aGVuIFwiYm9vbGVhblwiXG4gICAgICAgIF8uaXNCb29sZWFuKHZhbHVlKVxuICAgICAgd2hlbiBcImFueVwiXG4gICAgICAgIHRydWVcbiAgICAgIGVsc2VcbiAgICAgICAgZmFsc2VcbiAgX3ZhbGlkYXRlU2NoZW1hOiAodmFsdWUpIC0+XG4gICAgdGhpcy5fZ2VuZXJhdGVTY2hlbWEoKVxuICAgIHJldHVybiB0aGlzLnNjaGVtYS52YWxpZGF0ZSh2YWx1ZSlcbiAgX2dlbmVyYXRlU2NoZW1hOiAtPlxuICAgIGlmIG5vdCBzY2hlbWEudHlwZXMuYW55XG4gICAgICBzY2hlbWEudHlwZXMuYW55ID0gLT5cbiAgICAgICAgdHJ1ZVxuICAgIHRoaXMuc2NoZW1hID0gdGhpcy5zY2hlbWEgb3Igc2NoZW1hLmNyZWF0ZSh0aGlzLl9nZW5lcmF0ZVNjaGVtYU9wdGlvbnMoKSlcbiAgX2dlbmVyYXRlU2NoZW1hT3B0aW9uczogLT5cbiAgICBpZiB0aGlzLnNjaGVtYU9wdGlvbnNcbiAgICAgIHJldHVybiB0aGlzLnNjaGVtYU9wdGlvbnNcbiAgICBvcHRpb25zID0ge31cbiAgICBmb3Iga2V5IGluIHRoaXMucHJvcGVydGllc1xuICAgICAgaWYgbm90IHRoaXMucHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShrZXkpXG4gICAgICAgIGNvbnRpbnVlXG4gICAgICBwcm9wZXJ0eSA9IHRoaXMucHJvcGVydGllc1trZXldXG4gICAgICBpZiBwcm9wZXJ0eS50eXBlIGlzIFwiYXJyYXlcIlxuICAgICAgICBvcHRpb25zW2tleV0gPSB7XG4gICAgICAgICAgdHlwZTogXCJhcnJheVwiLFxuICAgICAgICAgIHJlcXVpcmVkOiAhIXByb3BlcnR5LnJlcXVpcmVkXG4gICAgICAgIH1cbiAgICAgICAgaWYgcHJvcGVydHkuaXRlbXMgbm90IGluc3RhbmNlb2YgT2JqZWN0XG4gICAgICAgICAgY29udGludWVcbiAgICAgICAgaWYgbm90IHByb3BlcnR5Lml0ZW1zLiRyZWZcbiAgICAgICAgICAjIFRPRE8gaW1wbGVtZW50IG90aGVyIHRoYW4gJHJlZlxuICAgICAgICAgICMgRmxlZXQgQVBJIG9ubHkgdXNlcyAkcmVmIGN1cnJlbnRseVxuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIHJlZiA9IHByb3BlcnR5Lml0ZW1zLiRyZWZcbiAgICAgICAgc2NoZW1hID0gdGhpcy5jbGllbnQuZ2V0U2NoZW1hKHJlZilcbiAgICAgICAgIyBXZSBkb24ndCB3YW50IGNpcmN1bGFyIHJlZmVyZW5jZXNcbiAgICAgICAgaWYgbm90IHNjaGVtYSBvciBzY2hlbWEgaXMgdGhpc1xuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIG9wdGlvbnNba2V5XS5zY2hlbWEgPSB0aGlzLmNsaWVudC5nZXRTY2hlbWEocmVmKS5fZ2VuZXJhdGVTY2hlbWFPcHRpb25zKClcbiAgICAgIGVsc2UgaWYgcHJvcGVydHkudHlwZSBpcyBcIm9iamVjdFwiXG4gICAgICAgIG9wdGlvbnNba2V5XSA9IHtcbiAgICAgICAgICB0eXBlOiBcIm9iamVjdFwiLFxuICAgICAgICAgIHJlcXVpcmVkOiAhIXByb3BlcnR5LnJlcXVpcmVkXG4gICAgICAgIH1cbiAgICAgICAgaWYgbm90IHByb3BlcnR5LiRyZWZcbiAgICAgICAgICAjIFRPRE8gaW1wbGVtZW50IG90aGVyIHRoYW4gJHJlZlxuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIHJlZiA9IHByb3BlcnR5LiRyZWZcbiAgICAgICAgc2NoZW1hID0gdGhpcy5jbGllbnQuZ2V0U2NoZW1hKHJlZilcbiAgICAgICAgIyBXZSBkb24ndCB3YW50IGNpcmN1bGFyIHJlZmVyZW5jZXNcbiAgICAgICAgaWYgbm90IHNjaGVtYSBvciBzY2hlbWEgaXMgdGhpc1xuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIG9wdGlvbnNba2V5XS5zY2hlbWEgPSB0aGlzLmNsaWVudC5nZXRTY2hlbWEocmVmKS5fZ2VuZXJhdGVTY2hlbWFPcHRpb25zKClcbiAgICAgIGVsc2VcbiAgICAgICAgdHlwZSA9IG51bGxcbiAgICAgICAgIyBcImludGVnZXJcIiBpcyB0aGUgb25seSB0eXBlIHRoYXQgaXMgZGlmZmVyZW50XG4gICAgICAgICMgaHR0cHM6Ly9naXRodWIuY29tL2VsZWl0aC9zY2hlbWFqcyNzY2hlbWF0eXBlc1xuICAgICAgICAjIEkgaGF2ZSBleHRlbmRlZCBzY2hlbWEgdG8gYWNjZXB0IHR5cGUgXCJhbnlcIlxuICAgICAgICBpZiBwcm9wZXJ0eS50eXBlIGlzIFwiaW50ZWdlclwiXG4gICAgICAgICAgdHlwZSA9IFwiaW50XCJcbiAgICAgICAgZWxzZVxuICAgICAgICAgIHR5cGUgPSBwcm9wZXJ0eS50eXBlXG4gICAgICAgIG9wdGlvbnNba2V5XSA9IHtcbiAgICAgICAgICB0eXBlOiB0eXBlLFxuICAgICAgICAgIHJlcXVpcmVkOiAhIXByb3BlcnR5LnJlcXVpcmVkXG4gICAgICAgIH1cbiAgICB0aGlzLnNjaGVtYU9wdGlvbnMgPSBvcHRpb25zXG5cbm1vZHVsZS5leHBvcnRzID0gRGlzY292ZXJ5U2NoZW1hIl19