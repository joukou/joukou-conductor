var DiscoverySchema, schema;

schema = require("schemajs");

DiscoverySchema = (function() {
  DiscoverySchema.prototype.id = "";

  DiscoverySchema.prototype.type = "";

  DiscoverySchema.prototype.properties = {};

  DiscoverySchema.prototype.schema = null;

  DiscoverySchema.prototype.schemaOptions = null;

  DiscoverySchema.prototype.client = null;


  /**
  * @param {string} id
  * @param {string} type
  * @param {Object} properties
   */

  function DiscoverySchema(id, type, properties, client) {
    this.id = id;
    this.type = type;
    this.properties = properties;
    this.client = client;
    if (!type) {
      throw new Error("Type is required");
    }
  }

  DiscoverySchema.prototype.validate = function(value) {
    var reason, validation, values;
    if (value === null || value === void 0) {
      return {
        valid: false,
        value: value,
        reason: "Value is null or undefined"
      };
    }
    if (this.type === "string" && typeof value !== string) {
      value = JSON.parse(value);
    }
    if (this._checkType(value, this.type)) {
      return {
        valid: false,
        value: value,
        reason: "Type of value isn't " + this.type
      };
    }
    if (this.type === "object") {
      validation = this._validateSchema(value);
      if (validation.valid) {
        return {
          valid: true,
          value: validation.data
        };
      } else {
        values = _.values(validation.errors);
        reason = "request is not valid";
        if (values.length) {
          reason = values[0];
        }
        return {
          valid: false,
          value: value,
          reason: reason
        };
      }
    } else {
      return {
        valid: true,
        value: value
      };
    }
  };

  DiscoverySchema.prototype._checkType = function(value, type) {
    switch (type) {
      case "array":
        return _.isArray(value);
      case "object":
        return _.isPlainObject(value);
      case "string":
        return _.isString(value);
      case "integer":
        if (!_.isNumber(value)) {
          return false;
        }
        return value === parseInt(value);
      case "number":
        return _.isNumber(value);
      case "boolean":
        return _.isBoolean(value);
      case "any":
        return true;
      default:
        return false;
    }
  };

  DiscoverySchema.prototype._validateSchema = function(value) {
    this._generateSchema();
    return this.schema.validate(value);
  };

  DiscoverySchema.prototype._generateSchema = function() {
    if (!schema.types.any) {
      schema.types.any = function() {
        return true;
      };
    }
    return this.schema = this.schema || schema.create(this._generateSchemaOptions());
  };

  DiscoverySchema.prototype._generateSchemaOptions = function() {
    var key, options, property, ref, type, _i, _len, _ref;
    if (this.schemaOptions) {
      return this.schemaOptions;
    }
    options = {};
    _ref = this.properties;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      key = _ref[_i];
      if (!this.properties.hasOwnProperty(key)) {
        continue;
      }
      property = this.properties[key];
      if (property.type === "array") {
        options[key] = {
          type: "array",
          required: !!property.required
        };
        if (!(property.items instanceof Object)) {
          continue;
        }
        if (!property.items.$ref) {
          continue;
        }
        ref = property.items.$ref;
        schema = this.client.getSchema(ref);
        if (!schema || schema === this) {
          continue;
        }
        options[key].schema = this.client.getSchema(ref)._generateSchemaOptions();
      } else if (property.type === "object") {
        options[key] = {
          type: "object",
          required: !!property.required
        };
        if (!property.$ref) {
          continue;
        }
        ref = property.$ref;
        schema = this.client.getSchema(ref);
        if (!schema || schema === this) {
          continue;
        }
        options[key].schema = this.client.getSchema(ref)._generateSchemaOptions();
      } else {
        type = null;
        if (property.type === "integer") {
          type = "int";
        } else {
          type = property.type;
        }
        options[key] = {
          type: type,
          required: !!property.required
        };
      }
    }
    return this.schemaOptions = options;
  };

  return DiscoverySchema;

})();

module.exports = DiscoverySchema;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsZWV0L2Rpc2NvdmVyeS9zY2hlbWEuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsdUJBQUE7O0FBQUEsTUFBQSxHQUFTLE9BQUEsQ0FBUSxVQUFSLENBQVQsQ0FBQTs7QUFBQTtBQUdFLDRCQUFBLEVBQUEsR0FBSSxFQUFKLENBQUE7O0FBQUEsNEJBQ0EsSUFBQSxHQUFNLEVBRE4sQ0FBQTs7QUFBQSw0QkFFQSxVQUFBLEdBQVksRUFGWixDQUFBOztBQUFBLDRCQUdBLE1BQUEsR0FBUSxJQUhSLENBQUE7O0FBQUEsNEJBSUEsYUFBQSxHQUFlLElBSmYsQ0FBQTs7QUFBQSw0QkFLQSxNQUFBLEdBQVEsSUFMUixDQUFBOztBQU1BO0FBQUE7Ozs7S0FOQTs7QUFXYSxFQUFBLHlCQUFDLEVBQUQsRUFBSyxJQUFMLEVBQVcsVUFBWCxFQUF1QixNQUF2QixHQUFBO0FBQ1gsSUFBQSxJQUFJLENBQUMsRUFBTCxHQUFVLEVBQVYsQ0FBQTtBQUFBLElBQ0EsSUFBSSxDQUFDLElBQUwsR0FBWSxJQURaLENBQUE7QUFBQSxJQUVBLElBQUksQ0FBQyxVQUFMLEdBQWtCLFVBRmxCLENBQUE7QUFBQSxJQUdBLElBQUksQ0FBQyxNQUFMLEdBQWMsTUFIZCxDQUFBO0FBSUEsSUFBQSxJQUFHLENBQUEsSUFBSDtBQUVFLFlBQVUsSUFBQSxLQUFBLENBQU0sa0JBQU4sQ0FBVixDQUZGO0tBTFc7RUFBQSxDQVhiOztBQUFBLDRCQW1CQSxRQUFBLEdBQVUsU0FBQyxLQUFELEdBQUE7QUFDUixRQUFBLDBCQUFBO0FBQUEsSUFBQSxJQUFHLEtBQUEsS0FBUyxJQUFULElBQWlCLEtBQUEsS0FBUyxNQUE3QjtBQUNFLGFBQU87QUFBQSxRQUNMLEtBQUEsRUFBTyxLQURGO0FBQUEsUUFFTCxLQUFBLEVBQU8sS0FGRjtBQUFBLFFBR0wsTUFBQSxFQUFRLDRCQUhIO09BQVAsQ0FERjtLQUFBO0FBTUEsSUFBQSxJQUFHLElBQUksQ0FBQyxJQUFMLEtBQWEsUUFB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TSxDQUFDLE9BQVAsR0FBaUIsZUFwSmpCLENBQUEiLCJmaWxlIjoiZmxlZXQvZGlzY292ZXJ5L3NjaGVtYS5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbInNjaGVtYSA9IHJlcXVpcmUoXCJzY2hlbWFqc1wiKVxuXG5jbGFzcyBEaXNjb3ZlcnlTY2hlbWFcbiAgaWQ6IFwiXCJcbiAgdHlwZTogXCJcIlxuICBwcm9wZXJ0aWVzOiB7fVxuICBzY2hlbWE6IG51bGxcbiAgc2NoZW1hT3B0aW9uczogbnVsbFxuICBjbGllbnQ6IG51bGxcbiAgIyMjKlxuICAqIEBwYXJhbSB7c3RyaW5nfSBpZFxuICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlXG4gICogQHBhcmFtIHtPYmplY3R9IHByb3BlcnRpZXNcbiAgIyMjXG4gIGNvbnN0cnVjdG9yOiAoaWQsIHR5cGUsIHByb3BlcnRpZXMsIGNsaWVudCkgLT5cbiAgICB0aGlzLmlkID0gaWRcbiAgICB0aGlzLnR5cGUgPSB0eXBlXG4gICAgdGhpcy5wcm9wZXJ0aWVzID0gcHJvcGVydGllc1xuICAgIHRoaXMuY2xpZW50ID0gY2xpZW50XG4gICAgaWYgbm90IHR5cGVcbiAgICAgICMgV2UgdXNlIHR5cGUgZm9yIHZhbGlkYXRpb25cbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlR5cGUgaXMgcmVxdWlyZWRcIilcbiAgdmFsaWRhdGU6ICh2YWx1ZSkgLT5cbiAgICBpZiB2YWx1ZSBpcyBudWxsIG9yIHZhbHVlIGlzIHVuZGVmaW5lZFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlXG4gICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICByZWFzb246IFwiVmFsdWUgaXMgbnVsbCBvciB1bmRlZmluZWRcIlxuICAgICAgfVxuICAgIGlmIHRoaXMudHlwZSBpcyBcInN0cmluZ1wiIGFuZCB0eXBlb2YgdmFsdWUgaXNudCBzdHJpbmdcbiAgICAgIHZhbHVlID0gSlNPTi5wYXJzZSh2YWx1ZSlcbiAgICBpZiB0aGlzLl9jaGVja1R5cGUodmFsdWUsIHRoaXMudHlwZSlcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbGlkOiBmYWxzZVxuICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgcmVhc29uOiBcIlR5cGUgb2YgdmFsdWUgaXNuJ3QgI3t0aGlzLnR5cGV9XCJcbiAgICAgIH1cbiAgICBpZiB0aGlzLnR5cGUgaXMgXCJvYmplY3RcIlxuICAgICAgdmFsaWRhdGlvbiA9IHRoaXMuX3ZhbGlkYXRlU2NoZW1hKHZhbHVlKVxuICAgICAgaWYgdmFsaWRhdGlvbi52YWxpZFxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHZhbGlkOiB0cnVlXG4gICAgICAgICAgdmFsdWU6IHZhbGlkYXRpb24uZGF0YVxuICAgICAgICB9XG4gICAgICBlbHNlXG4gICAgICAgIHZhbHVlcyA9IF8udmFsdWVzKHZhbGlkYXRpb24uZXJyb3JzKVxuICAgICAgICByZWFzb24gPSBcInJlcXVlc3QgaXMgbm90IHZhbGlkXCJcbiAgICAgICAgaWYgdmFsdWVzLmxlbmd0aFxuICAgICAgICAgIHJlYXNvbiA9IHZhbHVlc1swXVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHZhbGlkOiBmYWxzZVxuICAgICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICAgIHJlYXNvbjogcmVhc29uXG4gICAgICAgIH1cbiAgICBlbHNlXG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZDogdHJ1ZVxuICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgIH1cbiAgX2NoZWNrVHlwZTogKHZhbHVlLCB0eXBlKSAtPlxuICAgICMgVmFsaWQgdHlwZXNcbiAgICAjIGh0dHA6Ly90b29scy5pZXRmLm9yZy9odG1sL2RyYWZ0LXp5cC1qc29uLXNjaGVtYS0wMyNzZWN0aW9uLTUuMVxuICAgIHN3aXRjaCB0eXBlXG4gICAgICB3aGVuIFwiYXJyYXlcIlxuICAgICAgICBfLmlzQXJyYXkoIHZhbHVlIClcbiAgICAgIHdoZW4gXCJvYmplY3RcIlxuICAgICAgICBfLmlzUGxhaW5PYmplY3QoIHZhbHVlIClcbiAgICAgIHdoZW4gXCJzdHJpbmdcIlxuICAgICAgICBfLmlzU3RyaW5nKCB2YWx1ZSApXG4gICAgICB3aGVuIFwiaW50ZWdlclwiXG4gICAgICAgIHJldHVybiBmYWxzZSBpZiBub3QgXy5pc051bWJlciggdmFsdWUgKVxuICAgICAgICB2YWx1ZSBpcyBwYXJzZUludCggdmFsdWUgKVxuICAgICAgd2hlbiBcIm51bWJlclwiXG4gICAgICAgIF8uaXNOdW1iZXIodmFsdWUpXG4gICAgICB3aGVuIFwiYm9vbGVhblwiXG4gICAgICAgIF8uaXNCb29sZWFuKHZhbHVlKVxuICAgICAgd2hlbiBcImFueVwiXG4gICAgICAgIHRydWVcbiAgICAgIGVsc2VcbiAgICAgICAgZmFsc2VcbiAgX3ZhbGlkYXRlU2NoZW1hOiAodmFsdWUpIC0+XG4gICAgdGhpcy5fZ2VuZXJhdGVTY2hlbWEoKVxuICAgIHJldHVybiB0aGlzLnNjaGVtYS52YWxpZGF0ZSh2YWx1ZSlcbiAgX2dlbmVyYXRlU2NoZW1hOiAtPlxuICAgIGlmIG5vdCBzY2hlbWEudHlwZXMuYW55XG4gICAgICBzY2hlbWEudHlwZXMuYW55ID0gLT5cbiAgICAgICAgdHJ1ZVxuICAgIHRoaXMuc2NoZW1hID0gdGhpcy5zY2hlbWEgb3Igc2NoZW1hLmNyZWF0ZSh0aGlzLl9nZW5lcmF0ZVNjaGVtYU9wdGlvbnMoKSlcbiAgX2dlbmVyYXRlU2NoZW1hT3B0aW9uczogLT5cbiAgICBpZiB0aGlzLnNjaGVtYU9wdGlvbnNcbiAgICAgIHJldHVybiB0aGlzLnNjaGVtYU9wdGlvbnNcbiAgICBvcHRpb25zID0ge31cbiAgICBmb3Iga2V5IGluIHRoaXMucHJvcGVydGllc1xuICAgICAgaWYgbm90IHRoaXMucHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShrZXkpXG4gICAgICAgIGNvbnRpbnVlXG4gICAgICBwcm9wZXJ0eSA9IHRoaXMucHJvcGVydGllc1trZXldXG4gICAgICBpZiBwcm9wZXJ0eS50eXBlIGlzIFwiYXJyYXlcIlxuICAgICAgICBvcHRpb25zW2tleV0gPSB7XG4gICAgICAgICAgdHlwZTogXCJhcnJheVwiLFxuICAgICAgICAgIHJlcXVpcmVkOiAhIXByb3BlcnR5LnJlcXVpcmVkXG4gICAgICAgIH1cbiAgICAgICAgaWYgcHJvcGVydHkuaXRlbXMgbm90IGluc3RhbmNlb2YgT2JqZWN0XG4gICAgICAgICAgY29udGludWVcbiAgICAgICAgaWYgbm90IHByb3BlcnR5Lml0ZW1zLiRyZWZcbiAgICAgICAgICAjIFRPRE8gaW1wbGVtZW50IG90aGVyIHRoYW4gJHJlZlxuICAgICAgICAgICMgRmxlZXQgQVBJIG9ubHkgdXNlcyAkcmVmIGN1cnJlbnRseVxuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIHJlZiA9IHByb3BlcnR5Lml0ZW1zLiRyZWZcbiAgICAgICAgc2NoZW1hID0gdGhpcy5jbGllbnQuZ2V0U2NoZW1hKHJlZilcbiAgICAgICAgIyBXZSBkb24ndCB3YW50IGNpcmN1bGFyIHJlZmVyZW5jZXNcbiAgICAgICAgaWYgbm90IHNjaGVtYSBvciBzY2hlbWEgaXMgdGhpc1xuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIG9wdGlvbnNba2V5XS5zY2hlbWEgPSB0aGlzXG4gICAgICAgICAgLmNsaWVudFxuICAgICAgICAgIC5nZXRTY2hlbWEocmVmKVxuICAgICAgICAgIC5fZ2VuZXJhdGVTY2hlbWFPcHRpb25zKClcbiAgICAgIGVsc2UgaWYgcHJvcGVydHkudHlwZSBpcyBcIm9iamVjdFwiXG4gICAgICAgIG9wdGlvbnNba2V5XSA9IHtcbiAgICAgICAgICB0eXBlOiBcIm9iamVjdFwiLFxuICAgICAgICAgIHJlcXVpcmVkOiAhIXByb3BlcnR5LnJlcXVpcmVkXG4gICAgICAgIH1cbiAgICAgICAgaWYgbm90IHByb3BlcnR5LiRyZWZcbiAgICAgICAgICAjIFRPRE8gaW1wbGVtZW50IG90aGVyIHRoYW4gJHJlZlxuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIHJlZiA9IHByb3BlcnR5LiRyZWZcbiAgICAgICAgc2NoZW1hID0gdGhpcy5jbGllbnQuZ2V0U2NoZW1hKHJlZilcbiAgICAgICAgIyBXZSBkb24ndCB3YW50IGNpcmN1bGFyIHJlZmVyZW5jZXNcbiAgICAgICAgaWYgbm90IHNjaGVtYSBvciBzY2hlbWEgaXMgdGhpc1xuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIG9wdGlvbnNba2V5XS5zY2hlbWEgPSB0aGlzXG4gICAgICAgICAgLmNsaWVudFxuICAgICAgICAgIC5nZXRTY2hlbWEocmVmKVxuICAgICAgICAgIC5fZ2VuZXJhdGVTY2hlbWFPcHRpb25zKClcbiAgICAgIGVsc2VcbiAgICAgICAgdHlwZSA9IG51bGxcbiAgICAgICAgIyBcImludGVnZXJcIiBpcyB0aGUgb25seSB0eXBlIHRoYXQgaXMgZGlmZmVyZW50XG4gICAgICAgICMgaHR0cHM6Ly9naXRodWIuY29tL2VsZWl0aC9zY2hlbWFqcyNzY2hlbWF0eXBlc1xuICAgICAgICAjIEkgaGF2ZSBleHRlbmRlZCBzY2hlbWEgdG8gYWNjZXB0IHR5cGUgXCJhbnlcIlxuICAgICAgICBpZiBwcm9wZXJ0eS50eXBlIGlzIFwiaW50ZWdlclwiXG4gICAgICAgICAgdHlwZSA9IFwiaW50XCJcbiAgICAgICAgZWxzZVxuICAgICAgICAgIHR5cGUgPSBwcm9wZXJ0eS50eXBlXG4gICAgICAgIG9wdGlvbnNba2V5XSA9IHtcbiAgICAgICAgICB0eXBlOiB0eXBlLFxuICAgICAgICAgIHJlcXVpcmVkOiAhIXByb3BlcnR5LnJlcXVpcmVkXG4gICAgICAgIH1cbiAgICB0aGlzLnNjaGVtYU9wdGlvbnMgPSBvcHRpb25zXG5cbm1vZHVsZS5leHBvcnRzID0gRGlzY292ZXJ5U2NoZW1hIl19