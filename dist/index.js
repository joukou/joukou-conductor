
/**
@module joukou-conductor/index
@author Fabian Cook <fabian.cook@joukou.com>
@copyright (c) 2009-2014 Joukou Ltd. All rights reserved.
 */
var conductorClient, isRunning, joukouETCDConnectionString, joukouNode, start, startImmediately, vip;

joukouETCDConnectionString = process.env["JOUKOU_ETCD_CONNECTION_STRING"];

joukouNode = process.env["JOUKOU_NODE"];

vip = require('vip');

conductorClient = require('./rabbitmq/conductor-client');

if (!joukouETCDConnectionString) {
  joukouETCDConnectionString = "127.0.0.1:4001,127.0.0.1:4002";
  process.env["JOUKOU_ETCD_CONNECTION_STRING"] = joukouETCDConnectionString;
}

start = function() {
  var service, vipcontroller;
  vipcontroller = vip('127.0.0.1:4001,127.0.0.1:4002');
  return service = vipcontroller({
    id: joukouNode,
    path: "/joukou-conductor",
    value: "joukou-conductor-vip_" + joukouNode,
    ttl: 5
  }, startImmediately);
};

isRunning = false;

startImmediately = function() {
  if (isRunning) {
    return;
  }
  isRunning = true;
  return conductorClient.listen();
};

if (require.main === module) {
  start();
}

module.exports = {
  start: start,
  startImmediately: startImmediately
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBOzs7O0dBQUE7QUFBQSxJQUFBLGdHQUFBOztBQUFBLDBCQU1BLEdBQThCLE9BQU8sQ0FBQyxHQUFJLENBQUEsK0JBQUEsQ0FOMUMsQ0FBQTs7QUFBQSxVQU9BLEdBQThCLE9BQU8sQ0FBQyxHQUFJLENBQUEsYUFBQSxDQVAxQyxDQUFBOztBQUFBLEdBU0EsR0FBOEIsT0FBQSxDQUFTLEtBQVQsQ0FUOUIsQ0FBQTs7QUFBQSxlQVVBLEdBQThCLE9BQUEsQ0FBUSw2QkFBUixDQVY5QixDQUFBOztBQVlBLElBQUcsQ0FBQSwwQkFBSDtBQUNFLEVBQUEsMEJBQUEsR0FBNkIsK0JBQTdCLENBQUE7QUFBQSxFQUNBLE9BQU8sQ0FBQyxHQUFJLENBQUEsK0JBQUEsQ0FBWixHQUErQywwQkFEL0MsQ0FERjtDQVpBOztBQUFBLEtBZ0JBLEdBQVEsU0FBQSxHQUFBO0FBQ04sTUFBQSxzQkFBQTtBQUFBLEVBQUEsYUFBQSxHQUFnQixHQUFBLENBQUksK0JBQUosQ0FBaEIsQ0FBQTtTQUNBLE9BQUEsR0FBVSxhQUFBLENBQ1I7QUFBQSxJQUFBLEVBQUEsRUFBSSxVQUFKO0FBQUEsSUFDQSxJQUFBLEVBQU0sbUJBRE47QUFBQSxJQUVBLEtBQUEsRUFBUSx1QkFBQSxHQUF1QixVQUYvQjtBQUFBLElBR0EsR0FBQSxFQUFLLENBSEw7R0FEUSxFQUtSLGdCQUxRLEVBRko7QUFBQSxDQWhCUixDQUFBOztBQUFBLFNBeUJBLEdBQVksS0F6QlosQ0FBQTs7QUFBQSxnQkEyQkEsR0FBbUIsU0FBQSxHQUFBO0FBQ2pCLEVBQUEsSUFBRyxTQUFIO0FBRUUsVUFBQSxDQUZGO0dBQUE7QUFBQSxFQUdBLFNBQUEsR0FBWSxJQUhaLENBQUE7U0FJQSxlQUFlLENBQUMsTUFBaEIsQ0FBQSxFQUxpQjtBQUFBLENBM0JuQixDQUFBOztBQWtDQSxJQUFHLE9BQU8sQ0FBQyxJQUFSLEtBQWdCLE1BQW5CO0FBQ0UsRUFBQSxLQUFBLENBQUEsQ0FBQSxDQURGO0NBbENBOztBQUFBLE1BcUNNLENBQUMsT0FBUCxHQUNFO0FBQUEsRUFBQSxLQUFBLEVBQU8sS0FBUDtBQUFBLEVBQ0EsZ0JBQUEsRUFBa0IsZ0JBRGxCO0NBdENGLENBQUEiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyIjIyMqXG5AbW9kdWxlIGpvdWtvdS1jb25kdWN0b3IvaW5kZXhcbkBhdXRob3IgRmFiaWFuIENvb2sgPGZhYmlhbi5jb29rQGpvdWtvdS5jb20+XG5AY29weXJpZ2h0IChjKSAyMDA5LTIwMTQgSm91a291IEx0ZC4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiMjI1xuXG5qb3Vrb3VFVENEQ29ubmVjdGlvblN0cmluZyAgPSBwcm9jZXNzLmVudltcIkpPVUtPVV9FVENEX0NPTk5FQ1RJT05fU1RSSU5HXCJdXG5qb3Vrb3VOb2RlICAgICAgICAgICAgICAgICAgPSBwcm9jZXNzLmVudltcIkpPVUtPVV9OT0RFXCJdXG5cbnZpcCAgICAgICAgICAgICAgICAgICAgICAgICA9IHJlcXVpcmUoICd2aXAnIClcbmNvbmR1Y3RvckNsaWVudCAgICAgICAgICAgICA9IHJlcXVpcmUoJy4vcmFiYml0bXEvY29uZHVjdG9yLWNsaWVudCcpXG5cbmlmIG5vdCBqb3Vrb3VFVENEQ29ubmVjdGlvblN0cmluZ1xuICBqb3Vrb3VFVENEQ29ubmVjdGlvblN0cmluZyA9IFwiMTI3LjAuMC4xOjQwMDEsMTI3LjAuMC4xOjQwMDJcIlxuICBwcm9jZXNzLmVudltcIkpPVUtPVV9FVENEX0NPTk5FQ1RJT05fU1RSSU5HXCJdID0gam91a291RVRDRENvbm5lY3Rpb25TdHJpbmdcblxuc3RhcnQgPSAtPlxuICB2aXBjb250cm9sbGVyID0gdmlwKCcxMjcuMC4wLjE6NDAwMSwxMjcuMC4wLjE6NDAwMicpXG4gIHNlcnZpY2UgPSB2aXBjb250cm9sbGVyKFxuICAgIGlkOiBqb3Vrb3VOb2RlXG4gICAgcGF0aDogXCIvam91a291LWNvbmR1Y3RvclwiXG4gICAgdmFsdWU6IFwiam91a291LWNvbmR1Y3Rvci12aXBfI3tqb3Vrb3VOb2RlfVwiXG4gICAgdHRsOiA1XG4gICwgc3RhcnRJbW1lZGlhdGVseSlcblxuaXNSdW5uaW5nID0gbm9cblxuc3RhcnRJbW1lZGlhdGVseSA9IC0+XG4gIGlmIGlzUnVubmluZ1xuICAgICMgV2UgYXJlIGFscmVhZHkgbGlzdGVuaW5nXG4gICAgcmV0dXJuXG4gIGlzUnVubmluZyA9IHllc1xuICBjb25kdWN0b3JDbGllbnQubGlzdGVuKClcblxuaWYgcmVxdWlyZS5tYWluIGlzIG1vZHVsZVxuICBzdGFydCgpXG5cbm1vZHVsZS5leHBvcnRzID1cbiAgc3RhcnQ6IHN0YXJ0XG4gIHN0YXJ0SW1tZWRpYXRlbHk6IHN0YXJ0SW1tZWRpYXRlbHlcblxuIl19