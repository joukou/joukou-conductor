
/**
@module joukou-conductor/index
@author Fabian Cook <fabian.cook@joukou.com>
@copyright (c) 2009-2014 Joukou Ltd. All rights reserved.
 */
var ConductorRabbitMQClient, isRunning, joukouETCDConnectionString, joukouNode, start, startImmediately, vip;

joukouETCDConnectionString = process.env["JOUKOU_ETCD_CONNECTION_STRING"];

joukouNode = process.env["JOUKOU_NODE"];

vip = require('vip');

ConductorRabbitMQClient = require('joukou-conductor-rabbitmq').ConductorRabbitMQClient;

if (!joukouETCDConnectionString) {
  joukouETCDConnectionString = "127.0.0.1:4001,127.0.0.1:4002";
  process.env["JOUKOU_ETCD_CONNECTION_STRING"] = joukouETCDConnectionString;
}

start = function() {
  var service, vipcontroller;
  vipcontroller = vip('127.0.0.1:4001,127.0.0.1:4002');
  return service = vipcontroller({
    id: joukouNode,
    path: "/joukou-conductor",
    value: "joukou-conductor-vip_" + joukouNode,
    ttl: 5
  }, startImmediately);
};

isRunning = false;

startImmediately = function() {
  if (isRunning) {
    return;
  }
  isRunning = true;
  return ConductorRabbitMQClient.listen();
};

if (require.main === module) {
  start();
}

module.exports = {
  start: start,
  startImmediately: startImmediately
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBOzs7O0dBQUE7QUFBQSxJQUFBLHdHQUFBOztBQUFBLDBCQU1BLEdBQThCLE9BQU8sQ0FBQyxHQUFJLENBQUEsK0JBQUEsQ0FOMUMsQ0FBQTs7QUFBQSxVQU9BLEdBQThCLE9BQU8sQ0FBQyxHQUFJLENBQUEsYUFBQSxDQVAxQyxDQUFBOztBQUFBLEdBU0EsR0FBOEIsT0FBQSxDQUFTLEtBQVQsQ0FUOUIsQ0FBQTs7QUFBQSwwQkFVOEIsT0FBQSxDQUFRLDJCQUFSLEVBQTVCLHVCQVZGLENBQUE7O0FBWUEsSUFBRyxDQUFBLDBCQUFIO0FBQ0UsRUFBQSwwQkFBQSxHQUE2QiwrQkFBN0IsQ0FBQTtBQUFBLEVBQ0EsT0FBTyxDQUFDLEdBQUksQ0FBQSwrQkFBQSxDQUFaLEdBQStDLDBCQUQvQyxDQURGO0NBWkE7O0FBQUEsS0FnQkEsR0FBUSxTQUFBLEdBQUE7QUFDTixNQUFBLHNCQUFBO0FBQUEsRUFBQSxhQUFBLEdBQWdCLEdBQUEsQ0FBSSwrQkFBSixDQUFoQixDQUFBO1NBQ0EsT0FBQSxHQUFVLGFBQUEsQ0FDUjtBQUFBLElBQUEsRUFBQSxFQUFJLFVBQUo7QUFBQSxJQUNBLElBQUEsRUFBTSxtQkFETjtBQUFBLElBRUEsS0FBQSxFQUFRLHVCQUFBLEdBQXVCLFVBRi9CO0FBQUEsSUFHQSxHQUFBLEVBQUssQ0FITDtHQURRLEVBS1IsZ0JBTFEsRUFGSjtBQUFBLENBaEJSLENBQUE7O0FBQUEsU0F5QkEsR0FBWSxLQXpCWixDQUFBOztBQUFBLGdCQTJCQSxHQUFtQixTQUFBLEdBQUE7QUFDakIsRUFBQSxJQUFHLFNBQUg7QUFFRSxVQUFBLENBRkY7R0FBQTtBQUFBLEVBR0EsU0FBQSxHQUFZLElBSFosQ0FBQTtTQUlBLHVCQUF1QixDQUFDLE1BQXhCLENBQUEsRUFMaUI7QUFBQSxDQTNCbkIsQ0FBQTs7QUFrQ0EsSUFBRyxPQUFPLENBQUMsSUFBUixLQUFnQixNQUFuQjtBQUNFLEVBQUEsS0FBQSxDQUFBLENBQUEsQ0FERjtDQWxDQTs7QUFBQSxNQXFDTSxDQUFDLE9BQVAsR0FDRTtBQUFBLEVBQUEsS0FBQSxFQUFPLEtBQVA7QUFBQSxFQUNBLGdCQUFBLEVBQWtCLGdCQURsQjtDQXRDRixDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiIyMjKlxuQG1vZHVsZSBqb3Vrb3UtY29uZHVjdG9yL2luZGV4XG5AYXV0aG9yIEZhYmlhbiBDb29rIDxmYWJpYW4uY29va0Bqb3Vrb3UuY29tPlxuQGNvcHlyaWdodCAoYykgMjAwOS0yMDE0IEpvdWtvdSBMdGQuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4jIyNcblxuam91a291RVRDRENvbm5lY3Rpb25TdHJpbmcgID0gcHJvY2Vzcy5lbnZbXCJKT1VLT1VfRVRDRF9DT05ORUNUSU9OX1NUUklOR1wiXVxuam91a291Tm9kZSAgICAgICAgICAgICAgICAgID0gcHJvY2Vzcy5lbnZbXCJKT1VLT1VfTk9ERVwiXVxuXG52aXAgICAgICAgICAgICAgICAgICAgICAgICAgPSByZXF1aXJlKCAndmlwJyApXG57IENvbmR1Y3RvclJhYmJpdE1RQ2xpZW50IH0gPSByZXF1aXJlKCdqb3Vrb3UtY29uZHVjdG9yLXJhYmJpdG1xJylcblxuaWYgbm90IGpvdWtvdUVUQ0RDb25uZWN0aW9uU3RyaW5nXG4gIGpvdWtvdUVUQ0RDb25uZWN0aW9uU3RyaW5nID0gXCIxMjcuMC4wLjE6NDAwMSwxMjcuMC4wLjE6NDAwMlwiXG4gIHByb2Nlc3MuZW52W1wiSk9VS09VX0VUQ0RfQ09OTkVDVElPTl9TVFJJTkdcIl0gPSBqb3Vrb3VFVENEQ29ubmVjdGlvblN0cmluZ1xuXG5zdGFydCA9IC0+XG4gIHZpcGNvbnRyb2xsZXIgPSB2aXAoJzEyNy4wLjAuMTo0MDAxLDEyNy4wLjAuMTo0MDAyJylcbiAgc2VydmljZSA9IHZpcGNvbnRyb2xsZXIoXG4gICAgaWQ6IGpvdWtvdU5vZGVcbiAgICBwYXRoOiBcIi9qb3Vrb3UtY29uZHVjdG9yXCJcbiAgICB2YWx1ZTogXCJqb3Vrb3UtY29uZHVjdG9yLXZpcF8je2pvdWtvdU5vZGV9XCJcbiAgICB0dGw6IDVcbiAgLCBzdGFydEltbWVkaWF0ZWx5KVxuXG5pc1J1bm5pbmcgPSBub1xuXG5zdGFydEltbWVkaWF0ZWx5ID0gLT5cbiAgaWYgaXNSdW5uaW5nXG4gICAgIyBXZSBhcmUgYWxyZWFkeSBsaXN0ZW5pbmdcbiAgICByZXR1cm5cbiAgaXNSdW5uaW5nID0geWVzXG4gIENvbmR1Y3RvclJhYmJpdE1RQ2xpZW50Lmxpc3RlbigpXG5cbmlmIHJlcXVpcmUubWFpbiBpcyBtb2R1bGVcbiAgc3RhcnQoKVxuXG5tb2R1bGUuZXhwb3J0cyA9XG4gIHN0YXJ0OiBzdGFydFxuICBzdGFydEltbWVkaWF0ZWx5OiBzdGFydEltbWVkaWF0ZWx5XG5cbiJdfQ==