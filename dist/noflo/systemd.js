var SystemDUnitFile, checkForBrokenConnections, createFile, createFromSchema, createOptions, findPorts, generateConnectionKeys, _;

SystemDUnitFile = require("../systemd/unit-file");

_ = require("lodash");

createFromSchema = function(input, machineID, joukouMessageQueAddress, joukouApiAddress) {
  var connections, name, processes;
  if (!_.isPlainObject(input)) {
    throw new TypeError("input is not an object");
  }
  if (!machineID) {
    throw new Error("machineID is required");
  }
  if (typeof machineID !== "string") {
    throw new TypeError("machineID is not a string");
  }
  if (typeof joukouMessageQueAddress !== "string") {
    throw new TypeError("joukouMessageQueAddress is not a string");
  }
  if (typeof joukouApiAddress !== "string") {
    throw new TypeError("joukouApiAddress is not a string");
  }
  if (!_.isPlainObject(input.properties)) {
    throw new TypeError("input.properties is not an object");
  }
  if (!_.isPlainObject(input.processes)) {
    throw new TypeError("input.processes is not an object");
  }
  if (!_.isArray(input.connections)) {
    throw new TypeError("input.connections is not an array");
  }
  name = input.properties.name;
  if (!name) {
    throw new Error("input.properties.name is required");
  }
  connections = _.cloneDeep(input.connections);
  checkForBrokenConnections(connections);
  processes = _.cloneDeep(input.processes);
  return createOptions(name, processes, connections, machineID, joukouMessageQueAddress, joukouApiAddress);
};

createOptions = function(name, processes, connections, machineID, joukouMessageQueAddress, joukouApiAddress) {
  var file, options, process, processKey, unit;
  options = [];

  /*
  use format
  [
    {
      unitName: "name"
      options: [SystemDUnitFile].options
      machineID: machineID
    }
  ]
   */
  for (processKey in processes) {
    if (!processes.hasOwnProperty(processKey)) {
      continue;
    }
    process = processes[processKey];
    unit = {
      process: process,
      processKey: processKey,
      machineID: machineID,
      dockerContainer: process.component,
      ports: findPorts(connections, processKey)
    };
    generateConnectionKeys(unit.ports);
    file = createFile(unit, joukouMessageQueAddress, joukouApiAddress);
    options.push({
      unitName: processKey,
      options: file.options,
      machineID: machineID
    });
  }
  return options;
};

createFile = function(unit, joukouMessageQueAddress, joukouApiAddress) {
  var file, key, port, _i, _len, _ref;
  file = new SystemDUnitFile();
  file.service.addEnvironment("JOUKOU_AMQP_ADDR", joukouMessageQueAddress);
  file.service.addEnvironment("JOUKOU_API_ADDR", joukouApiAddress);
  _ref = unit.ports;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    port = _ref[_i];
    key = "JOUKOU_CIRCLE_" + port.type + "_" + port.name + "_";
    file.service.addEnvironment("" + key + "EXCHANGE", port.port.exchangeKey);
    file.service.addEnvironment("" + key + "ROUTING_KEY", port.port.routingKey);
  }
  return file;
};

generateConnectionKeys = function(ports) {
  var port, portObject, _i, _len, _results;
  _results = [];
  for (_i = 0, _len = ports.length; _i < _len; _i++) {
    portObject = ports[_i];
    port = portObject.port;
    if (!port.exchangeKey) {
      port.exchangeKey = "FAKE_EXCHANGE";
      _results.push(port.routingKey = "FAKE_ROUTING");
    } else {
      _results.push(void 0);
    }
  }
  return _results;
};

checkForBrokenConnections = function(connections) {
  var connection, i, source, target, _results;
  i = 0;
  _results = [];
  while (i < connections.length) {
    connection = connections[i];
    i++;
    if (!_.isPlainObject(connection)) {
      continue;
    }
    target = connection["tgt"];
    source = connection["src"];
    if (!target && !source) {
      continue;
    } else {
      _results.push(void 0);
    }
  }
  return _results;
};

findPorts = function(connections, processKey) {
  var connection, result, _i, _len;
  result = [];
  for (_i = 0, _len = connections.length; _i < _len; _i++) {
    connection = connections[_i];
    if (connection.tgt) {
      if (connection.tgt.process === processKey) {
        result.push({
          type: "INPORT",
          name: connection.tgt.port,
          port: connection.tgt,
          connection: connection
        });
      }
    }
    if (connection.src) {
      if (connection.src.process === processKey) {
        result.push({
          type: "OUTPORT",
          name: connection.src.port,
          port: connection.src,
          connection: connection
        });
      }
    }
  }
  return result;
};

module.exports = {
  createFromSchema: createFromSchema
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZmxvL3N5c3RlbWQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsNkhBQUE7O0FBQUEsZUFBQSxHQUFrQixPQUFBLENBQVEsc0JBQVIsQ0FBbEIsQ0FBQTs7QUFBQSxDQUNBLEdBQWtCLE9BQUEsQ0FBUSxRQUFSLENBRGxCLENBQUE7O0FBQUEsZ0JBR0EsR0FBbUIsU0FBQyxLQUFELEVBQ0EsU0FEQSxFQUVBLHVCQUZBLEVBR0EsZ0JBSEEsR0FBQTtBQUlqQixNQUFBLDRCQUFBO0FBQUEsRUFBQSxJQUFHLENBQUEsQ0FBSyxDQUFDLGFBQUYsQ0FBZ0IsS0FBaEIsQ0FBUDtBQUNFLFVBQVUsSUFBQSxTQUFBLENBQVUsd0JBQVYsQ0FBVixDQURGO0dBQUE7QUFFQSxFQUFBLElBQUcsQ0FBQSxTQUFIO0FBQ0UsVUFBVSxJQUFBLEtBQUEsQ0FBTSx1QkFBTixDQUFWLENBREY7R0FGQTtBQUlBLEVBQUEsSUFBRyxNQUFBLENBQUEsU0FBQSxLQUFzQixRQUF6QjtBQUNFLFVBQVUsSUFBQSxTQUFBLENBQVUsMkJBQVYsQ0FBVixDQURGO0dBSkE7QUFNQSxFQUFBLElBQUcsTUFBQSxDQUFBLHVCQUFBLEtBQW9DLFFBQXZDO0FBQ0UsVUFBVSxJQUFBLFNBQUEsQ0FBVSx5Q0FBVixDQUFWLENBREY7R0FOQTtBQVFBLEVBQUEsSUFBRyxNQUFBLENBQUEsZ0JBQUEsS0FBNkIsUUFBaEM7QUFDRSxVQUFVLElBQUEsU0FBQSxDQUFVLGtDQUFWLENBQVYsQ0FERjtHQVJBO0FBVUEsRUFBQSxJQUFHLENBQUEsQ0FBSyxDQUFDLGFBQUYsQ0FBZ0IsS0FBSyxDQUFDLFVBQXRCLENBQVA7QUFDRSxVQUFVLElBQUEsU0FBQSxDQUFVLG1DQUFWLENBQVYsQ0FERjtHQVZBO0FBWUEsRUFBQSxJQUFHLENBQUEsQ0FBSyxDQUFDLGFBQUYsQ0FBZ0IsS0FBSyxDQUFDLFNBQXRCLENBQVA7QUFDRSxVQUFVLElBQUEsU0FBQSxDQUFVLGtDQUFWLENBQVYsQ0FE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LEdBQVksU0FBQyxXQUFELEVBQWMsVUFBZCxHQUFBO0FBQ1YsTUFBQSw0QkFBQTtBQUFBLEVBQUEsTUFBQSxHQUFTLEVBQVQsQ0FBQTtBQUNBLE9BQUEsa0RBQUE7aUNBQUE7QUFDRSxJQUFBLElBQUcsVUFBVSxDQUFDLEdBQWQ7QUFDRSxNQUFBLElBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFmLEtBQTBCLFVBQTdCO0FBQ0UsUUFBQSxNQUFNLENBQUMsSUFBUCxDQUFZO0FBQUEsVUFDVixJQUFBLEVBQU0sUUFESTtBQUFBLFVBRVYsSUFBQSxFQUFNLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFGWDtBQUFBLFVBR1YsSUFBQSxFQUFNLFVBQVUsQ0FBQyxHQUhQO0FBQUEsVUFJVixVQUFBLEVBQVksVUFKRjtTQUFaLENBQUEsQ0FERjtPQURGO0tBQUE7QUFRQSxJQUFBLElBQUcsVUFBVSxDQUFDLEdBQWQ7QUFDRSxNQUFBLElBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFmLEtBQTBCLFVBQTdCO0FBQ0UsUUFBQSxNQUFNLENBQUMsSUFBUCxDQUFZO0FBQUEsVUFDVixJQUFBLEVBQU0sU0FESTtBQUFBLFVBRVYsSUFBQSxFQUFNLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFGWDtBQUFBLFVBR1YsSUFBQSxFQUFNLFVBQVUsQ0FBQyxHQUhQO0FBQUEsVUFJVixVQUFBLEVBQVksVUFKRjtTQUFaLENBQUEsQ0FERjtPQURGO0tBVEY7QUFBQSxHQURBO1NBa0JBLE9BbkJVO0FBQUEsQ0F4SFosQ0FBQTs7QUFBQSxNQTZJTSxDQUFDLE9BQVAsR0FDRTtBQUFBLEVBQUEsZ0JBQUEsRUFBa0IsZ0JBQWxCO0NBOUlGLENBQUEiLCJmaWxlIjoibm9mbG8vc3lzdGVtZC5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbIlN5c3RlbURVbml0RmlsZSA9IHJlcXVpcmUoXCIuLi9zeXN0ZW1kL3VuaXQtZmlsZVwiKVxuXyAgICAgICAgICAgICAgID0gcmVxdWlyZShcImxvZGFzaFwiKVxuXG5jcmVhdGVGcm9tU2NoZW1hID0gKGlucHV0LFxuICAgICAgICAgICAgICAgICAgIG1hY2hpbmVJRCxcbiAgICAgICAgICAgICAgICAgICBqb3Vrb3VNZXNzYWdlUXVlQWRkcmVzcyxcbiAgICAgICAgICAgICAgICAgICBqb3Vrb3VBcGlBZGRyZXNzKSAtPlxuICBpZiBub3QgXy5pc1BsYWluT2JqZWN0KGlucHV0KVxuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJpbnB1dCBpcyBub3QgYW4gb2JqZWN0XCIpXG4gIGlmIG5vdCBtYWNoaW5lSURcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJtYWNoaW5lSUQgaXMgcmVxdWlyZWRcIilcbiAgaWYgdHlwZW9mIG1hY2hpbmVJRCBpc250IFwic3RyaW5nXCJcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwibWFjaGluZUlEIGlzIG5vdCBhIHN0cmluZ1wiKVxuICBpZiB0eXBlb2Ygam91a291TWVzc2FnZVF1ZUFkZHJlc3MgaXNudCBcInN0cmluZ1wiXG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzIGlzIG5vdCBhIHN0cmluZ1wiKVxuICBpZiB0eXBlb2Ygam91a291QXBpQWRkcmVzcyBpc250IFwic3RyaW5nXCJcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiam91a291QXBpQWRkcmVzcyBpcyBub3QgYSBzdHJpbmdcIilcbiAgaWYgbm90IF8uaXNQbGFpbk9iamVjdChpbnB1dC5wcm9wZXJ0aWVzKVxuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJpbnB1dC5wcm9wZXJ0aWVzIGlzIG5vdCBhbiBvYmplY3RcIilcbiAgaWYgbm90IF8uaXNQbGFpbk9iamVjdChpbnB1dC5wcm9jZXNzZXMpXG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImlucHV0LnByb2Nlc3NlcyBpcyBub3QgYW4gb2JqZWN0XCIpXG4gIGlmIG5vdCBfLmlzQXJyYXkoaW5wdXQuY29ubmVjdGlvbnMpXG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImlucHV0LmNvbm5lY3Rpb25zIGlzIG5vdCBhbiBhcnJheVwiKVxuICBuYW1lID0gaW5wdXQucHJvcGVydGllcy5uYW1lXG4gIGlmIG5vdCBuYW1lXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiaW5wdXQucHJvcGVydGllcy5uYW1lIGlzIHJlcXVpcmVkXCIpXG4gIGNvbm5lY3Rpb25zID0gXy5jbG9uZURlZXAoaW5wdXQuY29ubmVjdGlvbnMpXG4gIGNoZWNrRm9yQnJva2VuQ29ubmVjdGlvbnMoY29ubmVjdGlvbnMpXG4gIHByb2Nlc3NlcyA9IF8uY2xvbmVEZWVwKGlucHV0LnByb2Nlc3NlcylcbiAgcmV0dXJuIGNyZWF0ZU9wdGlvbnMoXG4gICAgbmFtZSxcbiAgICBwcm9jZXNzZXMsXG4gICAgY29ubmVjdGlvbnMsXG4gICAgbWFjaGluZUlELFxuICAgIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzLFxuICAgIGpvdWtvdUFwaUFkZHJlc3NcbiAgKVxuXG5jcmVhdGVPcHRpb25zID0gKG5hbWUsXG4gICAgICAgICAgICAgICAgIHByb2Nlc3NlcyxcbiAgICAgICAgICAgICAgICAgY29ubmVjdGlvbnMsXG4gICAgICAgICAgICAgICAgIG1hY2hpbmVJRCxcbiAgICAgICAgICAgICAgICAgam91a291TWVzc2FnZVF1ZUFkZHJlc3MsXG4gICAgICAgICAgICAgICAgIGpvdWtvdUFwaUFkZHJlc3MpIC0+XG4gIG9wdGlvbnMgPSBbXVxuICAjIyNcbiAgdXNlIGZvcm1hdFxuICBbXG4gICAge1xuICAgICAgdW5pdE5hbWU6IFwibmFtZVwiXG4gICAgICBvcHRpb25zOiBbU3lzdGVtRFVuaXRGaWxlXS5vcHRpb25zXG4gICAgICBtYWNoaW5lSUQ6IG1hY2hpbmVJRFxuICAgIH1cbiAgXVxuICAjIyNcbiAgZm9yIHByb2Nlc3NLZXkgb2YgcHJvY2Vzc2VzXG4gICAgaWYgbm90IHByb2Nlc3Nlcy5oYXNPd25Qcm9wZXJ0eShwcm9jZXNzS2V5KVxuICAgICAgY29udGludWVcbiAgICBwcm9jZXNzID0gcHJvY2Vzc2VzW3Byb2Nlc3NLZXldXG4gICAgdW5pdCA9IHtcbiAgICAgIHByb2Nlc3M6IHByb2Nlc3NcbiAgICAgIHByb2Nlc3NLZXk6IHByb2Nlc3NLZXlcbiAgICAgIG1hY2hpbmVJRDogbWFjaGluZUlEXG4gICAgICBkb2NrZXJDb250YWluZXI6IHByb2Nlc3MuY29tcG9uZW50XG4gICAgICBwb3J0czogZmluZFBvcnRzKGNvbm5lY3Rpb25zLCBwcm9jZXNzS2V5KVxuICAgIH1cbiAgICBnZW5lcmF0ZUNvbm5lY3Rpb25LZXlzKHVuaXQucG9ydHMpXG4gICAgZmlsZSA9IGNyZWF0ZUZpbGUoXG4gICAgICB1bml0LFxuICAgICAgam91a291TWVzc2FnZVF1ZUFkZHJlc3MsXG4gICAgICBqb3Vrb3VBcGlBZGRyZXNzXG4gICAgKVxuICAgIG9wdGlvbnMucHVzaCh7XG4gICAgICB1bml0TmFtZTogcHJvY2Vzc0tleVxuICAgICAgb3B0aW9uczogZmlsZS5vcHRpb25zXG4gICAgICBtYWNoaW5lSUQ6IG1hY2hpbmVJRFxuICAgIH0pXG5cbiAgcmV0dXJuIG9wdGlvbnNcblxuY3JlYXRlRmlsZSA9ICh1bml0LFxuICAgICAgICAgICAgICBqb3Vrb3VNZXNzYWdlUXVlQWRkcmVzcyxcbiAgICAgICAgICAgICAgam91a291QXBpQWRkcmVzcykgLT5cblxuICBmaWxlID0gbmV3IFN5c3RlbURVbml0RmlsZSgpXG4gIGZpbGUuc2VydmljZS5hZGRFbnZpcm9ubWVudChcIkpPVUtPVV9BTVFQX0FERFJcIiwgam91a291TWVzc2FnZVF1ZUFkZHJlc3MpXG4gIGZpbGUuc2VydmljZS5hZGRFbnZpcm9ubWVudChcIkpPVUtPVV9BUElfQUREUlwiLCBqb3Vrb3VBcGlBZGRyZXNzKVxuXG4gIGZvciBwb3J0IGluIHVuaXQucG9ydHNcbiAgICBrZXkgPSBcIkpPVUtPVV9DSVJDTEVfI3twb3J0LnR5cGV9XyN7cG9ydC5uYW1lfV9cIlxuICAgIGZpbGUuc2VydmljZS5hZGRFbnZpcm9ubWVudChcIiN7a2V5fUVYQ0hBTkdFXCIsIHBvcnQucG9ydC5leGNoYW5nZUtleSlcbiAgICBmaWxlLnNlcnZpY2UuYWRkRW52aXJvbm1lbnQoXCIje2tleX1ST1VUSU5HX0tFWVwiLCBwb3J0LnBvcnQucm91dGluZ0tleSlcblxuICByZXR1cm4gZmlsZVxuXG5nZW5lcmF0ZUNvbm5lY3Rpb25LZXlzID0gKHBvcnRzKSAtPlxuICAjIE5vdCB0byBzdXJlIHdoYXQgSXNhYWMgd2FudHMgdG8gYmVcbiAgIyBkb25lIGhlcmUsIGFkZCBmYWtlcyBmb3Igbm93XG4gIGZvciBwb3J0T2JqZWN0IGluIHBvcnRzXG4gICAgcG9ydCA9IHBvcnRPYmplY3QucG9ydFxuICAgIGlmIG5vdCBwb3J0LmV4Y2hhbmdlS2V5XG4gICAgICBwb3J0LmV4Y2hhbmdlS2V5ID0gXCJGQUtFX0VYQ0hBTkdFXCJcbiAgICAgIHBvcnQucm91dGluZ0tleSA9IFwiRkFLRV9ST1VUSU5HXCJcblxuY2hlY2tGb3JCcm9rZW5Db25uZWN0aW9ucyA9IChjb25uZWN0aW9ucykgLT5cbiAgaSA9IDBcbiAgd2hpbGUgaSA8IGNvbm5lY3Rpb25zLmxlbmd0aFxuICAgIGNvbm5lY3Rpb24gPSBjb25uZWN0aW9uc1tpXVxuICAgIGkrK1xuICAgIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QoY29ubmVjdGlvbilcbiAgICAgIGNvbnRpbnVlXG4gICAgdGFyZ2V0ID0gY29ubmVjdGlvbltcInRndFwiXVxuICAgIHNvdXJjZSA9IGNvbm5lY3Rpb25bXCJzcmNcIl1cbiAgICBpZiBub3QgdGFyZ2V0IGFuZCBub3Qgc291cmNlXG4gICAgICBjb250aW51ZVxuICAgICNpZiBub3QgXy5pc1BsYWluT2JqZWN0KHRhcmdldClcbiAgICAjICB0aHJvdyBuZXcgRXJyb3IoXCJObyB0YXJnZXQgZm9yIGNvbm5lY3Rpb24gI3tpfVwiKVxuICAgICNpZiBub3QgXy5pc1BsYWluT2JqZWN0KHNvdXJjZSlcbiAgICAjICB0aHJvdyBuZXcgRXJyb3IoXCJObyBzb3VyY2UgZm9yIGNvbm5lY3Rpb24gI3tpfVwiKVxuXG5maW5kUG9ydHMgPSAoY29ubmVjdGlvbnMsIHByb2Nlc3NLZXkpIC0+XG4gIHJlc3VsdCA9IFtdXG4gIGZvciBjb25uZWN0aW9uIGluIGNvbm5lY3Rpb25zXG4gICAgaWYgY29ubmVjdGlvbi50Z3RcbiAgICAgIGlmIGNvbm5lY3Rpb24udGd0LnByb2Nlc3MgaXMgcHJvY2Vzc0tleVxuICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAgdHlwZTogXCJJTlBPUlRcIlxuICAgICAgICAgIG5hbWU6IGNvbm5lY3Rpb24udGd0LnBvcnRcbiAgICAgICAgICBwb3J0OiBjb25uZWN0aW9uLnRndFxuICAgICAgICAgIGNvbm5lY3Rpb246IGNvbm5lY3Rpb25cbiAgICAgICAgfSlcbiAgICBpZiBjb25uZWN0aW9uLnNyY1xuICAgICAgaWYgY29ubmVjdGlvbi5zcmMucHJvY2VzcyBpcyBwcm9jZXNzS2V5XG4gICAgICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgICAgICB0eXBlOiBcIk9VVFBPUlRcIlxuICAgICAgICAgIG5hbWU6IGNvbm5lY3Rpb24uc3JjLnBvcnRcbiAgICAgICAgICBwb3J0OiBjb25uZWN0aW9uLnNyY1xuICAgICAgICAgIGNvbm5lY3Rpb246IGNvbm5lY3Rpb25cbiAgICAgICAgfSlcbiAgcmVzdWx0XG5cbm1vZHVsZS5leHBvcnRzID1cbiAgY3JlYXRlRnJvbVNjaGVtYTogY3JlYXRlRnJvbVNjaGVtYSJdfQ==