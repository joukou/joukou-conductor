var SystemDUnitFile, checkForBrokenConnections, createFile, createFromSchema, createOptions, findPorts, generateConnectionKeys, _;

SystemDUnitFile = require("../systemd/unit-file");

_ = require("lodash");

createFromSchema = function(input, machineID, joukouMessageQueAddress, joukouApiAddress) {
  var connections, name, processes;
  if (!_.isPlainObject(input)) {
    throw new TypeError("input is not an object");
  }
  if (!machineID) {
    throw new Error("machineID is required");
  }
  if (typeof machineID !== "string") {
    throw new TypeError("machineID is not a string");
  }
  if (typeof joukouMessageQueAddress !== "string") {
    throw new TypeError("joukouMessageQueAddress is not a string");
  }
  if (typeof joukouApiAddress !== "string") {
    throw new TypeError("joukouApiAddress is not a string");
  }
  if (!_.isPlainObject(input.properties)) {
    throw new TypeError("input.properties is not an object");
  }
  if (!_.isPlainObject(input.processes)) {
    throw new TypeError("input.processes is not an object");
  }
  if (!_.isArray(input.connections)) {
    throw new TypeError("input.connections is not an array");
  }
  name = input.properties.name;
  if (!name) {
    throw new Error("input.properties.name is required");
  }
  connections = _.cloneDeep(input.connections);
  checkForBrokenConnections(connections);
  processes = _.cloneDeep(input.processes);
  return createOptions(name, processes, connections, machineID, joukouMessageQueAddress, joukouApiAddress);
};

createOptions = function(name, processes, connections, machineID, joukouMessageQueAddress, joukouApiAddress) {
  var file, options, process, processKey, unit;
  options = [];

  /*
  use format
  [
    {
      unitName: "name"
      options: [SystemDUnitFile].options
      machineID: machineID
    }
  ]
   */
  for (processKey in processes) {
    if (!processes.hasOwnProperty(processKey)) {
      continue;
    }
    process = processes[processKey];
    unit = {
      process: process,
      processKey: processKey,
      machineID: machineID,
      dockerContainer: process.component,
      ports: findPorts(connections, processKey)
    };
    generateConnectionKeys(unit.ports);
    file = createFile(unit, joukouMessageQueAddress, joukouApiAddress);
    options.push({
      unitName: processKey,
      options: file.options,
      machineID: machineID
    });
  }
  return options;
};

createFile = function(unit, joukouMessageQueAddress, joukouApiAddress) {
  var file, key, port, _i, _len, _ref;
  file = new SystemDUnitFile();
  file.service.addEnvironment("JOUKOU_AMQP_ADDR", joukouMessageQueAddress);
  file.service.addEnvironment("JOUKOU_API_ADDR", joukouApiAddress);
  _ref = unit.ports;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    port = _ref[_i];
    key = "JOUKOU_CIRCLE_" + port.type + "_" + port.name + "_";
    file.service.addEnvironment("" + key + "EXCHANGE", port.port.exchangeKey);
    file.service.addEnvironment("" + key + "ROUTING_KEY", port.port.routingKey);
  }
  file.service.addUser("root");
  file.service.addType("notify");
  file.service.addNotifyAccess("all");
  file.service.addTimeoutStartSec("12min");
  file.service.addTimeoutStopSec("15");
  file.service.addRestart("on-failure");
  file.service.addRestartSec("10s");
  file.service.addEnvironmentFile("/run/docker.env");
  file.service.addExecStartPre("/usr/bin/docker run --rm -v " + "/opt/bin:/opt/bin ibuildthecloud/systemd-docker");
  file.service.addExecStartPre("/usr/bin/docker pull " + unit.dockerContainer);
  file.service.addExecStartPre("-/usr/bin/docker kill %p");
  file.service.addExecStartPre("-/usr/bin/docker rm %p");
  file.service.addExecStart("/opt/bin/systemd-docker run --name %p " + unit.dockerContainer);
  file.service.addExecStop("/usr/bin/docker kill %p");
  file.unit.addDescription("Unit for " + unit.dockerContainer);
  file.unit.addDocumentation(unit.dockerContainer);
  file.unit.addAfter("docker.service");
  file.unit.addRequires("docker.service");
  file.unit.addAfter("rabbitmq.service");
  file.unit.addRequires("rabbitmq.service");
  file.unit.addAfter("riak.service");
  file.unit.addRequires("riak.service");
  return file;
};

generateConnectionKeys = function(ports) {
  var port, portObject, _i, _len, _results;
  _results = [];
  for (_i = 0, _len = ports.length; _i < _len; _i++) {
    portObject = ports[_i];
    port = portObject.port;
    if (!port.exchangeKey) {
      port.exchangeKey = "FAKE_EXCHANGE";
      _results.push(port.routingKey = "FAKE_ROUTING");
    } else {
      _results.push(void 0);
    }
  }
  return _results;
};

checkForBrokenConnections = function(connections) {
  var connection, i, source, target, _results;
  i = 0;
  _results = [];
  while (i < connections.length) {
    connection = connections[i];
    i++;
    if (!_.isPlainObject(connection)) {
      continue;
    }
    target = connection["tgt"];
    source = connection["src"];
    if (!target && !source) {
      continue;
    } else {
      _results.push(void 0);
    }
  }
  return _results;
};

findPorts = function(connections, processKey) {
  var connection, result, _i, _len;
  result = [];
  for (_i = 0, _len = connections.length; _i < _len; _i++) {
    connection = connections[_i];
    if (connection.tgt) {
      if (connection.tgt.process === processKey) {
        result.push({
          type: "INPORT",
          name: connection.tgt.port,
          port: connection.tgt,
          connection: connection
        });
      }
    }
    if (connection.src) {
      if (connection.src.process === processKey) {
        result.push({
          type: "OUTPORT",
          name: connection.src.port,
          port: connection.src,
          connection: connection
        });
      }
    }
  }
  return result;
};

module.exports = {
  createFromSchema: createFromSchema
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZmxvL3N5c3RlbWQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsNkhBQUE7O0FBQUEsZUFBQSxHQUFrQixPQUFBLENBQVEsc0JBQVIsQ0FBbEIsQ0FBQTs7QUFBQSxDQUNBLEdBQWtCLE9BQUEsQ0FBUSxRQUFSLENBRGxCLENBQUE7O0FBQUEsZ0JBR0EsR0FBbUIsU0FBQyxLQUFELEVBQ0EsU0FEQSxFQUVBLHVCQUZBLEVBR0EsZ0JBSEEsR0FBQTtBQUlqQixNQUFBLDRCQUFBO0FBQUEsRUFBQSxJQUFHLENBQUEsQ0FBSyxDQUFDLGFBQUYsQ0FBZ0IsS0FBaEIsQ0FBUDtBQUNFLFVBQVUsSUFBQSxTQUFBLENBQVUsd0JBQVYsQ0FBVixDQURGO0dBQUE7QUFFQSxFQUFBLElBQUcsQ0FBQSxTQUFIO0FBQ0UsVUFBVSxJQUFBLEtBQUEsQ0FBTSx1QkFBTixDQUFWLENBREY7R0FGQTtBQUlBLEVBQUEsSUFBRyxNQUFBLENBQUEsU0FBQSxLQUFzQixRQUF6QjtBQUNFLFVBQVUsSUFBQSxTQUFBLENBQVUsMkJBQVYsQ0FBVixDQURGO0dBSkE7QUFNQSxFQUFBLElBQUcsTUFBQSxDQUFBLHVCQUFBLEtBQW9DLFFBQXZDO0FBQ0UsVUFBVSxJQUFBLFNBQUEsQ0FBVSx5Q0FBVixDQUFWLENBREY7R0FOQTtBQVFBLEVBQUEsSUFBRyxNQUFBLENBQUEsZ0JBQUEsS0FBNkIsUUFBaEM7QUFDRSxVQUFVLElBQUEsU0FBQSxDQUFVLGtDQUFWLENBQVYsQ0FERjtHQVJBO0FBVUEsRUFBQSxJQUFHLENBQUEsQ0FBSyxDQUFDLGFBQUYsQ0FBZ0IsS0FBSyxDQUFDLFVBQXRCLENBQVA7QUFDRSxVQUFVLElBQUEsU0FBQSxDQUFVLG1DQUFWLENBQVYsQ0FERjtHQVZBO0FBWUEsRUFBQSxJQUFHLENBQUEsQ0FBSyxDQUFDLGFBQUYsQ0FBZ0IsS0FBSyxDQUFDLFNBQXRCLENBQVA7QUFDRSxVQUFVLElBQUEsU0FBQSxDQUFVLGtDQUFWLENBQVYsQ0FE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LFVBQVUsQ0FBQyxHQUFHLENBQUMsT0FBZixLQUEwQixVQUE3QjtBQUNFLFFBQUEsTUFBTSxDQUFDLElBQVAsQ0FBWTtBQUFBLFVBQ1YsSUFBQSxFQUFNLFNBREk7QUFBQSxVQUVWLElBQUEsRUFBTSxVQUFVLENBQUMsR0FBRyxDQUFDLElBRlg7QUFBQSxVQUdWLElBQUEsRUFBTSxVQUFVLENBQUMsR0FIUDtBQUFBLFVBSVYsVUFBQSxFQUFZLFVBSkY7U0FBWixDQUFBLENBREY7T0FERjtLQVRGO0FBQUEsR0FEQTtTQWtCQSxPQW5CVTtBQUFBLENBN0taLENBQUE7O0FBQUEsTUFrTU0sQ0FBQyxPQUFQLEdBQ0U7QUFBQSxFQUFBLGdCQUFBLEVBQWtCLGdCQUFsQjtDQW5NRixDQUFBIiwiZmlsZSI6Im5vZmxvL3N5c3RlbWQuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJTeXN0ZW1EVW5pdEZpbGUgPSByZXF1aXJlKFwiLi4vc3lzdGVtZC91bml0LWZpbGVcIilcbl8gICAgICAgICAgICAgICA9IHJlcXVpcmUoXCJsb2Rhc2hcIilcblxuY3JlYXRlRnJvbVNjaGVtYSA9IChpbnB1dCxcbiAgICAgICAgICAgICAgICAgICBtYWNoaW5lSUQsXG4gICAgICAgICAgICAgICAgICAgam91a291TWVzc2FnZVF1ZUFkZHJlc3MsXG4gICAgICAgICAgICAgICAgICAgam91a291QXBpQWRkcmVzcykgLT5cbiAgaWYgbm90IF8uaXNQbGFpbk9iamVjdChpbnB1dClcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiaW5wdXQgaXMgbm90IGFuIG9iamVjdFwiKVxuICBpZiBub3QgbWFjaGluZUlEXG4gICAgdGhyb3cgbmV3IEVycm9yKFwibWFjaGluZUlEIGlzIHJlcXVpcmVkXCIpXG4gIGlmIHR5cGVvZiBtYWNoaW5lSUQgaXNudCBcInN0cmluZ1wiXG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIm1hY2hpbmVJRCBpcyBub3QgYSBzdHJpbmdcIilcbiAgaWYgdHlwZW9mIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzIGlzbnQgXCJzdHJpbmdcIlxuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJqb3Vrb3VNZXNzYWdlUXVlQWRkcmVzcyBpcyBub3QgYSBzdHJpbmdcIilcbiAgaWYgdHlwZW9mIGpvdWtvdUFwaUFkZHJlc3MgaXNudCBcInN0cmluZ1wiXG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImpvdWtvdUFwaUFkZHJlc3MgaXMgbm90IGEgc3RyaW5nXCIpXG4gIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QoaW5wdXQucHJvcGVydGllcylcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiaW5wdXQucHJvcGVydGllcyBpcyBub3QgYW4gb2JqZWN0XCIpXG4gIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QoaW5wdXQucHJvY2Vzc2VzKVxuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJpbnB1dC5wcm9jZXNzZXMgaXMgbm90IGFuIG9iamVjdFwiKVxuICBpZiBub3QgXy5pc0FycmF5KGlucHV0LmNvbm5lY3Rpb25zKVxuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJpbnB1dC5jb25uZWN0aW9ucyBpcyBub3QgYW4gYXJyYXlcIilcbiAgbmFtZSA9IGlucHV0LnByb3BlcnRpZXMubmFtZVxuICBpZiBub3QgbmFtZVxuICAgIHRocm93IG5ldyBFcnJvcihcImlucHV0LnByb3BlcnRpZXMubmFtZSBpcyByZXF1aXJlZFwiKVxuICBjb25uZWN0aW9ucyA9IF8uY2xvbmVEZWVwKGlucHV0LmNvbm5lY3Rpb25zKVxuICBjaGVja0ZvckJyb2tlbkNvbm5lY3Rpb25zKGNvbm5lY3Rpb25zKVxuICBwcm9jZXNzZXMgPSBfLmNsb25lRGVlcChpbnB1dC5wcm9jZXNzZXMpXG4gIHJldHVybiBjcmVhdGVPcHRpb25zKFxuICAgIG5hbWUsXG4gICAgcHJvY2Vzc2VzLFxuICAgIGNvbm5lY3Rpb25zLFxuICAgIG1hY2hpbmVJRCxcbiAgICBqb3Vrb3VNZXNzYWdlUXVlQWRkcmVzcyxcbiAgICBqb3Vrb3VBcGlBZGRyZXNzXG4gIClcblxuY3JlYXRlT3B0aW9ucyA9IChuYW1lLFxuICAgICAgICAgICAgICAgICBwcm9jZXNzZXMsXG4gICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25zLFxuICAgICAgICAgICAgICAgICBtYWNoaW5lSUQsXG4gICAgICAgICAgICAgICAgIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzLFxuICAgICAgICAgICAgICAgICBqb3Vrb3VBcGlBZGRyZXNzKSAtPlxuICBvcHRpb25zID0gW11cbiAgIyMjXG4gIHVzZSBmb3JtYXRcbiAgW1xuICAgIHtcbiAgICAgIHVuaXROYW1lOiBcIm5hbWVcIlxuICAgICAgb3B0aW9uczogW1N5c3RlbURVbml0RmlsZV0ub3B0aW9uc1xuICAgICAgbWFjaGluZUlEOiBtYWNoaW5lSURcbiAgICB9XG4gIF1cbiAgIyMjXG4gIGZvciBwcm9jZXNzS2V5IG9mIHByb2Nlc3Nlc1xuICAgIGlmIG5vdCBwcm9jZXNzZXMuaGFzT3duUHJvcGVydHkocHJvY2Vzc0tleSlcbiAgICAgIGNvbnRpbnVlXG4gICAgcHJvY2VzcyA9IHByb2Nlc3Nlc1twcm9jZXNzS2V5XVxuICAgIHVuaXQgPSB7XG4gICAgICBwcm9jZXNzOiBwcm9jZXNzXG4gICAgICBwcm9jZXNzS2V5OiBwcm9jZXNzS2V5XG4gICAgICBtYWNoaW5lSUQ6IG1hY2hpbmVJRFxuICAgICAgZG9ja2VyQ29udGFpbmVyOiBwcm9jZXNzLmNvbXBvbmVudFxuICAgICAgcG9ydHM6IGZpbmRQb3J0cyhjb25uZWN0aW9ucywgcHJvY2Vzc0tleSlcbiAgICB9XG4gICAgZ2VuZXJhdGVDb25uZWN0aW9uS2V5cyh1bml0LnBvcnRzKVxuICAgIGZpbGUgPSBjcmVhdGVGaWxlKFxuICAgICAgdW5pdCxcbiAgICAgIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzLFxuICAgICAgam91a291QXBpQWRkcmVzc1xuICAgIClcbiAgICBvcHRpb25zLnB1c2goe1xuICAgICAgdW5pdE5hbWU6IHByb2Nlc3NLZXlcbiAgICAgIG9wdGlvbnM6IGZpbGUub3B0aW9uc1xuICAgICAgbWFjaGluZUlEOiBtYWNoaW5lSURcbiAgICB9KVxuXG4gIHJldHVybiBvcHRpb25zXG5cbmNyZWF0ZUZpbGUgPSAodW5pdCxcbiAgICAgICAgICAgICAgam91a291TWVzc2FnZVF1ZUFkZHJlc3MsXG4gICAgICAgICAgICAgIGpvdWtvdUFwaUFkZHJlc3MpIC0+XG5cbiAgZmlsZSA9IG5ldyBTeXN0ZW1EVW5pdEZpbGUoKVxuICBmaWxlLnNlcnZpY2UuYWRkRW52aXJvbm1lbnQoXCJKT1VLT1VfQU1RUF9BRERSXCIsIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzKVxuICBmaWxlLnNlcnZpY2UuYWRkRW52aXJvbm1lbnQoXCJKT1VLT1VfQVBJX0FERFJcIiwgam91a291QXBpQWRkcmVzcylcblxuICBmb3IgcG9ydCBpbiB1bml0LnBvcnRzXG4gICAga2V5ID0gXCJKT1VLT1VfQ0lSQ0xFXyN7cG9ydC50eXBlfV8je3BvcnQubmFtZX1fXCJcbiAgICBmaWxlLnNlcnZpY2UuYWRkRW52aXJvbm1lbnQoXCIje2tleX1FWENIQU5HRVwiLCBwb3J0LnBvcnQuZXhjaGFuZ2VLZXkpXG4gICAgZmlsZS5zZXJ2aWNlLmFkZEVudmlyb25tZW50KFwiI3trZXl9Uk9VVElOR19LRVlcIiwgcG9ydC5wb3J0LnJvdXRpbmdLZXkpXG5cbiAgIyBSdW4gYXMgcm9vdCBiZWNhdXNlXG4gICMgLSBzeXN0ZW1kLWRvY2tlciByZXF1aXJlcyByb290IHByaXZpbGVnZXNcbiAgIyAtIC9yb290Ly5kb2NrZXJjZmcgZm9yIHJlZ2lzdHJ5IGF1dGhlbnRpY2F0aW9uXG4gIGZpbGUuc2VydmljZS5hZGRVc2VyKFwicm9vdFwiKVxuXG4gICMgc2Rfbm90aWZ5KDMpIGlzIHJlcXVpcmVkIGJ5IHN5c3RlbWQtZG9ja2VyXG4gIGZpbGUuc2VydmljZS5hZGRUeXBlKFwibm90aWZ5XCIpXG4gIGZpbGUuc2VydmljZS5hZGROb3RpZnlBY2Nlc3MoXCJhbGxcIilcblxuICAjIExhcmdlIHN0YXJ0IHRpbWVvdXQgaXMgdG8gYWxsb3cgZm9yIHB1bGxpbmcgZG93biBEb2NrZXIgaW1hZ2VzIGZyb20gcXVheS5pb1xuICBmaWxlLnNlcnZpY2UuYWRkVGltZW91dFN0YXJ0U2VjKFwiMTJtaW5cIilcbiAgZmlsZS5zZXJ2aWNlLmFkZFRpbWVvdXRTdG9wU2VjKFwiMTVcIilcblxuICBmaWxlLnNlcnZpY2UuYWRkUmVzdGFydChcIm9uLWZhaWx1cmVcIilcbiAgZmlsZS5zZXJ2aWNlLmFkZFJlc3RhcnRTZWMoXCIxMHNcIilcblxuICBmaWxlLnNlcnZpY2UuYWRkRW52aXJvbm1lbnRGaWxlKFwiL3J1bi9kb2NrZXIuZW52XCIpXG5cbiAgZmlsZS5zZXJ2aWNlLmFkZEV4ZWNTdGFydFByZShcbiAgICBcIi91c3IvYmluL2RvY2tlciBydW4gLS1ybSAtdiBcIiArXG4gICAgXCIvb3B0L2Jpbjovb3B0L2JpbiBpYnVpbGR0aGVjbG91ZC9zeXN0ZW1kLWRvY2tlclwiXG4gIClcbiAgZmlsZS5zZXJ2aWNlLmFkZEV4ZWNTdGFydFByZShcbiAgICBcIi91c3IvYmluL2RvY2tlciBwdWxsICN7dW5pdC5kb2NrZXJDb250YWluZXJ9XCJcbiAgKVxuXG4gIGZpbGUuc2VydmljZS5hZGRFeGVjU3RhcnRQcmUoXCItL3Vzci9iaW4vZG9ja2VyIGtpbGwgJXBcIilcbiAgZmlsZS5zZXJ2aWNlLmFkZEV4ZWNTdGFydFByZShcIi0vdXNyL2Jpbi9kb2NrZXIgcm0gJXBcIilcblxuICBmaWxlLnNlcnZpY2UuYWRkRXhlY1N0YXJ0KFxuICAgIFwiL29wdC9iaW4vc3lzdGVtZC1kb2NrZXIgcnVuIC0tbmFtZSAlcCAje3VuaXQuZG9ja2VyQ29udGFpbmVyfVwiXG4gIClcblxuICBmaWxlLnNlcnZpY2UuYWRkRXhlY1N0b3AoXCIvdXNyL2Jpbi9kb2NrZXIga2lsbCAlcFwiKVxuXG4gIGZpbGUudW5pdC5hZGREZXNjcmlwdGlvbihcIlVuaXQgZm9yICN7dW5pdC5kb2NrZXJDb250YWluZXJ9XCIpXG4gIGZpbGUudW5pdC5hZGREb2N1bWVudGF0aW9uKHVuaXQuZG9ja2VyQ29udGFpbmVyKVxuXG4gICMgUmVxdWlyZXMgZG9ja2VyXG4gIGZpbGUudW5pdC5hZGRBZnRlcihcImRvY2tlci5zZXJ2aWNlXCIpXG4gIGZpbGUudW5pdC5hZGRSZXF1aXJlcyhcImRvY2tlci5zZXJ2aWNlXCIpXG5cbiAgIyBSZXF1aXJlcyByYWJiaXRtcVxuICBmaWxlLnVuaXQuYWRkQWZ0ZXIoXCJyYWJiaXRtcS5zZXJ2aWNlXCIpXG4gIGZpbGUudW5pdC5hZGRSZXF1aXJlcyhcInJhYmJpdG1xLnNlcnZpY2VcIilcblxuICAjIFJlcXVpcmVzIHJpYWsgKGRvZXMgaXQ/KVxuICBmaWxlLnVuaXQuYWRkQWZ0ZXIoXCJyaWFrLnNlcnZpY2VcIilcbiAgZmlsZS51bml0LmFkZFJlcXVpcmVzKFwicmlhay5zZXJ2aWNlXCIpXG5cbiAgIyBBZGQgYW55IG1vcmUgcmVxdWlyZWQgdW5pdHNcblxuICByZXR1cm4gZmlsZVxuXG5nZW5lcmF0ZUNvbm5lY3Rpb25LZXlzID0gKHBvcnRzKSAtPlxuICAjIE5vdCB0byBzdXJlIHdoYXQgSXNhYWMgd2FudHMgdG8gYmVcbiAgIyBkb25lIGhlcmUsIGFkZCBmYWtlcyBmb3Igbm93XG4gIGZvciBwb3J0T2JqZWN0IGluIHBvcnRzXG4gICAgcG9ydCA9IHBvcnRPYmplY3QucG9ydFxuICAgIGlmIG5vdCBwb3J0LmV4Y2hhbmdlS2V5XG4gICAgICBwb3J0LmV4Y2hhbmdlS2V5ID0gXCJGQUtFX0VYQ0hBTkdFXCJcbiAgICAgIHBvcnQucm91dGluZ0tleSA9IFwiRkFLRV9ST1VUSU5HXCJcblxuY2hlY2tGb3JCcm9rZW5Db25uZWN0aW9ucyA9IChjb25uZWN0aW9ucykgLT5cbiAgaSA9IDBcbiAgd2hpbGUgaSA8IGNvbm5lY3Rpb25zLmxlbmd0aFxuICAgIGNvbm5lY3Rpb24gPSBjb25uZWN0aW9uc1tpXVxuICAgIGkrK1xuICAgIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QoY29ubmVjdGlvbilcbiAgICAgIGNvbnRpbnVlXG4gICAgdGFyZ2V0ID0gY29ubmVjdGlvbltcInRndFwiXVxuICAgIHNvdXJjZSA9IGNvbm5lY3Rpb25bXCJzcmNcIl1cbiAgICBpZiBub3QgdGFyZ2V0IGFuZCBub3Qgc291cmNlXG4gICAgICBjb250aW51ZVxuICAgICNDb21tZW50IG91dCBmb3Igbm93IHNvIHdlIGNhbiBkbyBkZW1vcyB3aXRoIHBob3RvYm9vdGguanNvblxuICAgICNpZiBub3QgXy5pc1BsYWluT2JqZWN0KHRhcmdldClcbiAgICAjICB0aHJvdyBuZXcgRXJyb3IoXCJObyB0YXJnZXQgZm9yIGNvbm5lY3Rpb24gI3tpfVwiKVxuICAgICNpZiBub3QgXy5pc1BsYWluT2JqZWN0KHNvdXJjZSlcbiAgICAjICB0aHJvdyBuZXcgRXJyb3IoXCJObyBzb3VyY2UgZm9yIGNvbm5lY3Rpb24gI3tpfVwiKVxuXG5maW5kUG9ydHMgPSAoY29ubmVjdGlvbnMsIHByb2Nlc3NLZXkpIC0+XG4gIHJlc3VsdCA9IFtdXG4gIGZvciBjb25uZWN0aW9uIGluIGNvbm5lY3Rpb25zXG4gICAgaWYgY29ubmVjdGlvbi50Z3RcbiAgICAgIGlmIGNvbm5lY3Rpb24udGd0LnByb2Nlc3MgaXMgcHJvY2Vzc0tleVxuICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAgdHlwZTogXCJJTlBPUlRcIlxuICAgICAgICAgIG5hbWU6IGNvbm5lY3Rpb24udGd0LnBvcnRcbiAgICAgICAgICBwb3J0OiBjb25uZWN0aW9uLnRndFxuICAgICAgICAgIGNvbm5lY3Rpb246IGNvbm5lY3Rpb25cbiAgICAgICAgfSlcbiAgICBpZiBjb25uZWN0aW9uLnNyY1xuICAgICAgaWYgY29ubmVjdGlvbi5zcmMucHJvY2VzcyBpcyBwcm9jZXNzS2V5XG4gICAgICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgICAgICB0eXBlOiBcIk9VVFBPUlRcIlxuICAgICAgICAgIG5hbWU6IGNvbm5lY3Rpb24uc3JjLnBvcnRcbiAgICAgICAgICBwb3J0OiBjb25uZWN0aW9uLnNyY1xuICAgICAgICAgIGNvbm5lY3Rpb246IGNvbm5lY3Rpb25cbiAgICAgICAgfSlcbiAgcmVzdWx0XG5cbm1vZHVsZS5leHBvcnRzID1cbiAgY3JlYXRlRnJvbVNjaGVtYTogY3JlYXRlRnJvbVNjaGVtYSJdfQ==