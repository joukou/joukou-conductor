var SystemDUnitFile, checkForBrokenConnections, createFile, createFromSchema, createOptions, findPorts, generateConnectionKeys, _;

SystemDUnitFile = require("../systemd/unit-file");

_ = require("lodash");

createFromSchema = function(input, machineID, joukouMessageQueAddress, joukouApiAddress, joukouGraphExchangeKey) {
  var connections, name, processes;
  if (!_.isPlainObject(input)) {
    throw new TypeError("input is not an object");
  }
  if (typeof joukouMessageQueAddress !== "string") {
    throw new TypeError("joukouMessageQueAddress is not a string");
  }
  if (typeof joukouApiAddress !== "string") {
    throw new TypeError("joukouApiAddress is not a string");
  }
  if (typeof joukouGraphExchangeKey !== "string") {
    throw new TypeError("joukouGraphExchangeKey is not a string");
  }
  if (!_.isPlainObject(input.properties)) {
    throw new TypeError("input.properties is not an object");
  }
  if (!_.isPlainObject(input.processes)) {
    throw new TypeError("input.processes is not an object");
  }
  if (!_.isArray(input.connections)) {
    throw new TypeError("input.connections is not an array");
  }
  name = input.properties.name;
  if (!name) {
    throw new Error("input.properties.name is required");
  }
  connections = _.cloneDeep(input.connections);
  checkForBrokenConnections(connections);
  processes = _.cloneDeep(input.processes);
  return createOptions(name, processes, connections, machineID, joukouMessageQueAddress, joukouApiAddress, joukouGraphExchangeKey);
};

createOptions = function(name, processes, connections, machineID, joukouMessageQueAddress, joukouApiAddress, joukouGraphExchangeKey) {
  var file, options, process, processKey, unit;
  options = [];

  /*
  use format
  [
    {
      unitName: "name"
      options: [SystemDUnitFile].options
      machineID: machineID
    }
  ]
   */
  for (processKey in processes) {
    if (!processes.hasOwnProperty(processKey)) {
      continue;
    }
    process = processes[processKey];
    unit = {
      process: process,
      processKey: processKey,
      machineID: machineID,
      dockerContainer: process.component,
      ports: findPorts(connections, processKey)
    };
    generateConnectionKeys(unit.ports, joukouGraphExchangeKey);
    file = createFile(unit, joukouMessageQueAddress, joukouApiAddress);
    options.push({
      unitName: processKey,
      options: file.options,
      machineID: machineID
    });
  }
  return options;
};

createFile = function(unit, joukouMessageQueAddress, joukouApiAddress) {
  var file, key, port, _i, _len, _ref;
  file = new SystemDUnitFile();
  file.service.addEnvironment("JOUKOU_AMQP_ADDR", joukouMessageQueAddress);
  file.service.addEnvironment("JOUKOU_API_ADDR", joukouApiAddress);
  _ref = unit.ports;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    port = _ref[_i];
    if (!port || !port.port) {
      continue;
    }
    key = "JOUKOU_CIRCLE_" + port.type + "_" + port.name + "_";
    file.service.addEnvironment("" + key + "EXCHANGE", port.port.exchangeKey);
    file.service.addEnvironment("" + key + "ROUTING_KEY", port.port.routingKey);
  }
  file.service.addUser("root");
  file.service.addType("notify");
  file.service.addNotifyAccess("all");
  file.service.addTimeoutStartSec("12min");
  file.service.addTimeoutStopSec("15");
  file.service.addRestart("on-failure");
  file.service.addRestartSec("10s");
  file.service.addEnvironmentFile("/run/docker.env");
  file.service.addExecStartPre("/usr/bin/docker run --rm -v " + "/opt/bin:/opt/bin ibuildthecloud/systemd-docker");
  file.service.addExecStartPre("/usr/bin/docker pull " + unit.dockerContainer);
  file.service.addExecStartPre("-/usr/bin/docker kill %p");
  file.service.addExecStartPre("-/usr/bin/docker rm %p");
  file.service.addExecStart("/opt/bin/systemd-docker run --name %p " + unit.dockerContainer);
  file.service.addExecStop("/usr/bin/docker kill %p");
  file.unit.addDescription("Unit for " + unit.dockerContainer);
  file.unit.addDocumentation(unit.dockerContainer);
  file.unit.addAfter("docker.service");
  file.unit.addRequires("docker.service");
  file.unit.addAfter("rabbitmq.service");
  file.unit.addRequires("rabbitmq.service");
  file.unit.addAfter("api.service");
  file.unit.addRequires("api.service");
  return file;
};

generateConnectionKeys = function(ports, joukouGraphExchangeKey) {
  var port, portObject, _i, _len, _results;
  _results = [];
  for (_i = 0, _len = ports.length; _i < _len; _i++) {
    portObject = ports[_i];
    port = portObject.port;
    if (port && !port.exchangeKey) {
      port.exchangeKey = joukouGraphExchangeKey;
      _results.push(port.routingKey = "" + (portObject.source || portObject.process) + "_" + portObject.name);
    } else {
      _results.push(void 0);
    }
  }
  return _results;
};

checkForBrokenConnections = function(connections) {
  var connection, i, source, target, _results;
  i = 0;
  _results = [];
  while (i < connections.length) {
    connection = connections[i];
    i++;
    if (!_.isPlainObject(connection)) {
      continue;
    }
    target = connection["tgt"];
    source = connection["src"];
    if (!target && !source) {
      continue;
    } else {
      _results.push(void 0);
    }
  }
  return _results;
};

findPorts = function(connections, processKey) {
  var connection, result, source, _i, _len;
  result = [];
  for (_i = 0, _len = connections.length; _i < _len; _i++) {
    connection = connections[_i];
    source = null;
    if (connection.src) {
      source = connection.src.process;
      if (connection.src.process === processKey) {
        if (typeof connection.src.port !== "string") {
          throw new TypeError("Port name is expected to be a string");
        }
        result.push({
          type: "OUTPORT",
          name: connection.src.port.toUpperCase(),
          port: connection.src,
          connection: connection,
          source: source,
          process: processKey
        });
      }
    }
    if (connection.tgt) {
      if (connection.tgt.process === processKey) {
        if (typeof connection.tgt.port !== "string") {
          throw new TypeError("Port name is expected to be a string");
        }
        result.push({
          type: "INPORT",
          name: connection.tgt.port.toUpperCase(),
          port: connection.tgt,
          connection: connection,
          source: source,
          process: processKey
        });
      }
    }
  }
  return result;
};

module.exports = {
  createFromSchema: createFromSchema
};

//# sourceMappingURL=data:application/json;base64,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QSxFQUFrQixnQkFBbEI7Q0FyTkYsQ0FBQSIsImZpbGUiOiJub2Zsby9zeXN0ZW1kLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiU3lzdGVtRFVuaXRGaWxlID0gcmVxdWlyZShcIi4uL3N5c3RlbWQvdW5pdC1maWxlXCIpXG5fICAgICAgICAgICAgICAgPSByZXF1aXJlKFwibG9kYXNoXCIpXG5cbmNyZWF0ZUZyb21TY2hlbWEgPSAoaW5wdXQsXG4gICAgICAgICAgICAgICAgICAgbWFjaGluZUlELFxuICAgICAgICAgICAgICAgICAgIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzLFxuICAgICAgICAgICAgICAgICAgIGpvdWtvdUFwaUFkZHJlc3MsXG4gICAgICAgICAgICAgICAgICAgam91a291R3JhcGhFeGNoYW5nZUtleSkgLT5cbiAgaWYgbm90IF8uaXNQbGFpbk9iamVjdChpbnB1dClcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiaW5wdXQgaXMgbm90IGFuIG9iamVjdFwiKVxuICAjIGlmIG5vdCBtYWNoaW5lSURcbiAgIyAgIHRocm93IG5ldyBFcnJvcihcIm1hY2hpbmVJRCBpcyByZXF1aXJlZFwiKVxuICAjaWYgdHlwZW9mIG1hY2hpbmVJRCBpc250IFwic3RyaW5nXCJcbiAgIyAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIm1hY2hpbmVJRCBpcyBub3QgYSBzdHJpbmdcIilcbiAgaWYgdHlwZW9mIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzIGlzbnQgXCJzdHJpbmdcIlxuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJqb3Vrb3VNZXNzYWdlUXVlQWRkcmVzcyBpcyBub3QgYSBzdHJpbmdcIilcbiAgaWYgdHlwZW9mIGpvdWtvdUFwaUFkZHJlc3MgaXNudCBcInN0cmluZ1wiXG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImpvdWtvdUFwaUFkZHJlc3MgaXMgbm90IGEgc3RyaW5nXCIpXG4gIGlmIHR5cGVvZiBqb3Vrb3VHcmFwaEV4Y2hhbmdlS2V5IGlzbnQgXCJzdHJpbmdcIlxuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJqb3Vrb3VHcmFwaEV4Y2hhbmdlS2V5IGlzIG5vdCBhIHN0cmluZ1wiKVxuICBpZiBub3QgXy5pc1BsYWluT2JqZWN0KGlucHV0LnByb3BlcnRpZXMpXG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcImlucHV0LnByb3BlcnRpZXMgaXMgbm90IGFuIG9iamVjdFwiKVxuICBpZiBub3QgXy5pc1BsYWluT2JqZWN0KGlucHV0LnByb2Nlc3NlcylcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiaW5wdXQucHJvY2Vzc2VzIGlzIG5vdCBhbiBvYmplY3RcIilcbiAgaWYgbm90IF8uaXNBcnJheShpbnB1dC5jb25uZWN0aW9ucylcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiaW5wdXQuY29ubmVjdGlvbnMgaXMgbm90IGFuIGFycmF5XCIpXG4gIG5hbWUgPSBpbnB1dC5wcm9wZXJ0aWVzLm5hbWVcbiAgaWYgbm90IG5hbWVcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJpbnB1dC5wcm9wZXJ0aWVzLm5hbWUgaXMgcmVxdWlyZWRcIilcbiAgY29ubmVjdGlvbnMgPSBfLmNsb25lRGVlcChpbnB1dC5jb25uZWN0aW9ucylcbiAgY2hlY2tGb3JCcm9rZW5Db25uZWN0aW9ucyhjb25uZWN0aW9ucylcbiAgcHJvY2Vzc2VzID0gXy5jbG9uZURlZXAoaW5wdXQucHJvY2Vzc2VzKVxuICByZXR1cm4gY3JlYXRlT3B0aW9ucyhcbiAgICBuYW1lLFxuICAgIHByb2Nlc3NlcyxcbiAgICBjb25uZWN0aW9ucyxcbiAgICBtYWNoaW5lSUQsXG4gICAgam91a291TWVzc2FnZVF1ZUFkZHJlc3MsXG4gICAgam91a291QXBpQWRkcmVzcyxcbiAgICBqb3Vrb3VHcmFwaEV4Y2hhbmdlS2V5XG4gIClcblxuY3JlYXRlT3B0aW9ucyA9IChuYW1lLFxuICAgICAgICAgICAgICAgICBwcm9jZXNzZXMsXG4gICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25zLFxuICAgICAgICAgICAgICAgICBtYWNoaW5lSUQsXG4gICAgICAgICAgICAgICAgIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzLFxuICAgICAgICAgICAgICAgICBqb3Vrb3VBcGlBZGRyZXNzLFxuICAgICAgICAgICAgICAgICBqb3Vrb3VHcmFwaEV4Y2hhbmdlS2V5KSAtPlxuICBvcHRpb25zID0gW11cbiAgIyMjXG4gIHVzZSBmb3JtYXRcbiAgW1xuICAgIHtcbiAgICAgIHVuaXROYW1lOiBcIm5hbWVcIlxuICAgICAgb3B0aW9uczogW1N5c3RlbURVbml0RmlsZV0ub3B0aW9uc1xuICAgICAgbWFjaGluZUlEOiBtYWNoaW5lSURcbiAgICB9XG4gIF1cbiAgIyMjXG4gIGZvciBwcm9jZXNzS2V5IG9mIHByb2Nlc3Nlc1xuICAgIGlmIG5vdCBwcm9jZXNzZXMuaGFzT3duUHJvcGVydHkocHJvY2Vzc0tleSlcbiAgICAgIGNvbnRpbnVlXG4gICAgcHJvY2VzcyA9IHByb2Nlc3Nlc1twcm9jZXNzS2V5XVxuICAgIHVuaXQgPSB7XG4gICAgICBwcm9jZXNzOiBwcm9jZXNzXG4gICAgICBwcm9jZXNzS2V5OiBwcm9jZXNzS2V5XG4gICAgICBtYWNoaW5lSUQ6IG1hY2hpbmVJRFxuICAgICAgZG9ja2VyQ29udGFpbmVyOiBwcm9jZXNzLmNvbXBvbmVudFxuICAgICAgcG9ydHM6IGZpbmRQb3J0cyhjb25uZWN0aW9ucywgcHJvY2Vzc0tleSlcbiAgICB9XG4gICAgZ2VuZXJhdGVDb25uZWN0aW9uS2V5cyh1bml0LnBvcnRzLCBqb3Vrb3VHcmFwaEV4Y2hhbmdlS2V5KVxuICAgIGZpbGUgPSBjcmVhdGVGaWxlKFxuICAgICAgdW5pdCxcbiAgICAgIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzLFxuICAgICAgam91a291QXBpQWRkcmVzc1xuICAgIClcbiAgICBvcHRpb25zLnB1c2goe1xuICAgICAgdW5pdE5hbWU6IHByb2Nlc3NLZXlcbiAgICAgIG9wdGlvbnM6IGZpbGUub3B0aW9uc1xuICAgICAgbWFjaGluZUlEOiBtYWNoaW5lSURcbiAgICB9KVxuXG4gIHJldHVybiBvcHRpb25zXG5cbmNyZWF0ZUZpbGUgPSAodW5pdCxcbiAgICAgICAgICAgICAgam91a291TWVzc2FnZVF1ZUFkZHJlc3MsXG4gICAgICAgICAgICAgIGpvdWtvdUFwaUFkZHJlc3MpIC0+XG5cbiAgZmlsZSA9IG5ldyBTeXN0ZW1EVW5pdEZpbGUoKVxuICBmaWxlLnNlcnZpY2UuYWRkRW52aXJvbm1lbnQoXCJKT1VLT1VfQU1RUF9BRERSXCIsIGpvdWtvdU1lc3NhZ2VRdWVBZGRyZXNzKVxuICBmaWxlLnNlcnZpY2UuYWRkRW52aXJvbm1lbnQoXCJKT1VLT1VfQVBJX0FERFJcIiwgam91a291QXBpQWRkcmVzcylcblxuICBmb3IgcG9ydCBpbiB1bml0LnBvcnRzXG4gICAgaWYgbm90IHBvcnQgb3Igbm90IHBvcnQucG9ydFxuICAgICAgY29udGludWVcbiAgICBrZXkgPSBcIkpPVUtPVV9DSVJDTEVfI3twb3J0LnR5cGV9XyN7cG9ydC5uYW1lfV9cIlxuICAgIGZpbGUuc2VydmljZS5hZGRFbnZpcm9ubWVudChcIiN7a2V5fUVYQ0hBTkdFXCIsIHBvcnQucG9ydC5leGNoYW5nZUtleSlcbiAgICBmaWxlLnNlcnZpY2UuYWRkRW52aXJvbm1lbnQoXCIje2tleX1ST1VUSU5HX0tFWVwiLCBwb3J0LnBvcnQucm91dGluZ0tleSlcblxuICAjIFJ1biBhcyByb290IGJlY2F1c2VcbiAgIyAtIHN5c3RlbWQtZG9ja2VyIHJlcXVpcmVzIHJvb3QgcHJpdmlsZWdlc1xuICAjIC0gL3Jvb3QvLmRvY2tlcmNmZyBmb3IgcmVnaXN0cnkgYXV0aGVudGljYXRpb25cbiAgZmlsZS5zZXJ2aWNlLmFkZFVzZXIoXCJyb290XCIpXG5cbiAgIyBzZF9ub3RpZnkoMykgaXMgcmVxdWlyZWQgYnkgc3lzdGVtZC1kb2NrZXJcbiAgZmlsZS5zZXJ2aWNlLmFkZFR5cGUoXCJub3RpZnlcIilcbiAgZmlsZS5zZXJ2aWNlLmFkZE5vdGlmeUFjY2VzcyhcImFsbFwiKVxuXG4gICMgTGFyZ2Ugc3RhcnQgdGltZW91dCBpcyB0byBhbGxvdyBmb3IgcHVsbGluZyBkb3duIERvY2tlciBpbWFnZXMgZnJvbSBxdWF5LmlvXG4gIGZpbGUuc2VydmljZS5hZGRUaW1lb3V0U3RhcnRTZWMoXCIxMm1pblwiKVxuICBmaWxlLnNlcnZpY2UuYWRkVGltZW91dFN0b3BTZWMoXCIxNVwiKVxuXG4gIGZpbGUuc2VydmljZS5hZGRSZXN0YXJ0KFwib24tZmFpbHVyZVwiKVxuICBmaWxlLnNlcnZpY2UuYWRkUmVzdGFydFNlYyhcIjEwc1wiKVxuXG4gIGZpbGUuc2VydmljZS5hZGRFbnZpcm9ubWVudEZpbGUoXCIvcnVuL2RvY2tlci5lbnZcIilcblxuICBmaWxlLnNlcnZpY2UuYWRkRXhlY1N0YXJ0UHJlKFxuICAgIFwiL3Vzci9iaW4vZG9ja2VyIHJ1biAtLXJtIC12IFwiICtcbiAgICBcIi9vcHQvYmluOi9vcHQvYmluIGlidWlsZHRoZWNsb3VkL3N5c3RlbWQtZG9ja2VyXCJcbiAgKVxuICBmaWxlLnNlcnZpY2UuYWRkRXhlY1N0YXJ0UHJlKFxuICAgIFwiL3Vzci9iaW4vZG9ja2VyIHB1bGwgI3t1bml0LmRvY2tlckNvbnRhaW5lcn1cIlxuICApXG5cbiAgZmlsZS5zZXJ2aWNlLmFkZEV4ZWNTdGFydFByZShcIi0vdXNyL2Jpbi9kb2NrZXIga2lsbCAlcFwiKVxuICBmaWxlLnNlcnZpY2UuYWRkRXhlY1N0YXJ0UHJlKFwiLS91c3IvYmluL2RvY2tlciBybSAlcFwiKVxuXG4gIGZpbGUuc2VydmljZS5hZGRFeGVjU3RhcnQoXG4gICAgXCIvb3B0L2Jpbi9zeXN0ZW1kLWRvY2tlciBydW4gLS1uYW1lICVwICN7dW5pdC5kb2NrZXJDb250YWluZXJ9XCJcbiAgKVxuXG4gIGZpbGUuc2VydmljZS5hZGRFeGVjU3RvcChcIi91c3IvYmluL2RvY2tlciBraWxsICVwXCIpXG5cbiAgZmlsZS51bml0LmFkZERlc2NyaXB0aW9uKFwiVW5pdCBmb3IgI3t1bml0LmRvY2tlckNvbnRhaW5lcn1cIilcbiAgZmlsZS51bml0LmFkZERvY3VtZW50YXRpb24odW5pdC5kb2NrZXJDb250YWluZXIpXG5cbiAgIyBSZXF1aXJlcyBkb2NrZXJcbiAgZmlsZS51bml0LmFkZEFmdGVyKFwiZG9ja2VyLnNlcnZpY2VcIilcbiAgZmlsZS51bml0LmFkZFJlcXVpcmVzKFwiZG9ja2VyLnNlcnZpY2VcIilcblxuICAjIFJlcXVpcmVzIHJhYmJpdG1xXG4gIGZpbGUudW5pdC5hZGRBZnRlcihcInJhYmJpdG1xLnNlcnZpY2VcIilcbiAgZmlsZS51bml0LmFkZFJlcXVpcmVzKFwicmFiYml0bXEuc2VydmljZVwiKVxuXG4gICMgUmVxdWlyZXMgYXBpXG4gIGZpbGUudW5pdC5hZGRBZnRlcihcImFwaS5zZXJ2aWNlXCIpXG4gIGZpbGUudW5pdC5hZGRSZXF1aXJlcyhcImFwaS5zZXJ2aWNlXCIpXG5cbiAgIyBBZGQgYW55IG1vcmUgcmVxdWlyZWQgdW5pdHNcblxuICByZXR1cm4gZmlsZVxuXG5nZW5lcmF0ZUNvbm5lY3Rpb25LZXlzID0gKHBvcnRzLCBqb3Vrb3VHcmFwaEV4Y2hhbmdlS2V5KSAtPlxuICBmb3IgcG9ydE9iamVjdCBpbiBwb3J0c1xuICAgIHBvcnQgPSBwb3J0T2JqZWN0LnBvcnRcbiAgICBpZiBwb3J0IGFuZCBub3QgcG9ydC5leGNoYW5nZUtleVxuICAgICAgcG9ydC5leGNoYW5nZUtleSA9IGpvdWtvdUdyYXBoRXhjaGFuZ2VLZXlcbiAgICAgICMgVE9ETyBSb3V0aW5nIGtleVxuICAgICAgcG9ydC5yb3V0aW5nS2V5ID1cbiAgICAgICAgXCIje3BvcnRPYmplY3Quc291cmNlIG9yIHBvcnRPYmplY3QucHJvY2Vzc31fI3twb3J0T2JqZWN0Lm5hbWV9XCJcblxuY2hlY2tGb3JCcm9rZW5Db25uZWN0aW9ucyA9IChjb25uZWN0aW9ucykgLT5cbiAgaSA9IDBcbiAgd2hpbGUgaSA8IGNvbm5lY3Rpb25zLmxlbmd0aFxuICAgIGNvbm5lY3Rpb24gPSBjb25uZWN0aW9uc1tpXVxuICAgIGkrK1xuICAgIGlmIG5vdCBfLmlzUGxhaW5PYmplY3QoY29ubmVjdGlvbilcbiAgICAgIGNvbnRpbnVlXG4gICAgdGFyZ2V0ID0gY29ubmVjdGlvbltcInRndFwiXVxuICAgIHNvdXJjZSA9IGNvbm5lY3Rpb25bXCJzcmNcIl1cbiAgICBpZiBub3QgdGFyZ2V0IGFuZCBub3Qgc291cmNlXG4gICAgICBjb250aW51ZVxuICAgICNDb21tZW50IG91dCBmb3Igbm93IHNvIHdlIGNhbiBkbyBkZW1vcyB3aXRoIHBob3RvYm9vdGguanNvblxuICAgICNpZiBub3QgXy5pc1BsYWluT2JqZWN0KHRhcmdldClcbiAgICAjICB0aHJvdyBuZXcgRXJyb3IoXCJObyB0YXJnZXQgZm9yIGNvbm5lY3Rpb24gI3tpfVwiKVxuICAgICNpZiBub3QgXy5pc1BsYWluT2JqZWN0KHNvdXJjZSlcbiAgICAjICB0aHJvdyBuZXcgRXJyb3IoXCJObyBzb3VyY2UgZm9yIGNvbm5lY3Rpb24gI3tpfVwiKVxuXG5maW5kUG9ydHMgPSAoY29ubmVjdGlvbnMsIHByb2Nlc3NLZXkpIC0+XG4gIHJlc3VsdCA9IFtdXG4gIGZvciBjb25uZWN0aW9uIGluIGNvbm5lY3Rpb25zXG4gICAgc291cmNlID0gbnVsbFxuICAgIGlmIGNvbm5lY3Rpb24uc3JjXG4gICAgICBzb3VyY2UgPSBjb25uZWN0aW9uLnNyYy5wcm9jZXNzXG4gICAgICBpZiBjb25uZWN0aW9uLnNyYy5wcm9jZXNzIGlzIHByb2Nlc3NLZXlcbiAgICAgICAgaWYgdHlwZW9mIGNvbm5lY3Rpb24uc3JjLnBvcnQgaXNudCBcInN0cmluZ1wiXG4gICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlBvcnQgbmFtZSBpcyBleHBlY3RlZCB0byBiZSBhIHN0cmluZ1wiKVxuICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAgdHlwZTogXCJPVVRQT1JUXCJcbiAgICAgICAgICBuYW1lOiBjb25uZWN0aW9uLnNyYy5wb3J0LnRvVXBwZXJDYXNlKClcbiAgICAgICAgICBwb3J0OiBjb25uZWN0aW9uLnNyY1xuICAgICAgICAgIGNvbm5lY3Rpb246IGNvbm5lY3Rpb25cbiAgICAgICAgICBzb3VyY2U6IHNvdXJjZVxuICAgICAgICAgIHByb2Nlc3M6IHByb2Nlc3NLZXlcbiAgICAgICAgfSlcbiAgICBpZiBjb25uZWN0aW9uLnRndFxuICAgICAgaWYgY29ubmVjdGlvbi50Z3QucHJvY2VzcyBpcyBwcm9jZXNzS2V5XG4gICAgICAgIGlmIHR5cGVvZiBjb25uZWN0aW9uLnRndC5wb3J0IGlzbnQgXCJzdHJpbmdcIlxuICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJQb3J0IG5hbWUgaXMgZXhwZWN0ZWQgdG8gYmUgYSBzdHJpbmdcIilcbiAgICAgICAgcmVzdWx0LnB1c2goe1xuICAgICAgICAgIHR5cGU6IFwiSU5QT1JUXCJcbiAgICAgICAgICBuYW1lOiBjb25uZWN0aW9uLnRndC5wb3J0LnRvVXBwZXJDYXNlKClcbiAgICAgICAgICBwb3J0OiBjb25uZWN0aW9uLnRndFxuICAgICAgICAgIGNvbm5lY3Rpb246IGNvbm5lY3Rpb25cbiAgICAgICAgICBzb3VyY2U6IHNvdXJjZVxuICAgICAgICAgIHByb2Nlc3M6IHByb2Nlc3NLZXlcbiAgICAgICAgfSlcblxuICByZXN1bHRcblxubW9kdWxlLmV4cG9ydHMgPVxuICBjcmVhdGVGcm9tU2NoZW1hOiBjcmVhdGVGcm9tU2NoZW1hIl19