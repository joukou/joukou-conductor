var ConductorRabbitMQClient, JoukouConductorExchange, JoukouConductorRoutingKey, JoukouFleetAPIHost, JoukouFleetAPIPath, RabbitMQClient, fleet, httpClient, noflo, request,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

JoukouConductorExchange = process.env["JOUKOU_CONDUCTOR_EXCHANGE"];

JoukouConductorRoutingKey = process.env["JOUKOU_CONDUCTOR_ROUTING_KEY"];

JoukouFleetAPIHost = process.env["JOUKOU_FLEET_API_HOST"];

JoukouFleetAPIPath = process.env["JOUKOU_FLEET_API_PATH"];

RabbitMQClient = require('./client').RabbitMQClient;

request = require('request');

fleet = require('../fleet');

noflo = require('../noflo/systemd');

httpClient = require('./http-client');

if (!JoukouConductorExchange) {
  JoukouConductorExchange = "amqp://localhost";
  process.env["JOUKOU_CONDUCTOR_EXCHANGE"] = JoukouConductorExchange;
}

if (!JoukouConductorRoutingKey) {
  JoukouConductorRoutingKey = "CONDUCTOR";
  process.env["JOUKOU_CONDUCTOR_ROUTING_KEY"] = JoukouConductorRoutingKey;
}

if (!JoukouFleetAPIHost) {
  JoukouFleetAPIHost = "localhost:4002";
  process.env["JOUKOU_FLEET_API_HOST"] = JoukouFleetAPIHost;
}

if (!JoukouFleetAPIPath) {
  JoukouFleetAPIPath = "/v1-alpha/";
  process.env["JOUKOU_FLEET_API_PATH"] = JoukouFleetAPIPath;
}

ConductorRabbitMQClient = (function(_super) {
  __extends(ConductorRabbitMQClient, _super);

  ConductorRabbitMQClient.prototype.fleetClient = null;

  function ConductorRabbitMQClient() {
    var client;
    ConductorRabbitMQClient.__super__.constructor.call(this, JoukouConductorExchange, JoukouConductorRoutingKey);
    client = this;
    this.consume(function() {
      return client.onMessage.apply(client, arguments);
    }, true);
    this.fleetClient = fleet.getClient(JoukouFleetAPIHost, JoukouFleetAPIPath, true);
  }

  ConductorRabbitMQClient.prototype.onMessage = function(message) {
    if (!(message instanceof Object)) {
      return;
    }
    if (!(message["_links"] instanceof Object)) {
      return;
    }
    if (!(message["_links"]["joukou:graph"] instanceof Object)) {
      return;
    }
    if (!message["_links"]["joukou:graph"]["href"]) {
      return;
    }
    if (!message.desiredState) {
      return;
    }
    return this.onGraphHref(message["_links"]["joukou:graph"]["href"], message.desiredState, message.secret, message.exchange);
  };

  ConductorRabbitMQClient.prototype.onGraphHref = function(graphHref, desiredState, secret, exchange) {
    var client, createExchangePromise, graph, graphDeferred, options;
    options = null;
    if (secret) {
      options = {
        auth: {
          bearer: secret
        }
      };
    }
    client = this;
    graphDeferred = Q.defer();
    graph = null;
    request.get(graphHref, options, function(error, response, body, desiredState) {
      return graph = client.onGraphResponse.apply(client, [error, response, body, desiredState, graphDeferred]);
    });
    createExchangePromise = httpClient.createExchange(exchange, null, 'direct', true, true);
    return Q.all([graphDeferred.promise, createExchangePromise]).then(function() {
      return createUnit(graph, exchange);
    });
  };

  ConductorRabbitMQClient.prototype.createUnit = function(body, exchange) {

    /*
      unitName: "name"
      options: [SystemDUnitFile].options
      machineID: machineID
     */
    var client;
    noflo.createFromSchema(body, null, "TODO", "TODO", exchange);
    client = this.fleetClient;
    return client.createUnit(options.unitName, options.options, null, options.machineID);
  };

  ConductorRabbitMQClient.prototype.onGraphResponse = function(error, response, body, graphDeferred) {
    var jsonBody;
    if (error || response.statusCode !== 200) {
      graphDeferred.reject();
      return;
    }
    jsonBody = null;
    try {
      jsonBody = JSON.parse(body);
    } catch (_error) {}
    if (!jsonBody) {
      graphDeferred.reject();
      return;
    }
    try {
      graphDeferred.resolve();
      return jsonBody;
    } catch (_error) {
      return graphDeferred.reject();
    }
  };

  return ConductorRabbitMQClient;

})(RabbitMQClient);

module.exports = {
  listen: function() {
    return new ConductorRabbitMQClient();
  },
  ConductorRabbitMQClient: ConductorRabbitMQClient
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJhYmJpdG1xL2NvbmR1Y3Rvci1jbGllbnQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUEsc0tBQUE7RUFBQTtpU0FBQTs7QUFBQSx1QkFBQSxHQUE0QixPQUFPLENBQUMsR0FBSSxDQUFBLDJCQUFBLENBQXhDLENBQUE7O0FBQUEseUJBQ0EsR0FBNEIsT0FBTyxDQUFDLEdBQUksQ0FBQSw4QkFBQSxDQUR4QyxDQUFBOztBQUFBLGtCQUdBLEdBQTRCLE9BQU8sQ0FBQyxHQUFJLENBQUEsdUJBQUEsQ0FIeEMsQ0FBQTs7QUFBQSxrQkFJQSxHQUE0QixPQUFPLENBQUMsR0FBSSxDQUFBLHVCQUFBLENBSnhDLENBQUE7O0FBQUEsY0FNQSxHQUE0QixPQUFBLENBQVEsVUFBUixDQUFtQixDQUFDLGNBTmhELENBQUE7O0FBQUEsT0FPQSxHQUE0QixPQUFBLENBQVEsU0FBUixDQVA1QixDQUFBOztBQUFBLEtBUUEsR0FBNEIsT0FBQSxDQUFRLFVBQVIsQ0FSNUIsQ0FBQTs7QUFBQSxLQVNBLEdBQTRCLE9BQUEsQ0FBUSxrQkFBUixDQVQ1QixDQUFBOztBQUFBLFVBVUEsR0FBNEIsT0FBQSxDQUFRLGVBQVIsQ0FWNUIsQ0FBQTs7QUFjQSxJQUFHLENBQUEsdUJBQUg7QUFDRSxFQUFBLHVCQUFBLEdBQTBCLGtCQUExQixDQUFBO0FBQUEsRUFDQSxPQUFPLENBQUMsR0FBSSxDQUFBLDJCQUFBLENBQVosR0FBMkMsdUJBRDNDLENBREY7Q0FkQTs7QUFrQkEsSUFBRyxDQUFBLHlCQUFIO0FBQ0UsRUFBQSx5QkFBQSxHQUE0QixXQUE1QixDQUFBO0FBQUEsRUFDQSxPQUFPLENBQUMsR0FBSSxDQUFBLDhCQUFBLENBQVosR0FBOEMseUJBRDlDLENBREY7Q0FsQkE7O0FBc0JBLElBQUcsQ0FBQSxrQkFBSDtBQUNFLEVBQUEsa0JBQUEsR0FBcUIsZ0JBQXJCLENBQUE7QUFBQSxFQUNBLE9BQU8sQ0FBQyxHQUFJLENBQUEsdUJBQUEsQ0FBWixHQUF1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U0E7QUFDRSxNQUFBLGFBQWEsQ0FBQyxPQUFkLENBQUEsQ0FBQSxDQUFBO0FBQ0EsYUFBTyxRQUFQLENBRkY7S0FBQSxjQUFBO2FBSUUsYUFBYSxDQUFDLE1BQWQsQ0FBQSxFQUpGO0tBVmU7RUFBQSxDQXRHakIsQ0FBQTs7aUNBQUE7O0dBRG9DLGVBOUJ0QyxDQUFBOztBQUFBLE1Bb0pNLENBQUMsT0FBUCxHQUNFO0FBQUEsRUFBQSxNQUFBLEVBQVEsU0FBQSxHQUFBO1dBQ0YsSUFBQSx1QkFBQSxDQUFBLEVBREU7RUFBQSxDQUFSO0FBQUEsRUFFQSx1QkFBQSxFQUF5Qix1QkFGekI7Q0FySkYsQ0FBQSIsImZpbGUiOiJyYWJiaXRtcS9jb25kdWN0b3ItY2xpZW50LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiSm91a291Q29uZHVjdG9yRXhjaGFuZ2UgICA9IHByb2Nlc3MuZW52W1wiSk9VS09VX0NPTkRVQ1RPUl9FWENIQU5HRVwiXVxuSm91a291Q29uZHVjdG9yUm91dGluZ0tleSA9IHByb2Nlc3MuZW52W1wiSk9VS09VX0NPTkRVQ1RPUl9ST1VUSU5HX0tFWVwiXVxuXG5Kb3Vrb3VGbGVldEFQSUhvc3QgICAgICAgID0gcHJvY2Vzcy5lbnZbXCJKT1VLT1VfRkxFRVRfQVBJX0hPU1RcIl1cbkpvdWtvdUZsZWV0QVBJUGF0aCAgICAgICAgPSBwcm9jZXNzLmVudltcIkpPVUtPVV9GTEVFVF9BUElfUEFUSFwiXVxuXG5SYWJiaXRNUUNsaWVudCAgICAgICAgICAgID0gcmVxdWlyZSgnLi9jbGllbnQnKS5SYWJiaXRNUUNsaWVudFxucmVxdWVzdCAgICAgICAgICAgICAgICAgICA9IHJlcXVpcmUoJ3JlcXVlc3QnKVxuZmxlZXQgICAgICAgICAgICAgICAgICAgICA9IHJlcXVpcmUoJy4uL2ZsZWV0Jylcbm5vZmxvICAgICAgICAgICAgICAgICAgICAgPSByZXF1aXJlKCcuLi9ub2Zsby9zeXN0ZW1kJylcbmh0dHBDbGllbnQgICAgICAgICAgICAgICAgPSByZXF1aXJlKCcuL2h0dHAtY2xpZW50JylcblxuIyBTZXQgdGhlIEVOViB2YXJpYWJsZSBmb3IgbmV4dCB0aW1lXG4jIFRoaXMgZG9lcyBub3QgZWZmZWN0IGdsb2JhbCBlbnYganVzdCB0aGlzIHByb2Nlc3NcbmlmIG5vdCBKb3Vrb3VDb25kdWN0b3JFeGNoYW5nZVxuICBKb3Vrb3VDb25kdWN0b3JFeGNoYW5nZSA9IFwiYW1xcDovL2xvY2FsaG9zdFwiXG4gIHByb2Nlc3MuZW52W1wiSk9VS09VX0NPTkRVQ1RPUl9FWENIQU5HRVwiXSA9IEpvdWtvdUNvbmR1Y3RvckV4Y2hhbmdlXG5cbmlmIG5vdCBKb3Vrb3VDb25kdWN0b3JSb3V0aW5nS2V5XG4gIEpvdWtvdUNvbmR1Y3RvclJvdXRpbmdLZXkgPSBcIkNPTkRVQ1RPUlwiXG4gIHByb2Nlc3MuZW52W1wiSk9VS09VX0NPTkRVQ1RPUl9ST1VUSU5HX0tFWVwiXSA9IEpvdWtvdUNvbmR1Y3RvclJvdXRpbmdLZXlcblxuaWYgbm90IEpvdWtvdUZsZWV0QVBJSG9zdFxuICBKb3Vrb3VGbGVldEFQSUhvc3QgPSBcImxvY2FsaG9zdDo0MDAyXCJcbiAgcHJvY2Vzcy5lbnZbXCJKT1VLT1VfRkxFRVRfQVBJX0hPU1RcIl0gPSBKb3Vrb3VGbGVldEFQSUhvc3RcblxuaWYgbm90IEpvdWtvdUZsZWV0QVBJUGF0aFxuICBKb3Vrb3VGbGVldEFQSVBhdGggPSBcIi92MS1hbHBoYS9cIlxuICBwcm9jZXNzLmVudltcIkpPVUtPVV9GTEVFVF9BUElfUEFUSFwiXSA9IEpvdWtvdUZsZWV0QVBJUGF0aFxuXG5jbGFzcyBDb25kdWN0b3JSYWJiaXRNUUNsaWVudCBleHRlbmRzIFJhYmJpdE1RQ2xpZW50XG4gIGZsZWV0Q2xpZW50OiBudWxsXG4gIGNvbnN0cnVjdG9yOiAtPlxuICAgIHN1cGVyKEpvdWtvdUNvbmR1Y3RvckV4Y2hhbmdlLCBKb3Vrb3VDb25kdWN0b3JSb3V0aW5nS2V5KVxuICAgIGNsaWVudCA9IHRoaXNcbiAgICB0aGlzLmNvbnN1bWUoIC0+XG4gICAgICBjbGllbnQub25NZXNzYWdlLmFwcGx5KGNsaWVudCwgYXJndW1lbnRzKVxuICAgICwgeWVzKVxuICAgIHRoaXMuZmxlZXRDbGllbnQgPSBmbGVldC5nZXRDbGllbnQoXG4gICAgICBKb3Vrb3VGbGVldEFQSUhvc3QsXG4gICAgICBKb3Vrb3VGbGVldEFQSVBhdGgsXG4gICAgICB5ZXNcbiAgICApXG4gIG9uTWVzc2FnZTogKG1lc3NhZ2UpIC0+XG4gICAgIyBIZXJlIHdlIG11c3QgcHJvY2VzcyB3aGF0IHRoZSBwZWVwc1xuICAgICMgd2FudCB0aGVpciBncmFwaHMgdG8gZG9cbiAgICAjIEhlcmUgaXMgYW4gZXhhbXBsZSBvZiBtZXNzYWdlcyBmcm9tIElzYWFjOlxuICAgICMge1xuICAgICMgIFwiX2xpbmtzXCI6IHtcbiAgICAjICAgIFwiam91a291OmdyYXBoXCI6IHtcbiAgICAjICAgICAgXCJocmVmXCI6XG4gICAgIyAgICAgICAgIFwiaHR0cDovL2FwaS5qb3Vrb3UubG9jYWw6MjEwMS9wZXJzb25hL3BlcnNvbmFVdWlkL2dyYXBoL2dyYXBoVXVpZFwiXG4gICAgIyAgICB9XG4gICAgIyAgfSxcbiAgICAjICBcImRlc2lyZWRTdGF0ZVwiOiBcImxhdW5jaGVkXCIsIC8vIG9yIFwiaW5hY3RpdmVcIlxuICAgICMgIFwic2VjcmV0XCI6IFwianNvbi13ZWItdG9rZW5cIixcbiAgICAjICAvLyBBZGRpdGlvbmFsIC0gRmFiaWFuXG4gICAgIyAgXCJleGNoYW5nZVwiOiBcImV4Y2hhbmdlXCJcbiAgICAjfVxuICAgICMgTm8gb25lIGlzIGxpc3RlbmluZyBmb3IgZXJyb3JzIHNvIGp1c3QgcmV0dXJuXG4gICAgIyBpZiB0aGVyZSBpcyBzb21ldGhpbmcgbWlzc2luZ1xuICAgIGlmIG1lc3NhZ2Ugbm90IGluc3RhbmNlb2YgT2JqZWN0XG4gICAgICByZXR1cm5cbiAgICBpZiBtZXNzYWdlW1wiX2xpbmtzXCJdIG5vdCBpbnN0YW5jZW9mIE9iamVjdFxuICAgICAgcmV0dXJuXG4gICAgaWYgbWVzc2FnZVtcIl9saW5rc1wiXVtcImpvdWtvdTpncmFwaFwiXSBub3QgaW5zdGFuY2VvZiBPYmplY3RcbiAgICAgIHJldHVyblxuICAgIGlmIG5vdCBtZXNzYWdlW1wiX2xpbmtzXCJdW1wiam91a291OmdyYXBoXCJdW1wiaHJlZlwiXVxuICAgICAgcmV0dXJuXG4gICAgaWYgbm90IG1lc3NhZ2UuZGVzaXJlZFN0YXRlXG4gICAgICByZXR1cm5cbiAgICAjTWF5IGJlIGEgcHVibGljIGdyYXBoLCB3ZSB3aWxsIHRyeSB3aXRob3V0IHRoaXNcbiAgICAjaWYgbm90IG1lc3NhZ2Uuc2VjcmV0XG4gICAgIyAgcmV0dXJuXG4gICAgdGhpcy5vbkdyYXBoSHJlZihcbiAgICAgIG1lc3NhZ2VbXCJfbGlua3NcIl1bXCJqb3Vrb3U6Z3JhcGhcIl1bXCJocmVmXCJdLFxuICAgICAgbWVzc2FnZS5kZXNpcmVkU3RhdGUsXG4gICAgICBtZXNzYWdlLnNlY3JldCxcbiAgICAgIG1lc3NhZ2UuZXhjaGFuZ2VcbiAgICApXG4gIG9uR3JhcGhIcmVmOiAoZ3JhcGhIcmVmLCBkZXNpcmVkU3RhdGUsIHNlY3JldCwgZXhjaGFuZ2UpIC0+XG4gICAgb3B0aW9ucyA9IG51bGxcbiAgICBpZiBzZWNyZXRcbiAgICAgIG9wdGlvbnMgPVxuICAgICAgICBhdXRoOlxuICAgICAgICAgICMgaHR0cHM6Ly9naXRodWIuY29tL3JlcXVlc3QvcmVxdWVzdCNodHRwLWF1dGhlbnRpY2F0aW9uXG4gICAgICAgICAgYmVhcmVyOiBzZWNyZXRcbiAgICBjbGllbnQgPSB0aGlzXG4gICAgZ3JhcGhEZWZlcnJlZCA9IFEuZGVmZXIoKVxuICAgIGdyYXBoID0gbnVsbFxuICAgIHJlcXVlc3QuZ2V0KGdyYXBoSHJlZiwgb3B0aW9ucywgKGVycm9yLCByZXNwb25zZSwgYm9keSwgZGVzaXJlZFN0YXRlKSAtPlxuICAgICAgZ3JhcGggPSBjbGllbnQub25HcmFwaFJlc3BvbnNlLmFwcGx5KGNsaWVudCwgW1xuICAgICAgICBlcnJvcixcbiAgICAgICAgcmVzcG9uc2UsXG4gICAgICAgIGJvZHksXG4gICAgICAgIGRlc2lyZWRTdGF0ZSxcbiAgICAgICAgZ3JhcGhEZWZlcnJlZFxuICAgICAgXSlcbiAgICApXG4gICAgIyBBdCB0aGUgc2FtZSB0aW1lIHdlIHNob3VsZCBiZSBjcmVhdGluZyB0aGUgZXhjaGFuZ2VcbiAgICBjcmVhdGVFeGNoYW5nZVByb21pc2UgPSBodHRwQ2xpZW50LmNyZWF0ZUV4Y2hhbmdlKFxuICAgICAgZXhjaGFuZ2UsXG4gICAgICBudWxsLCAjIERlZmF1bHRcbiAgICAgICdkaXJlY3QnLFxuICAgICAgeWVzLFxuICAgICAgeWVzXG4gICAgKVxuICAgIFEuYWxsKFtcbiAgICAgIGdyYXBoRGVmZXJyZWQucHJvbWlzZSxcbiAgICAgIGNyZWF0ZUV4Y2hhbmdlUHJvbWlzZVxuICAgIF0pLnRoZW4oLT5cbiAgICAgIGNyZWF0ZVVuaXQoZ3JhcGgsIGV4Y2hhbmdlKVxuICAgIClcbiAgY3JlYXRlVW5pdDogKGJvZHksIGV4Y2hhbmdlKSAtPlxuICAgICMjI1xuICAgICAgdW5pdE5hbWU6IFwibmFtZVwiXG4gICAgICBvcHRpb25zOiBbU3lzdGVtRFVuaXRGaWxlXS5vcHRpb25zXG4gICAgICBtYWNoaW5lSUQ6IG1hY2hpbmVJRFxuICAgICMjI1xuICAgIG5vZmxvLmNyZWF0ZUZyb21TY2hlbWEoXG4gICAgICBib2R5LFxuICAgICAgbnVsbCwgIyBUT0RPIG1hY2hpbmVJRFxuICAgICAgXCJUT0RPXCIsICMgVE9ETyBqb3Vrb3VNZXNzYWdlUXVlQWRkcmVzcyBFTlZcbiAgICAgIFwiVE9ET1wiLCAjIFRPRE8gam91a291QXBpQWRkcmVzcyBFTlZcbiAgICAgIGV4Y2hhbmdlXG4gICAgKVxuICAgIGNsaWVudCA9IHRoaXMuZmxlZXRDbGllbnRcbiAgICBjbGllbnQuY3JlYXRlVW5pdChcbiAgICAgIG9wdGlvbnMudW5pdE5hbWUsXG4gICAgICBvcHRpb25zLm9wdGlvbnMsXG4gICAgICBudWxsLFxuICAgICAgb3B0aW9ucy5tYWNoaW5lSURcbiAgICApXG4gIG9uR3JhcGhSZXNwb25zZTogKGVycm9yLCByZXNwb25zZSwgYm9keSwgZ3JhcGhEZWZlcnJlZCkgLT5cbiAgICBpZiBlcnJvciBvciByZXNwb25zZS5zdGF0dXNDb2RlIGlzbnQgMjAwXG4gICAgICBncmFwaERlZmVycmVkLnJlamVjdCgpXG4gICAgICByZXR1cm5cbiAgICBqc29uQm9keSA9IG51bGxcbiAgICB0cnlcbiAgICAgIGpzb25Cb2R5ID0gSlNPTi5wYXJzZShib2R5KVxuICAgIGlmIG5vdCBqc29uQm9keVxuICAgICAgZ3JhcGhEZWZlcnJlZC5yZWplY3QoKVxuICAgICAgcmV0dXJuXG4gICAgdHJ5XG4gICAgICBncmFwaERlZmVycmVkLnJlc29sdmUoKVxuICAgICAgcmV0dXJuIGpzb25Cb2R5XG4gICAgY2F0Y2hcbiAgICAgIGdyYXBoRGVmZXJyZWQucmVqZWN0KClcbm1vZHVsZS5leHBvcnRzID1cbiAgbGlzdGVuOiAtPlxuICAgIG5ldyBDb25kdWN0b3JSYWJiaXRNUUNsaWVudCgpXG4gIENvbmR1Y3RvclJhYmJpdE1RQ2xpZW50OiBDb25kdWN0b3JSYWJiaXRNUUNsaWVudFxuIl19